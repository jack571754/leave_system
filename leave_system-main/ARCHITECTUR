# Django + SpiffWorkflow é¡¹ç›®é›†æˆæ¶æ„æ–‡æ¡£

## ğŸ“‹ ç›®å½•

- [ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ](#ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ)
- [æ ¸å¿ƒç»„ä»¶](#æ ¸å¿ƒç»„ä»¶)
- [æŠ€æœ¯æ ˆ](#æŠ€æœ¯æ ˆ)
- [æ•°æ®æµ](#æ•°æ®æµ)
- [é›†æˆæ–¹æ¡ˆ](#é›†æˆæ–¹æ¡ˆ)
- [å…³é”®è®¾è®¡å†³ç­–](#å…³é”®è®¾è®¡å†³ç­–)
- [éƒ¨ç½²æ¶æ„](#éƒ¨ç½²æ¶æ„)

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ

æœ¬ç³»ç»Ÿé‡‡ç”¨åˆ†å±‚æ¶æ„è®¾è®¡ï¼Œå°†ä¸šåŠ¡é€»è¾‘ã€å·¥ä½œæµå¼•æ“å’Œæ•°æ®æŒä¹…åŒ–æ¸…æ™°åˆ†ç¦»ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å‰ç«¯å±‚ (Frontend)                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ Dashboard    â”‚  â”‚ BPMN Designerâ”‚  â”‚ Test Page    â”‚      â”‚
â”‚  â”‚ æ§åˆ¶å°é¦–é¡µ    â”‚  â”‚ æµç¨‹è®¾è®¡å™¨    â”‚  â”‚ æµ‹è¯•å·¥å…·      â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“ HTTP/REST API
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    API å±‚ (Django REST Framework)            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ Leave API    â”‚  â”‚ Approval API â”‚  â”‚ BPMN API     â”‚      â”‚
â”‚  â”‚ è¯·å‡ç”³è¯·æ¥å£  â”‚  â”‚ å®¡æ‰¹ä»»åŠ¡æ¥å£  â”‚  â”‚ æµç¨‹ç®¡ç†æ¥å£  â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ä¸šåŠ¡é€»è¾‘å±‚ (Business Logic)               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ Views        â”‚  â”‚ Serializers  â”‚  â”‚ Services     â”‚      â”‚
â”‚  â”‚ è§†å›¾å¤„ç†      â”‚  â”‚ æ•°æ®åºåˆ—åŒ–    â”‚  â”‚ ä¸šåŠ¡æœåŠ¡      â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 å·¥ä½œæµå¼•æ“å±‚ (SpiffWorkflow)                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚            SpiffWorkflow Client                  â”‚       â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚       â”‚
â”‚  â”‚  â”‚ BPMNè§£æ â”‚  â”‚ æµç¨‹æ‰§è¡Œ  â”‚  â”‚ ä»»åŠ¡ç®¡ç†  â”‚      â”‚       â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ•°æ®æŒä¹…åŒ–å±‚ (Data Layer)                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ Django ORM   â”‚  â”‚ Models       â”‚  â”‚ Database     â”‚      â”‚
â”‚  â”‚ å¯¹è±¡å…³ç³»æ˜ å°„  â”‚  â”‚ æ•°æ®æ¨¡å‹      â”‚  â”‚ SQLite/PG    â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”§ æ ¸å¿ƒç»„ä»¶

### 1. Django åº”ç”¨æ¨¡å—

#### leave_api (æ ¸å¿ƒAPIæ¨¡å—)
- **åŠŸèƒ½**: å¤„ç†è¯·å‡ç”³è¯·ã€å®¡æ‰¹ä»»åŠ¡çš„æ ¸å¿ƒä¸šåŠ¡é€»è¾‘
- **å…³é”®æ–‡ä»¶**:
  - [`models.py`](leave_system/leave_api/models.py) - æ•°æ®æ¨¡å‹å®šä¹‰
  - [`serializers.py`](leave_system/leave_api/serializers.py) - APIåºåˆ—åŒ–å™¨
  - [`views_v2.py`](leave_system/leave_api/views_v2.py) - è¯·å‡ç”³è¯·è§†å›¾
  - [`views_approval_tasks.py`](leave_system/leave_api/views_approval_tasks.py) - å®¡æ‰¹ä»»åŠ¡è§†å›¾
  - [`views_bpmn.py`](leave_system/leave_api/views_bpmn.py) - BPMNæµç¨‹ç®¡ç†è§†å›¾
  - [`spiff_client_v2.py`](leave_system/leave_api/spiff_client_v2.py) - SpiffWorkflowå®¢æˆ·ç«¯å°è£…

#### organization (ç»„ç»‡æ¶æ„æ¨¡å—)
- **åŠŸèƒ½**: ç®¡ç†éƒ¨é—¨ã€å‘˜å·¥ã€è§’è‰²ç­‰ç»„ç»‡ç»“æ„
- **å…³é”®åŠŸèƒ½**:
  - éƒ¨é—¨å±‚çº§ç®¡ç†
  - å‘˜å·¥ä¿¡æ¯ç®¡ç†
  - å®¡æ‰¹äººé…ç½®

#### notifications (é€šçŸ¥ç³»ç»Ÿæ¨¡å—)
- **åŠŸèƒ½**: å¤„ç†ç³»ç»Ÿé€šçŸ¥å’Œæ¶ˆæ¯æ¨é€
- **æ”¯æŒç±»å‹**:
  - ç«™å†…é€šçŸ¥
  - é‚®ä»¶é€šçŸ¥
  - é€šçŸ¥æ¨¡æ¿ç®¡ç†

### 2. SpiffWorkflow é›†æˆ

#### SpiffWorkflow Client ([`spiff_client_v2.py`](leave_system/leave_api/spiff_client_v2.py))

è¿™æ˜¯è¿æ¥Djangoå’ŒSpiffWorkflowçš„æ ¸å¿ƒæ¡¥æ¢ï¼Œæä¾›ä»¥ä¸‹åŠŸèƒ½ï¼š

```python
class SpiffWorkflowClient:
    """SpiffWorkflow å·¥ä½œæµå¼•æ“å®¢æˆ·ç«¯"""
    
    def __init__(self, process_models_dir):
        """åˆå§‹åŒ–å·¥ä½œæµå¼•æ“"""
        self.process_models_dir = process_models_dir
        self.spec_cache = {}
    
    def load_bpmn_spec(self, process_id):
        """åŠ è½½BPMNæµç¨‹å®šä¹‰"""
        # ä»æ–‡ä»¶ç³»ç»ŸåŠ è½½BPMN XML
        # è§£æä¸ºSpiffWorkflowè§„èŒƒå¯¹è±¡
        
    def start_workflow(self, process_id, data):
        """å¯åŠ¨å·¥ä½œæµå®ä¾‹"""
        # åˆ›å»ºå·¥ä½œæµå®ä¾‹
        # åˆå§‹åŒ–æµç¨‹æ•°æ®
        # è¿”å›å·¥ä½œæµå®ä¾‹
        
    def get_ready_tasks(self, workflow):
        """è·å–å°±ç»ªçš„ä»»åŠ¡"""
        # æŸ¥è¯¢å½“å‰å¯æ‰§è¡Œçš„ä»»åŠ¡
        # è¿”å›ä»»åŠ¡åˆ—è¡¨
        
    def complete_task(self, workflow, task_id, data):
        """å®Œæˆä»»åŠ¡"""
        # æ›´æ–°ä»»åŠ¡æ•°æ®
        # æ¨è¿›å·¥ä½œæµæ‰§è¡Œ
        # è§¦å‘ä¸‹ä¸€æ­¥ä»»åŠ¡
```

#### å·¥ä½œæµçŠ¶æ€ç®¡ç†

å·¥ä½œæµçŠ¶æ€é€šè¿‡Djangoæ¨¡å‹æŒä¹…åŒ–ï¼š

```python
class LeaveRequest(models.Model):
    """è¯·å‡ç”³è¯·æ¨¡å‹"""
    workflow_data = models.JSONField()  # å­˜å‚¨å·¥ä½œæµçŠ¶æ€
    workflow_status = models.CharField()  # å·¥ä½œæµçŠ¶æ€
    current_task = models.CharField()  # å½“å‰ä»»åŠ¡
```

### 3. BPMN æµç¨‹è®¾è®¡

#### BPMN.js é›†æˆ ([`bpmn_designer.html`](leave_system/templates/bpmn_designer.html))

- **åŠŸèƒ½**: å¯è§†åŒ–BPMNæµç¨‹è®¾è®¡å™¨
- **ç‰¹æ€§**:
  - æ‹–æ‹½å¼æµç¨‹è®¾è®¡
  - å®æ—¶XMLé¢„è§ˆ
  - æµç¨‹éªŒè¯
  - å±æ€§é¢æ¿é…ç½®

#### æµç¨‹å®šä¹‰å­˜å‚¨

```
process_models/
â”œâ”€â”€ leave-approval/           # è¯·å‡å®¡æ‰¹æµç¨‹
â”‚   â”œâ”€â”€ process_group.json   # æµç¨‹ç»„é…ç½®
â”‚   â””â”€â”€ leave-approval/
â”‚       â”œâ”€â”€ leave-approval.bpmn  # BPMNæµç¨‹å®šä¹‰
â”‚       â””â”€â”€ process_model.json   # æµç¨‹å…ƒæ•°æ®
â””â”€â”€ password/                # å¯†ç ä¿®æ”¹æµç¨‹
    â””â”€â”€ password-change/
        â””â”€â”€ password-change.bpmn
```

## ğŸ’» æŠ€æœ¯æ ˆ

### åç«¯æŠ€æœ¯

| æŠ€æœ¯ | ç‰ˆæœ¬ | ç”¨é€” |
|------|------|------|
| Django | 5.1.6 | Webæ¡†æ¶ |
| Django REST Framework | 3.14+ | REST API |
| SpiffWorkflow | 3.0+ | å·¥ä½œæµå¼•æ“ |
| SQLite/PostgreSQL | - | æ•°æ®åº“ |
| Celery | 5.3+ | å¼‚æ­¥ä»»åŠ¡ |

### å‰ç«¯æŠ€æœ¯

| æŠ€æœ¯ | ç‰ˆæœ¬ | ç”¨é€” |
|------|------|------|
| BPMN.js | 17.11.1 | BPMNæµç¨‹è®¾è®¡ |
| HTML/CSS/JS | - | å‰ç«¯ç•Œé¢ |

### å·¥ä½œæµæŠ€æœ¯

| æŠ€æœ¯ | ç”¨é€” |
|------|------|
| BPMN 2.0 | æµç¨‹å»ºæ¨¡æ ‡å‡† |
| SpiffWorkflow | Pythonå·¥ä½œæµå¼•æ“ |
| lxml | XMLè§£æ |

## ğŸ”„ æ•°æ®æµ

### 1. åˆ›å»ºè¯·å‡ç”³è¯·æµç¨‹

```
ç”¨æˆ·æäº¤ç”³è¯·
    â†“
Django Viewæ¥æ”¶è¯·æ±‚
    â†“
æ•°æ®éªŒè¯ (Serializer)
    â†“
åˆ›å»ºLeaveRequestæ¨¡å‹
    â†“
SpiffWorkflow Clientå¯åŠ¨å·¥ä½œæµ
    â†“
åŠ è½½BPMNæµç¨‹å®šä¹‰
    â†“
åˆ›å»ºå·¥ä½œæµå®ä¾‹
    â†“
åˆå§‹åŒ–æµç¨‹æ•°æ®
    â†“
è·å–ç¬¬ä¸€ä¸ªä»»åŠ¡
    â†“
ä¿å­˜å·¥ä½œæµçŠ¶æ€åˆ°æ•°æ®åº“
    â†“
è¿”å›ç”³è¯·IDå’Œä»»åŠ¡ä¿¡æ¯
```

### 2. å®¡æ‰¹ä»»åŠ¡æµç¨‹

```
å®¡æ‰¹äººæŸ¥è¯¢å¾…åŠä»»åŠ¡
    â†“
Django ViewæŸ¥è¯¢æ•°æ®åº“
    â†“
SpiffWorkflow Clientè·å–å°±ç»ªä»»åŠ¡
    â†“
è¿”å›ä»»åŠ¡åˆ—è¡¨
    â†“
å®¡æ‰¹äººæäº¤å®¡æ‰¹æ„è§
    â†“
Django Viewæ¥æ”¶å®¡æ‰¹æ•°æ®
    â†“
SpiffWorkflow Clientå®Œæˆä»»åŠ¡
    â†“
æ›´æ–°ä»»åŠ¡æ•°æ®
    â†“
æ¨è¿›å·¥ä½œæµæ‰§è¡Œ
    â†“
è¯„ä¼°ç½‘å…³æ¡ä»¶
    â†“
è§¦å‘ä¸‹ä¸€æ­¥ä»»åŠ¡
    â†“
ä¿å­˜å·¥ä½œæµçŠ¶æ€
    â†“
å‘é€é€šçŸ¥
    â†“
è¿”å›å®¡æ‰¹ç»“æœ
```

### 3. BPMNæµç¨‹è®¾è®¡æµç¨‹

```
ç”¨æˆ·æ‰“å¼€è®¾è®¡å™¨
    â†“
åŠ è½½ç°æœ‰æµç¨‹å®šä¹‰
    â†“
BPMN.jsæ¸²æŸ“æµç¨‹å›¾
    â†“
ç”¨æˆ·ç¼–è¾‘æµç¨‹
    â†“
å®æ—¶ç”ŸæˆBPMN XML
    â†“
ç”¨æˆ·ä¿å­˜æµç¨‹
    â†“
Django APIæ¥æ”¶XML
    â†“
éªŒè¯BPMNæ ¼å¼
    â†“
ä¿å­˜åˆ°æ–‡ä»¶ç³»ç»Ÿ
    â†“
æ›´æ–°æµç¨‹å…ƒæ•°æ®
    â†“
è¿”å›ä¿å­˜ç»“æœ
```

## ğŸ”— é›†æˆæ–¹æ¡ˆ

### 1. Django ä¸ SpiffWorkflow é›†æˆ

#### æ–¹æ¡ˆé€‰æ‹©

æˆ‘ä»¬é‡‡ç”¨**å®¢æˆ·ç«¯å°è£…æ¨¡å¼**ï¼Œå°†SpiffWorkflowå°è£…ä¸ºDjangoæœåŠ¡ï¼š

**ä¼˜ç‚¹**:
- è§£è€¦ä¸šåŠ¡é€»è¾‘å’Œå·¥ä½œæµå¼•æ“
- ä¾¿äºå•å…ƒæµ‹è¯•
- æ˜“äºç»´æŠ¤å’Œæ‰©å±•
- æ”¯æŒå¤šç§å·¥ä½œæµå¼•æ“åˆ‡æ¢

**å®ç°æ–¹å¼**:

```python
# leave_api/spiff_client_v2.py
class SpiffWorkflowClient:
    """å·¥ä½œæµå¼•æ“å®¢æˆ·ç«¯å°è£…"""
    
    def __init__(self, process_models_dir):
        self.process_models_dir = process_models_dir
        self.spec_cache = {}
    
    def load_bpmn_spec(self, process_id):
        """åŠ è½½BPMNè§„èŒƒ"""
        if process_id in self.spec_cache:
            return self.spec_cache[process_id]
        
        bpmn_file = self._find_bpmn_file(process_id)
        spec = BpmnWorkflow.from_bpmn_file(bpmn_file)
        self.spec_cache[process_id] = spec
        return spec
    
    def start_workflow(self, process_id, data):
        """å¯åŠ¨å·¥ä½œæµ"""
        spec = self.load_bpmn_spec(process_id)
        workflow = BpmnWorkflow(spec)
        workflow.data = data
        return workflow
```

### 2. å·¥ä½œæµçŠ¶æ€æŒä¹…åŒ–

#### åºåˆ—åŒ–æ–¹æ¡ˆ

ä½¿ç”¨JSONæ ¼å¼å­˜å‚¨å·¥ä½œæµçŠ¶æ€ï¼š

```python
# åºåˆ—åŒ–å·¥ä½œæµ
workflow_data = workflow.serialize()
leave_request.workflow_data = json.dumps(workflow_data)
leave_request.save()

# ååºåˆ—åŒ–å·¥ä½œæµ
workflow_data = json.loads(leave_request.workflow_data)
workflow = BpmnWorkflow.deserialize(workflow_data)
```

#### æ•°æ®æ¨¡å‹è®¾è®¡

```python
class LeaveRequest(models.Model):
    """è¯·å‡ç”³è¯·"""
    # ä¸šåŠ¡å­—æ®µ
    applicant = models.ForeignKey(Employee)
    leave_type = models.CharField(max_length=50)
    start_date = models.DateField()
    end_date = models.DateField()
    reason = models.TextField()
    
    # å·¥ä½œæµå­—æ®µ
    workflow_data = models.JSONField(null=True)
    workflow_status = models.CharField(max_length=50)
    current_task = models.CharField(max_length=100)
    process_id = models.CharField(max_length=100)
    
    # å®¡æ‰¹å­—æ®µ
    status = models.CharField(max_length=50)
    approved_by = models.ForeignKey(Employee, null=True)
    approved_at = models.DateTimeField(null=True)
```

### 3. BPMN æµç¨‹ç®¡ç†

#### æ–‡ä»¶ç³»ç»Ÿç»“æ„

```
process_models/
â”œâ”€â”€ {group_name}/
â”‚   â”œâ”€â”€ process_group.json
â”‚   â””â”€â”€ {process_name}/
â”‚       â”œâ”€â”€ {process_name}.bpmn
â”‚       â”œâ”€â”€ process_model.json
â”‚       â””â”€â”€ {form_name}-schema.json
```

#### APIè®¾è®¡

```python
# GET /api/bpmn/processes/
def list_processes(request):
    """åˆ—å‡ºæ‰€æœ‰æµç¨‹"""
    
# POST /api/bpmn/processes/
def create_process(request):
    """åˆ›å»ºæ–°æµç¨‹"""
    
# GET /api/bpmn/processes/{id}/
def get_process(request, process_id):
    """è·å–æµç¨‹è¯¦æƒ…"""
    
# PUT /api/bpmn/processes/{id}/
def update_process(request, process_id):
    """æ›´æ–°æµç¨‹å®šä¹‰"""
    
# DELETE /api/bpmn/processes/{id}/
def delete_process(request, process_id):
    """åˆ é™¤æµç¨‹"""
```

## ğŸ¯ å…³é”®è®¾è®¡å†³ç­–

### 1. ä¸ºä»€ä¹ˆé€‰æ‹© SpiffWorkflowï¼Ÿ

**ä¼˜åŠ¿**:
- âœ… çº¯Pythonå®ç°ï¼Œä¸Djangoæ— ç¼é›†æˆ
- âœ… å®Œæ•´æ”¯æŒBPMN 2.0æ ‡å‡†
- âœ… è½»é‡çº§ï¼Œæ— éœ€é¢å¤–æœåŠ¡
- âœ… æ˜“äºè°ƒè¯•å’Œæµ‹è¯•
- âœ… æ”¯æŒå¤æ‚çš„æµç¨‹é€»è¾‘

**åŠ£åŠ¿**:
- âŒ ä¸æ”¯æŒåˆ†å¸ƒå¼éƒ¨ç½²
- âŒ æ€§èƒ½å—Pythoné™åˆ¶
- âŒ ç¼ºå°‘å¯è§†åŒ–ç›‘æ§å·¥å…·

### 2. å·¥ä½œæµçŠ¶æ€å­˜å‚¨æ–¹æ¡ˆ

**é€‰æ‹©**: JSONå­—æ®µå­˜å‚¨åœ¨æ•°æ®åº“

**ç†ç”±**:
- ç®€å•ç›´æ¥ï¼Œæ— éœ€é¢å¤–å­˜å‚¨
- ä¾¿äºæŸ¥è¯¢å’Œå¤‡ä»½
- æ”¯æŒäº‹åŠ¡ä¸€è‡´æ€§
- æ˜“äºè¿ç§»å’Œæ‰©å±•

**æ›¿ä»£æ–¹æ¡ˆ**:
- Redisç¼“å­˜ï¼ˆé€‚åˆé«˜å¹¶å‘åœºæ™¯ï¼‰
- ç‹¬ç«‹å·¥ä½œæµæ•°æ®åº“ï¼ˆé€‚åˆå¤§è§„æ¨¡éƒ¨ç½²ï¼‰

### 3. BPMN è®¾è®¡å™¨é€‰æ‹©

**é€‰æ‹©**: BPMN.js

**ç†ç”±**:
- å¼€æºå…è´¹
- åŠŸèƒ½å®Œæ•´
- ç¤¾åŒºæ´»è·ƒ
- æ˜“äºé›†æˆ
- æ”¯æŒè‡ªå®šä¹‰æ‰©å±•

### 4. API è®¾è®¡é£æ ¼

**é€‰æ‹©**: RESTful API

**ç†ç”±**:
- æ ‡å‡†åŒ–æ¥å£
- æ˜“äºç†è§£å’Œä½¿ç”¨
- æ”¯æŒå¤šç§å®¢æˆ·ç«¯
- ä¾¿äºæ–‡æ¡£ç”Ÿæˆ

## ğŸš€ éƒ¨ç½²æ¶æ„

### å¼€å‘ç¯å¢ƒ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Django Development Server         â”‚
â”‚   (python manage.py runserver)      â”‚
â”‚                                     â”‚
â”‚   â”œâ”€â”€ SQLite Database               â”‚
â”‚   â”œâ”€â”€ File-based BPMN Storage       â”‚
â”‚   â””â”€â”€ Console Logging               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç”Ÿäº§ç¯å¢ƒ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Load Balancer                    â”‚
â”‚                      (Nginx)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Application Servers                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚  Gunicorn 1  â”‚  â”‚  Gunicorn 2  â”‚                â”‚
â”‚  â”‚  (Django)    â”‚  â”‚  (Django)    â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  PostgreSQL                         â”‚
â”‚              (Primary + Replica)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Redis Cache                      â”‚
â”‚            (Session + Workflow State)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Celery Workers                     â”‚
â”‚              (Async Task Processing)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### éƒ¨ç½²æ¸…å•

#### 1. ç¯å¢ƒé…ç½®

```bash
# å®‰è£…ä¾èµ–
pip install -r requirements.txt

# é…ç½®ç¯å¢ƒå˜é‡
export DJANGO_SETTINGS_MODULE=leave_system.settings
export DATABASE_URL=postgresql://user:pass@host:5432/db
export REDIS_URL=redis://host:6379/0
export SECRET_KEY=your-secret-key
```

#### 2. æ•°æ®åº“è¿ç§»

```bash
python manage.py migrate
python manage.py createsuperuser
```

#### 3. é™æ€æ–‡ä»¶æ”¶é›†

```bash
python manage.py collectstatic --noinput
```

#### 4. å¯åŠ¨æœåŠ¡

```bash
# Gunicorn
gunicorn leave_system.wsgi:application \
    --bind 0.0.0.0:8000 \
    --workers 4 \
    --timeout 120

# Celery Worker
celery -A leave_system worker -l info

# Celery Beat (å®šæ—¶ä»»åŠ¡)
celery -A leave_system beat -l info
```

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

### 1. æ•°æ®åº“ä¼˜åŒ–

- æ·»åŠ ç´¢å¼•åˆ°å¸¸ç”¨æŸ¥è¯¢å­—æ®µ
- ä½¿ç”¨select_relatedå’Œprefetch_relatedå‡å°‘æŸ¥è¯¢
- å®ç°æ•°æ®åº“è¿æ¥æ± 
- é…ç½®æŸ¥è¯¢ç¼“å­˜

### 2. å·¥ä½œæµä¼˜åŒ–

- ç¼“å­˜BPMNè§„èŒƒå¯¹è±¡
- å¼‚æ­¥å¤„ç†é•¿æ—¶é—´è¿è¡Œçš„ä»»åŠ¡
- æ‰¹é‡å¤„ç†å·¥ä½œæµæ“ä½œ
- ä¼˜åŒ–å·¥ä½œæµçŠ¶æ€åºåˆ—åŒ–

### 3. APIä¼˜åŒ–

- å®ç°åˆ†é¡µ
- ä½¿ç”¨APIç¼“å­˜
- å‹ç¼©å“åº”æ•°æ®
- å®ç°è¯·æ±‚é™æµ

## ğŸ”’ å®‰å…¨è€ƒè™‘

### 1. è®¤è¯å’Œæˆæƒ

- JWT Tokenè®¤è¯
- åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶(RBAC)
- APIæƒé™éªŒè¯
- å®¡è®¡æ—¥å¿—è®°å½•

### 2. æ•°æ®å®‰å…¨

- æ•æ„Ÿæ•°æ®åŠ å¯†
- SQLæ³¨å…¥é˜²æŠ¤
- XSSæ”»å‡»é˜²æŠ¤
- CSRFä¿æŠ¤

### 3. å·¥ä½œæµå®‰å…¨

- æµç¨‹å®šä¹‰è®¿é—®æ§åˆ¶
- ä»»åŠ¡æ‰§è¡Œæƒé™éªŒè¯
- å®¡æ‰¹æ“ä½œå®¡è®¡
- æ•°æ®éš”ç¦»

## ğŸ“ˆ ç›‘æ§å’Œæ—¥å¿—

### 1. åº”ç”¨ç›‘æ§

- è¯·æ±‚å“åº”æ—¶é—´
- APIé”™è¯¯ç‡
- å·¥ä½œæµæ‰§è¡ŒçŠ¶æ€
- æ•°æ®åº“æ€§èƒ½

### 2. æ—¥å¿—ç®¡ç†

```python
LOGGING = {
    'version': 1,
    'handlers': {
        'file': {
            'class': 'logging.FileHandler',
            'filename': 'django.log',
        },
    },
    'loggers': {
        'django': {
            'handlers': ['file'],
            'level': 'INFO',
        },
        'leave_api': {
            'handlers': ['file'],
            'level': 'DEBUG',
        },
    },
}
```

## ğŸ”„ æ‰©å±•æ€§

### 1. æ°´å¹³æ‰©å±•

- æ— çŠ¶æ€åº”ç”¨è®¾è®¡
- ä¼šè¯å­˜å‚¨åœ¨Redis
- å·¥ä½œæµçŠ¶æ€æŒä¹…åŒ–
- è´Ÿè½½å‡è¡¡æ”¯æŒ

### 2. åŠŸèƒ½æ‰©å±•

- æ’ä»¶åŒ–æ¶æ„
- è‡ªå®šä¹‰å·¥ä½œæµèŠ‚ç‚¹
- æ‰©å±•å®¡æ‰¹è§„åˆ™
- é›†æˆç¬¬ä¸‰æ–¹ç³»ç»Ÿ

## ğŸ“š å‚è€ƒèµ„æº

- [Django å®˜æ–¹æ–‡æ¡£](https://docs.djangoproject.com/)
- [SpiffWorkflow æ–‡æ¡£](https://spiffworkflow.readthedocs.io/)
- [BPMN 2.0 è§„èŒƒ](https://www.omg.org/spec/BPMN/2.0/)
- [BPMN.js æ–‡æ¡£](https://bpmn.io/toolkit/bpmn-js/)
- [Django REST Framework](https://www.django-rest-framework.org/)

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**æœ€åæ›´æ–°**: 2026-01-18  
**ç»´æŠ¤è€…**: å¼€å‘å›¢é˜Ÿ
