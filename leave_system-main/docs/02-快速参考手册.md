# Django + SpiffWorkflow 快速参考

## 一、必需依赖
```bash
pip install Django==4.2.9 djangorestframework==3.14.0 \
  django-cors-headers==4.3.1 python-dotenv==1.0.0 \
  SpiffWorkflow==2.0.1 lxml
```

## 二、环境变量 (.env)
```bash
DEBUG=True
SECRET_KEY=your-secret-key
BPMN_PROCESS_DIR=/path/to/process_models
```

## 三、Django 配置 (settings.py)
```python
INSTALLED_APPS = [
    # ...
    'rest_framework',
    'corsheaders',
    'your_app',
]

MIDDLEWARE = [
    # ...
    'corsheaders.middleware.CorsMiddleware',
    # 'django.middleware.csrf.CsrfViewMiddleware',  # 可禁用
]

CORS_ALLOW_ALL_ORIGINS = True  # 开发环境
```

## 四、数据模型 (models.py)
```python
class LeaveRequest(models.Model):
    # 业务字段
    user_email = models.EmailField()
    reason = models.TextField()
    
    # 工作流关联（必需）
    process_instance_id = models.CharField(max_length=255, blank=True, null=True)
    process_model_id = models.CharField(max_length=255, blank=True, null=True)
    
    # 状态
    status = models.CharField(max_length=20, default='draft')
```

## 五、SpiffWorkflow 客户端 (spiff_client.py)
```python
from SpiffWorkflow.bpmn.workflow import BpmnWorkflow
from SpiffWorkflow.bpmn.parser.BpmnParser import BpmnParser

class SpiffWorkflowClient:
    def __init__(self):
        self.process_dir = Path(os.getenv('BPMN_PROCESS_DIR'))
        self.workflow_instances = {}
    
    def start_process(self, process_model_id, variables):
        spec = self._load_bpmn_spec(process_model_id)
        workflow = BpmnWorkflow(spec)
        workflow.data.update(variables)
        workflow.do_engine_steps()
        instance_id = str(uuid.uuid4())
        self.workflow_instances[instance_id] = {'workflow': workflow}
        return {'id': instance_id}
    
    def get_user_tasks(self, user_id=None):
        tasks = []
        for instance_id, data in self.workflow_instances.items():
            for task in data['workflow'].get_ready_user_tasks():
                tasks.append({
                    'task_guid': str(task.id),
                    'process_instance_id': instance_id
                })
        return tasks
    
    def complete_task(self, process_instance_id, task_guid, data):
        workflow = self.workflow_instances[process_instance_id]['workflow']
        for task in workflow.get_ready_user_tasks():
            if str(task.id) == task_guid:
                task.data.update(data)
                task.complete()
                workflow.do_engine_steps()
                return {'success': True}

spiff_client = SpiffWorkflowClient()
```

## 六、API 视图 (views.py)
```python
from .spiff_client import spiff_client

@api_view(['POST'])
def create_leave_request(request):
    # 1. 创建记录
    leave = LeaveRequest.objects.create(
        user_email=request.data['user_email'],
        reason=request.data['reason']
    )
    
    # 2. 启动工作流
    result = spiff_client.start_process(
        "admin/admin",
        {'leave_request_id': leave.id}
    )
    
    # 3. 保存流程 ID
    leave.process_instance_id = result['id']
    leave.status = 'pending'
    leave.save()
    
    return Response({'success': True, 'leave_request_id': leave.id})

@api_view(['GET'])
def get_pending_approvals(request):
    # 1. 获取工作流任务
    tasks = spiff_client.get_user_tasks()
    
    # 2. 关联业务数据
    approvals = []
    for task in tasks:
        leave = LeaveRequest.objects.get(
            process_instance_id=task['process_instance_id']
        )
        approvals.append({
            'task_guid': task['task_guid'],
            'leave_request': {'id': leave.id, 'reason': leave.reason}
        })
    
    return Response({'pending_approvals': approvals})

@api_view(['POST'])
def approve_leave_request(request):
    # 1. 完成工作流任务
    result = spiff_client.complete_task(
        request.data['process_instance_id'],
        request.data['task_guid'],
        {'approved': request.data['approved']}
    )
    
    # 2. 更新业务状态
    leave = LeaveRequest.objects.get(id=request.data['leave_request_id'])
    leave.status = 'approved' if request.data['approved'] else 'rejected'
    leave.save()
    
    return Response({'success': True})
```

## 七、URL 配置 (urls.py)
```python
urlpatterns = [
    path('leave/create/', views.create_leave_request),
    path('leave/pending-approvals/', views.get_pending_approvals),
    path('leave/approve/', views.approve_leave_request),
]
```

## 八、BPMN 文件结构
```
process_models/
└── admin/
    └── admin/
        └── admin.bpmn
```

## 九、BPMN 基本结构
```xml
<bpmn:process id="Process_admin" isExecutable="true">
  <bpmn:startEvent id="Start">
    <bpmn:outgoing>Flow1</bpmn:outgoing>
  </bpmn:startEvent>
  
  <bpmn:userTask id="ApprovalTask" name="审批">
    <bpmn:incoming>Flow1</bpmn:incoming>
    <bpmn:outgoing>Flow2</bpmn:outgoing>
  </bpmn:userTask>
  
  <bpmn:endEvent id="End">
    <bpmn:incoming>Flow2</bpmn:incoming>
  </bpmn:endEvent>
  
  <bpmn:sequenceFlow id="Flow1" sourceRef="Start" targetRef="ApprovalTask" />
  <bpmn:sequenceFlow id="Flow2" sourceRef="ApprovalTask" targetRef="End" />
</bpmn:process>
```

## 十、测试命令
```bash
# 运行迁移
python manage.py migrate

# 启动服务
python manage.py runserver 8888

# 测试 API
curl -X POST http://127.0.0.1:8888/api/leave/create/ \
  -H "Content-Type: application/json" \
  -d '{"user_email":"test@example.com","reason":"请假","leave_hours":8}'
```

## 核心集成点总结

| 组件 | 关键配置 | 说明 |
|------|----------|------|
| **环境变量** | `BPMN_PROCESS_DIR` | BPMN 文件目录 |
| **数据模型** | `process_instance_id` | 关联工作流实例 |
| **客户端** | `spiff_client` | 全局单例 |
| **视图** | 三个核心方法 | 创建、查询、审批 |
| **BPMN** | 流程定义文件 | 定义工作流结构 |

## 集成流程

```
1. 用户提交 → 2. 创建记录 → 3. 启动工作流 → 4. 保存 process_instance_id
                                                    ↓
5. 查询状态 ← 6. 更新状态 ← 7. 完成任务 ← 8. 审批人操作
```

## 常见问题速查

| 问题 | 解决方案 |
|------|----------|
| 找不到 BPMN 文件 | 检查 `BPMN_PROCESS_DIR` 环境变量 |
| 编码错误 | BPMN 文件使用 UTF-8 编码 |
| 工作流丢失 | 实现持久化或使用数据库存储 |
| CORS 错误 | 添加 `corsheaders` 并配置 |
| 任务找不到 | 检查 `process_instance_id` 是否正确 |
