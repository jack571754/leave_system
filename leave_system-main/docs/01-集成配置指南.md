# Django + SpiffWorkflow 集成配置指南

本文档详细说明如何将 Django 与 SpiffWorkflow 工作流引擎集成。

## 目录
1. [架构概述](#架构概述)
2. [必需依赖](#必需依赖)
3. [环境配置](#环境配置)
4. [Django 配置](#django-配置)
5. [数据模型设计](#数据模型设计)
6. [SpiffWorkflow 客户端](#spiffworkflow-客户端)
7. [API 视图实现](#api-视图实现)
8. [URL 路由配置](#url-路由配置)
9. [BPMN 流程设计](#bpmn-流程设计)
10. [测试验证](#测试验证)

---

## 架构概述

### 集成架构图
```
┌─────────────────────────────────────────────────────────┐
│                    Django 应用层                         │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐ │
│  │  REST API    │  │  业务逻辑    │  │  数据模型    │ │
│  │  (views.py)  │  │ (services)   │  │ (models.py)  │ │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘ │
│         │                  │                  │          │
│         └──────────────────┼──────────────────┘          │
│                            │                             │
│  ┌─────────────────────────▼──────────────────────────┐ │
│  │         SpiffWorkflow 客户端 (spiff_client.py)     │ │
│  │  - BPMN 解析                                       │ │
│  │  - 工作流实例管理                                  │ │
│  │  - 任务执行                                        │ │
│  └────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────┘
                            │
                            ▼
                  ┌──────────────────┐
                  │  BPMN 流程文件   │
                  │  (.bpmn)         │
                  └──────────────────┘
```

### 核心组件
1. **Django Models** - 存储业务数据和流程实例 ID
2. **SpiffWorkflow Client** - 封装工作流引擎操作
3. **REST API Views** - 提供业务接口
4. **BPMN Files** - 定义工作流流程

---

## 必需依赖

### requirements.txt
```txt
Django==4.2.9
djangorestframework==3.14.0
django-cors-headers==4.3.1
python-dotenv==1.0.0
SpiffWorkflow==2.0.1
lxml>=4.9.0
```

### 安装命令
```bash
pip install -r requirements.txt
```

---

## 环境配置

### .env 文件
创建 `leave_system/.env` 文件：

```bash
# Django 配置
DEBUG=True
SECRET_KEY=your-secret-key-here

# SpiffWorkflow 配置
BPMN_PROCESS_DIR=/absolute/path/to/process_models
# 或使用相对路径（相对于 Django 项目根目录）
# BPMN_PROCESS_DIR=../process_models
```

### 配置说明
| 配置项 | 必需 | 说明 | 示例 |
|--------|------|------|------|
| `DEBUG` | 是 | Django 调试模式 | `True` / `False` |
| `SECRET_KEY` | 是 | Django 密钥 | 随机字符串 |
| `BPMN_PROCESS_DIR` | 是 | BPMN 文件目录 | `/path/to/process_models` |

---

## Django 配置

### settings.py 关键配置

```python
# leave_system/leave_system/settings.py

from pathlib import Path
import os
from dotenv import load_dotenv

BASE_DIR = Path(__file__).resolve().parent.parent
load_dotenv(BASE_DIR / '.env')

# 安全配置
SECRET_KEY = os.getenv('SECRET_KEY', 'default-secret-key')
DEBUG = os.getenv('DEBUG', 'False') == 'True'
ALLOWED_HOSTS = ['*']  # 生产环境应限制

# 应用配置
INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    'rest_framework',      # DRF
    'corsheaders',         # CORS
    'leave_api',           # 业务应用
]

# 中间件配置
MIDDLEWARE = [
    'django.middleware.security.SecurityMiddleware',
    'django.contrib.sessions.middleware.SessionMiddleware',
    'corsheaders.middleware.CorsMiddleware',  # CORS
    'django.middleware.common.CommonMiddleware',
    # 'django.middleware.csrf.CsrfViewMiddleware',  # API 可禁用
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
]

# CORS 配置（开发环境）
CORS_ALLOW_ALL_ORIGINS = True
CORS_ALLOW_CREDENTIALS = True

# 数据库配置
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.sqlite3',
        'NAME': BASE_DIR / 'db.sqlite3',
    }
}

# 日志配置
LOGGING = {
    'version': 1,
    'disable_existing_loggers': False,
    'formatters': {
        'verbose': {
            'format': '{levelname} {asctime} {module} {message}',
            'style': '{',
        },
    },
    'handlers': {
        'console': {
            'class': 'logging.StreamHandler',
            'formatter': 'verbose',
        },
    },
    'root': {
        'handlers': ['console'],
        'level': 'INFO',
    },
    'loggers': {
        'leave_api': {
            'handlers': ['console'],
            'level': 'DEBUG',
            'propagate': False,
        },
    },
}
```

### 必需配置项说明

1. **rest_framework** - 必需，提供 API 功能
2. **corsheaders** - 必需，处理跨域请求
3. **leave_api** - 业务应用
4. **CORS 配置** - 允许前端访问 API
5. **日志配置** - 便于调试工作流

---

## 数据模型设计

### models.py 核心字段

```python
# leave_system/leave_api/models.py

from django.db import models

class LeaveRequest(models.Model):
    """请假申请模型"""
    
    # 业务字段
    user_email = models.EmailField(verbose_name='申请人邮箱')
    reason = models.TextField(verbose_name='请假原因')
    leave_hours = models.IntegerField(verbose_name='请假时长（小时）')
    
    # 工作流关联字段（核心）
    process_instance_id = models.CharField(
        max_length=255, 
        blank=True, 
        null=True,
        verbose_name='流程实例ID',
        help_text='SpiffWorkflow 工作流实例的唯一标识'
    )
    process_model_id = models.CharField(
        max_length=255, 
        blank=True, 
        null=True,
        verbose_name='流程模型ID',
        help_text='BPMN 流程模型标识，如 admin/admin'
    )
    
    # 状态字段
    STATUS_CHOICES = [
        ('draft', '草稿'),
        ('pending', '待审批'),
        ('approved', '已批准'),
        ('rejected', '已拒绝'),
        ('cancelled', '已取消'),
    ]
    status = models.CharField(
        max_length=20, 
        choices=STATUS_CHOICES, 
        default='draft',
        verbose_name='状态'
    )
    
    # 审批信息
    approver_email = models.EmailField(blank=True, null=True)
    approver_name = models.CharField(max_length=100, blank=True, null=True)
    approval_comment = models.TextField(blank=True, null=True)
    approved_at = models.DateTimeField(blank=True, null=True)
    
    # 时间戳
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    submitted_at = models.DateTimeField(blank=True, null=True)
    
    class Meta:
        db_table = 'leave_requests'
        ordering = ['-created_at']
```

### 关键字段说明

| 字段 | 类型 | 必需 | 说明 |
|------|------|------|------|
| `process_instance_id` | CharField | **是** | 关联 SpiffWorkflow 实例的唯一 ID |
| `process_model_id` | CharField | 否 | 记录使用的 BPMN 流程模型 |
| `status` | CharField | **是** | 业务状态，与工作流状态同步 |

### 数据库迁移

```bash
python manage.py makemigrations
python manage.py migrate
```

---

## SpiffWorkflow 客户端

### spiff_client.py 核心实现

```python
# leave_system/leave_api/spiff_client.py

import os
import logging
import uuid
from pathlib import Path
from lxml import etree
from SpiffWorkflow.bpmn.workflow import BpmnWorkflow
from SpiffWorkflow.bpmn.parser.BpmnParser import BpmnParser
from SpiffWorkflow.bpmn.serializer.workflow import BpmnWorkflowSerializer

logger = logging.getLogger(__name__)

class SpiffWorkflowClient:
    """SpiffWorkflow 客户端封装"""
    
    def __init__(self):
        # 1. 加载 BPMN 目录配置
        process_dir_env = os.getenv('BPMN_PROCESS_DIR', '../process_models')
        self.process_dir = Path(process_dir_env)
        
        if not self.process_dir.is_absolute():
            from django.conf import settings
            self.process_dir = (settings.BASE_DIR.parent / process_dir_env).resolve()
        
        logger.info(f"BPMN 流程目录: {self.process_dir}")
        
        # 2. 工作流实例存储（内存）
        self.workflow_instances = {}
    
    def _load_bpmn_spec(self, process_model_id):
        """加载 BPMN 流程定义"""
        # 构建文件路径：process_models/group/model/model.bpmn
        parts = process_model_id.split('/')
        bpmn_file = self.process_dir / parts[0] / parts[1] / f"{parts[1]}.bpmn"
        
        if not bpmn_file.exists():
            raise FileNotFoundError(f"找不到 BPMN 文件: {bpmn_file}")
        
        logger.info(f"加载 BPMN 文件: {bpmn_file}")
        
        # 解析 BPMN（使用 UTF-8 编码）
        parser = BpmnParser()
        with open(str(bpmn_file), 'r', encoding='utf-8') as f:
            parser.add_bpmn_xml(etree.parse(f), str(bpmn_file))
        
        # 获取流程规范
        try:
            spec = parser.get_spec(parts[1])
        except Exception:
            # 如果找不到，使用第一个可用流程
            available_specs = list(parser.get_process_ids())
            if available_specs:
                logger.info(f"使用流程 ID: {available_specs[0]}")
                spec = parser.get_spec(available_specs[0])
            else:
                raise ValueError("BPMN 文件中没有找到可用的流程")
        
        return spec
    
    def start_process(self, process_model_id, variables=None):
        """启动工作流实例"""
        try:
            # 1. 加载流程定义
            spec = self._load_bpmn_spec(process_model_id)
            
            # 2. 创建工作流实例
            workflow = BpmnWorkflow(spec)
            
            # 3. 设置流程变量
            if variables:
                workflow.data.update(variables)
            
            # 4. 生成实例 ID
            instance_id = str(uuid.uuid4())
            
            # 5. 执行到第一个用户任务
            workflow.do_engine_steps()
            
            # 6. 保存实例
            self.workflow_instances[instance_id] = {
                'workflow': workflow,
                'process_model_id': process_model_id,
                'status': 'running' if not workflow.is_completed() else 'completed'
            }
            
            logger.info(f"流程启动成功: {instance_id}")
            
            return {
                'id': instance_id,
                'status': self.workflow_instances[instance_id]['status'],
                'process_model_id': process_model_id
            }
            
        except Exception as e:
            logger.error(f"启动流程失败: {e}", exc_info=True)
            return None
    
    def get_user_tasks(self, user_id=None):
        """获取待办任务"""
        tasks = []
        
        for instance_id, instance_data in self.workflow_instances.items():
            workflow = instance_data['workflow']
            ready_tasks = workflow.get_ready_user_tasks()
            
            for task in ready_tasks:
                tasks.append({
                    'id': str(task.id),
                    'name': task.task_spec.name,
                    'process_instance_id': instance_id,
                    'task_guid': str(task.id),
                    'state': task.state,
                    'data': task.data
                })
        
        logger.info(f"查询到 {len(tasks)} 个待办任务")
        return tasks
    
    def complete_task(self, process_instance_id, task_guid, data=None):
        """完成任务"""
        try:
            if process_instance_id not in self.workflow_instances:
                logger.error(f"找不到流程实例: {process_instance_id}")
                return None
            
            instance_data = self.workflow_instances[process_instance_id]
            workflow = instance_data['workflow']
            
            # 查找任务
            task = None
            for ready_task in workflow.get_ready_user_tasks():
                if str(ready_task.id) == task_guid:
                    task = ready_task
                    break
            
            if not task:
                logger.error(f"找不到任务: {task_guid}")
                return None
            
            # 更新任务数据
            if data:
                task.data.update(data)
            
            # 完成任务
            task.complete()
            
            # 继续执行工作流
            workflow.do_engine_steps()
            
            # 更新状态
            instance_data['status'] = 'completed' if workflow.is_completed() else 'running'
            
            logger.info(f"任务完成: {task_guid}")
            
            return {
                'success': True,
                'status': instance_data['status'],
                'completed': workflow.is_completed()
            }
            
        except Exception as e:
            logger.error(f"完成任务失败: {e}", exc_info=True)
            return None

# 全局单例
spiff_client = SpiffWorkflowClient()
```

### 客户端关键方法

| 方法 | 说明 | 返回值 |
|------|------|--------|
| `start_process()` | 启动工作流 | `{'id': uuid, 'status': 'running'}` |
| `get_user_tasks()` | 查询待办任务 | 任务列表 |
| `complete_task()` | 完成任务 | `{'success': True, 'completed': False}` |

---

## API 视图实现

### views.py 核心视图

```python
# leave_system/leave_api/views.py

from rest_framework.decorators import api_view
from rest_framework.response import Response
from rest_framework import status
from django.utils import timezone
from .models import LeaveRequest
from .spiff_client import spiff_client
import logging

logger = logging.getLogger(__name__)

@api_view(['POST'])
def create_leave_request(request):
    """创建请假申请并启动工作流"""
    try:
        # 1. 获取请求数据
        user_email = request.data['user_email']
        reason = request.data['reason']
        leave_hours = request.data['leave_hours']
        
        # 2. 创建数据库记录
        leave_request = LeaveRequest.objects.create(
            user_email=user_email,
            reason=reason,
            leave_hours=leave_hours,
            status='draft'
        )
        
        # 3. 启动工作流
        process_model_id = "admin/admin"  # BPMN 流程 ID
        result = spiff_client.start_process(
            process_model_id,
            {
                'leave_request_id': leave_request.id,
                'user_email': user_email,
                'reason': reason,
                'leave_hours': leave_hours,
            }
        )
        
        if not result:
            return Response({
                'success': False,
                'error': '启动工作流失败'
            }, status=status.HTTP_500_INTERNAL_SERVER_ERROR)
        
        # 4. 保存流程实例 ID
        leave_request.process_instance_id = result['id']
        leave_request.process_model_id = process_model_id
        leave_request.status = 'pending'
        leave_request.submitted_at = timezone.now()
        leave_request.save()
        
        return Response({
            'success': True,
            'leave_request_id': leave_request.id,
            'process_instance_id': leave_request.process_instance_id,
            'status': leave_request.status
        }, status=status.HTTP_201_CREATED)
        
    except KeyError as e:
        return Response({
            'success': False,
            'error': f'缺少必填字段: {str(e)}'
        }, status=status.HTTP_400_BAD_REQUEST)

@api_view(['GET'])
def get_pending_approvals(request):
    """查询待审批任务"""
    user_id = request.query_params.get('user_id', 'admin')
    
    try:
        # 1. 从工作流引擎获取待办任务
        tasks = spiff_client.get_user_tasks(user_id)
        
        # 2. 关联业务数据
        pending_approvals = []
        for task in tasks:
            process_instance_id = task['process_instance_id']
            
            try:
                leave_request = LeaveRequest.objects.get(
                    process_instance_id=process_instance_id
                )
                pending_approvals.append({
                    'task_guid': task['task_guid'],
                    'task_name': task['name'],
                    'process_instance_id': process_instance_id,
                    'leave_request': {
                        'id': leave_request.id,
                        'user_email': leave_request.user_email,
                        'reason': leave_request.reason,
                        'leave_hours': leave_request.leave_hours,
                        'status': leave_request.status,
                    }
                })
            except LeaveRequest.DoesNotExist:
                continue
        
        return Response({
            'success': True,
            'count': len(pending_approvals),
            'pending_approvals': pending_approvals
        })
        
    except Exception as e:
        logger.error(f"查询失败: {e}", exc_info=True)
        return Response({
            'success': False,
            'error': str(e)
        }, status=status.HTTP_500_INTERNAL_SERVER_ERROR)

@api_view(['POST'])
def approve_leave_request(request):
    """审批请假申请"""
    try:
        # 1. 获取审批数据
        task_guid = request.data['task_guid']
        process_instance_id = request.data['process_instance_id']
        leave_request_id = request.data['leave_request_id']
        approved = request.data.get('approved', True)
        comment = request.data.get('comment', '')
        
        # 2. 获取请假记录
        leave_request = LeaveRequest.objects.get(id=leave_request_id)
        
        # 3. 完成工作流任务
        result = spiff_client.complete_task(
            process_instance_id,
            task_guid,
            {'approved': approved, 'comment': comment}
        )
        
        if not result:
            return Response({
                'success': False,
                'error': '完成任务失败'
            }, status=status.HTTP_500_INTERNAL_SERVER_ERROR)
        
        # 4. 更新业务状态
        leave_request.status = 'approved' if approved else 'rejected'
        leave_request.approval_comment = comment
        leave_request.approved_at = timezone.now()
        leave_request.save()
        
        return Response({
            'success': True,
            'message': '审批提交成功',
            'status': leave_request.status
        })
        
    except KeyError as e:
        return Response({
            'success': False,
            'error': f'缺少必填字段: {str(e)}'
        }, status=status.HTTP_400_BAD_REQUEST)
```

### 视图集成要点

1. **创建流程**：先创建数据库记录，再启动工作流，最后保存 `process_instance_id`
2. **查询任务**：从工作流引擎获取任务，再关联业务数据
3. **完成任务**：先完成工作流任务，再更新业务状态
4. **错误处理**：捕获异常并返回友好的错误信息

---

## URL 路由配置

### urls.py 配置

```python
# leave_system/leave_api/urls.py

from django.urls import path
from . import views

urlpatterns = [
    path('leave/create/', views.create_leave_request),
    path('leave/my-requests/', views.get_my_leave_requests),
    path('leave/pending-approvals/', views.get_pending_approvals),
    path('leave/approve/', views.approve_leave_request),
]
```

### 主 URL 配置

```python
# leave_system/leave_system/urls.py

from django.contrib import admin
from django.urls import path, include

urlpatterns = [
    path('admin/', admin.site.urls),
    path('api/', include('leave_api.urls')),  # API 路由
]
```

---

## BPMN 流程设计

### 流程文件结构

```
process_models/
└── admin/
    └── admin/
        ├── admin.bpmn              # BPMN 流程定义
        ├── process_model.json      # 流程元数据
        ├── leave-form-schema.json  # 表单 Schema
        └── leave-form-uischema.json # 表单 UI Schema
```

### BPMN 基本结构

```xml
<?xml version="1.0" encoding="UTF-8"?>
<bpmn:definitions xmlns:bpmn="http://www.omg.org/spec/BPMN/20100524/MODEL">
  <bpmn:process id="Process_admin" isExecutable="true">
    
    <!-- 开始事件 -->
    <bpmn:startEvent id="StartEvent_1">
      <bpmn:outgoing>Flow_1</bpmn:outgoing>
    </bpmn:startEvent>
    
    <!-- 用户任务 -->
    <bpmn:userTask id="ApprovalTask" name="审批">
      <bpmn:incoming>Flow_1</bpmn:incoming>
      <bpmn:outgoing>Flow_2</bpmn:outgoing>
    </bpmn:userTask>
    
    <!-- 结束事件 -->
    <bpmn:endEvent id="EndEvent_1">
      <bpmn:incoming>Flow_2</bpmn:incoming>
    </bpmn:endEvent>
    
    <!-- 连接线 -->
    <bpmn:sequenceFlow id="Flow_1" 
      sourceRef="StartEvent_1" 
      targetRef="ApprovalTask" />
    <bpmn:sequenceFlow id="Flow_2" 
      sourceRef="ApprovalTask" 
      targetRef="EndEvent_1" />
      
  </bpmn:process>
</bpmn:definitions>
```

### BPMN 设计工具

推荐使用 [Camunda Modeler](https://camunda.com/download/modeler/) 设计 BPMN 流程。

---

## 测试验证

### 1. 基础测试

```python
# test_spiffworkflow.py

import os
import sys
from pathlib import Path

sys.path.insert(0, str(Path(__file__).parent / 'leave_system'))
os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'leave_system.settings')

import django
django.setup()

from leave_api.spiff_client import spiff_client

# 测试启动流程
result = spiff_client.start_process(
    "admin/admin",
    {"leave_request_id": 1, "user_email": "test@example.com"}
)

print(f"流程启动: {result}")

# 测试查询任务
tasks = spiff_client.get_user_tasks()
print(f"待办任务: {len(tasks)}")
```

### 2. API 测试

```bash
# 创建请假
curl -X POST http://127.0.0.1:8888/api/leave/create/ \
  -H "Content-Type: application/json" \
  -d '{"user_email":"test@example.com","reason":"请假","leave_hours":8}'

# 查询待审批
curl http://127.0.0.1:8888/api/leave/pending-approvals/?user_id=admin

# 提交审批
curl -X POST http://127.0.0.1:8888/api/leave/approve/ \
  -H "Content-Type: application/json" \
  -d '{"task_guid":"xxx","process_instance_id":"xxx","leave_request_id":1,"approved":true}'
```

---

## 集成检查清单

### 必需配置
- [ ] 安装所有依赖包
- [ ] 创建 `.env` 文件并配置 `BPMN_PROCESS_DIR`
- [ ] 在 `settings.py` 中添加 `rest_framework` 和 `corsheaders`
- [ ] 创建数据模型并包含 `process_instance_id` 字段
- [ ] 实现 `SpiffWorkflowClient` 类
- [ ] 创建 API 视图函数
- [ ] 配置 URL 路由
- [ ] 准备 BPMN 流程文件

### 可选配置
- [ ] 配置日志系统
- [ ] 实现工作流持久化
- [ ] 添加用户认证
- [ ] 配置生产环境数据库
- [ ] 实现错误监控

---

## 常见问题

### Q1: 找不到 BPMN 文件
**解决方案**：
- 检查 `BPMN_PROCESS_DIR` 环境变量
- 确认文件路径格式：`{BPMN_PROCESS_DIR}/group/model/model.bpmn`
- 使用绝对路径避免路径问题

### Q2: 工作流实例丢失
**原因**：当前实现将实例存储在内存中
**解决方案**：实现持久化（见下节）

### Q3: 编码错误
**解决方案**：确保 BPMN 文件使用 UTF-8 编码

---

## 生产环境建议

### 1. 工作流持久化

```python
from SpiffWorkflow.bpmn.serializer.workflow import BpmnWorkflowSerializer

# 序列化
serializer = BpmnWorkflowSerializer()
workflow_json = serializer.serialize_json(workflow)

# 保存到数据库
WorkflowInstance.objects.create(
    instance_id=instance_id,
    workflow_data=workflow_json
)

# 恢复
instance = WorkflowInstance.objects.get(instance_id=instance_id)
workflow = serializer.deserialize_json(instance.workflow_data)
```

### 2. 使用 PostgreSQL

```python
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.postgresql',
        'NAME': 'leave_system',
        'USER': 'postgres',
        'PASSWORD': 'password',
        'HOST': 'localhost',
        'PORT': '5432',
    }
}
```

### 3. 添加认证

```python
from rest_framework.permissions import IsAuthenticated

@api_view(['POST'])
@permission_classes([IsAuthenticated])
def create_leave_request(request):
    # ...
```

---

## 总结

### 核心集成点
1. **数据模型** - 添加 `process_instance_id` 字段关联工作流
2. **客户端封装** - 封装 SpiffWorkflow API
3. **视图集成** - 在业务逻辑中调用工作流
4. **BPMN 文件** - 定义流程结构

### 关键配置
- `BPMN_PROCESS_DIR` - BPMN 文件目录
- `process_instance_id` - 关联字段
- `spiff_client` - 全局客户端实例

### 下一步
- 实现工作流持久化
- 添加更复杂的 BPMN 流程
- 实现多级审批
- 添加通知功能

---

## 参考资源

- [SpiffWorkflow 官方文档](https://github.com/sartography/SpiffWorkflow)
- [Django REST Framework](https://www.django-rest-framework.org/)
- [BPMN 2.0 规范](https://www.omg.org/spec/BPMN/2.0/)
- [Camunda Modeler](https://camunda.com/download/modeler/)
