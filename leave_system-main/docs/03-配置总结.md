# Django + SpiffWorkflow é…ç½®æ€»ç»“

## ğŸ“‹ é…ç½®æ¸…å•

### âœ… å·²å®Œæˆé…ç½®

#### 1. ä¾èµ–åŒ…
- âœ… Django 4.2.9
- âœ… djangorestframework 3.14.0
- âœ… django-cors-headers 4.3.1
- âœ… python-dotenv 1.0.0
- âœ… SpiffWorkflow 2.0.1
- âœ… lxml

#### 2. ç¯å¢ƒå˜é‡ (.env)
```bash
DEBUG=True
SECRET_KEY=django-insecure-mvl*+mstn0=9)p(7h2y(@m3%0r*_uthzfk&-#51#r3()cylx2o
BPMN_PROCESS_DIR=E:/project/leave_system-main/process_models
```

#### 3. Django é…ç½® (settings.py)
- âœ… INSTALLED_APPS åŒ…å« rest_framework, corsheaders, leave_api
- âœ… MIDDLEWARE åŒ…å« CorsMiddleware
- âœ… CORS_ALLOW_ALL_ORIGINS = True
- âœ… æ—¥å¿—é…ç½®å®Œæˆ

#### 4. æ•°æ®æ¨¡å‹ (models.py)
- âœ… LeaveRequest æ¨¡å‹
- âœ… process_instance_id å­—æ®µï¼ˆå…³è”å·¥ä½œæµï¼‰
- âœ… process_model_id å­—æ®µ
- âœ… status å­—æ®µï¼ˆçŠ¶æ€ç®¡ç†ï¼‰

#### 5. SpiffWorkflow å®¢æˆ·ç«¯ (spiff_client.py)
- âœ… SpiffWorkflowClient ç±»
- âœ… start_process() æ–¹æ³•
- âœ… get_user_tasks() æ–¹æ³•
- âœ… complete_task() æ–¹æ³•
- âœ… å…¨å±€å•ä¾‹ spiff_client

#### 6. API è§†å›¾ (views.py)
- âœ… create_leave_request() - åˆ›å»ºè¯·å‡å¹¶å¯åŠ¨å·¥ä½œæµ
- âœ… get_my_leave_requests() - æŸ¥è¯¢æˆ‘çš„è¯·å‡
- âœ… get_pending_approvals() - æŸ¥è¯¢å¾…å®¡æ‰¹ä»»åŠ¡
- âœ… approve_leave_request() - æäº¤å®¡æ‰¹å†³å®š

#### 7. URL è·¯ç”± (urls.py)
- âœ… /api/leave/create/
- âœ… /api/leave/my-requests/
- âœ… /api/leave/pending-approvals/
- âœ… /api/leave/approve/

#### 8. BPMN æµç¨‹æ–‡ä»¶
- âœ… process_models/admin/admin/admin.bpmn
- âœ… åŒ…å«ç”¨æˆ·ä»»åŠ¡å’Œæ’ä»–ç½‘å…³

---

## ğŸ”§ æ ¸å¿ƒé›†æˆç‚¹

### 1. æ•°æ®æ¨¡å‹ä¸å·¥ä½œæµå…³è”
```python
class LeaveRequest(models.Model):
    # å…³é”®å­—æ®µï¼šå…³è”å·¥ä½œæµå®ä¾‹
    process_instance_id = models.CharField(max_length=255, blank=True, null=True)
    process_model_id = models.CharField(max_length=255, blank=True, null=True)
    status = models.CharField(max_length=20, default='draft')
```

### 2. å·¥ä½œæµå¯åŠ¨æµç¨‹
```python
# 1. åˆ›å»ºæ•°æ®åº“è®°å½•
leave_request = LeaveRequest.objects.create(...)

# 2. å¯åŠ¨å·¥ä½œæµ
result = spiff_client.start_process("admin/admin", variables)

# 3. ä¿å­˜æµç¨‹å®ä¾‹ ID
leave_request.process_instance_id = result['id']
leave_request.save()
```

### 3. ä»»åŠ¡æŸ¥è¯¢æµç¨‹
```python
# 1. ä»å·¥ä½œæµå¼•æ“è·å–ä»»åŠ¡
tasks = spiff_client.get_user_tasks()

# 2. å…³è”ä¸šåŠ¡æ•°æ®
for task in tasks:
    leave = LeaveRequest.objects.get(
        process_instance_id=task['process_instance_id']
    )
```

### 4. ä»»åŠ¡å®Œæˆæµç¨‹
```python
# 1. å®Œæˆå·¥ä½œæµä»»åŠ¡
result = spiff_client.complete_task(
    process_instance_id, 
    task_guid, 
    {'approved': True}
)

# 2. æ›´æ–°ä¸šåŠ¡çŠ¶æ€
leave_request.status = 'approved'
leave_request.save()
```

---

## ğŸ“ æ–‡ä»¶ç»“æ„

```
leave_system-main/
â”œâ”€â”€ leave_system/                    # Django é¡¹ç›®
â”‚   â”œâ”€â”€ leave_api/                   # ä¸šåŠ¡åº”ç”¨
â”‚   â”‚   â”œâ”€â”€ models.py               # âœ… æ•°æ®æ¨¡å‹ï¼ˆå« process_instance_idï¼‰
â”‚   â”‚   â”œâ”€â”€ views.py                # âœ… API è§†å›¾ï¼ˆ4ä¸ªæ ¸å¿ƒæ¥å£ï¼‰
â”‚   â”‚   â”œâ”€â”€ spiff_client.py         # âœ… SpiffWorkflow å®¢æˆ·ç«¯
â”‚   â”‚   â””â”€â”€ urls.py                 # âœ… URL è·¯ç”±
â”‚   â”œâ”€â”€ leave_system/
â”‚   â”‚   â””â”€â”€ settings.py             # âœ… Django é…ç½®
â”‚   â”œâ”€â”€ .env                        # âœ… ç¯å¢ƒå˜é‡
â”‚   â””â”€â”€ manage.py
â”œâ”€â”€ process_models/                  # âœ… BPMN æµç¨‹æ–‡ä»¶
â”‚   â””â”€â”€ admin/admin/admin.bpmn
â”œâ”€â”€ INTEGRATION_GUIDE.md            # âœ… é›†æˆé…ç½®æŒ‡å—
â”œâ”€â”€ QUICK_REFERENCE.md              # âœ… å¿«é€Ÿå‚è€ƒ
â”œâ”€â”€ check_integration.py            # âœ… é…ç½®æ£€æŸ¥è„šæœ¬
â””â”€â”€ README.md
```

---

## ğŸ¯ å¿…éœ€é…ç½®é¡¹

| é…ç½®é¡¹ | ä½ç½® | è¯´æ˜ | çŠ¶æ€ |
|--------|------|------|------|
| **BPMN_PROCESS_DIR** | .env | BPMN æ–‡ä»¶ç›®å½• | âœ… |
| **rest_framework** | settings.py | DRF æ¡†æ¶ | âœ… |
| **corsheaders** | settings.py | CORS æ”¯æŒ | âœ… |
| **process_instance_id** | models.py | å…³è”å­—æ®µ | âœ… |
| **spiff_client** | spiff_client.py | å…¨å±€å®¢æˆ·ç«¯ | âœ… |
| **API è§†å›¾** | views.py | 4ä¸ªæ ¸å¿ƒæ¥å£ | âœ… |
| **URL è·¯ç”±** | urls.py | API è·¯ç”± | âœ… |
| **BPMN æ–‡ä»¶** | process_models/ | æµç¨‹å®šä¹‰ | âœ… |

---

## ğŸ”„ æ•°æ®æµè½¬

### åˆ›å»ºè¯·å‡ç”³è¯·
```
ç”¨æˆ·æäº¤è¡¨å•
    â†“
Django åˆ›å»º LeaveRequest è®°å½•
    â†“
è°ƒç”¨ spiff_client.start_process()
    â†“
SpiffWorkflow è§£æ BPMN å¹¶åˆ›å»ºå®ä¾‹
    â†“
è¿”å› process_instance_id
    â†“
ä¿å­˜åˆ° LeaveRequest.process_instance_id
    â†“
å·¥ä½œæµæ‰§è¡Œåˆ°ç¬¬ä¸€ä¸ªç”¨æˆ·ä»»åŠ¡
```

### æŸ¥è¯¢å¾…å®¡æ‰¹
```
å®¡æ‰¹äººè¯·æ±‚å¾…å®¡æ‰¹åˆ—è¡¨
    â†“
è°ƒç”¨ spiff_client.get_user_tasks()
    â†“
SpiffWorkflow è¿”å›æ‰€æœ‰å°±ç»ªçš„ç”¨æˆ·ä»»åŠ¡
    â†“
æ ¹æ® process_instance_id æŸ¥è¯¢ LeaveRequest
    â†“
ç»„åˆå·¥ä½œæµä»»åŠ¡å’Œä¸šåŠ¡æ•°æ®
    â†“
è¿”å›å¾…å®¡æ‰¹åˆ—è¡¨
```

### æäº¤å®¡æ‰¹
```
å®¡æ‰¹äººæäº¤å®¡æ‰¹å†³å®š
    â†“
è°ƒç”¨ spiff_client.complete_task()
    â†“
SpiffWorkflow å®Œæˆä»»åŠ¡å¹¶ç»§ç»­æ‰§è¡Œ
    â†“
æ›´æ–° LeaveRequest.status
    â†“
è¿”å›å®¡æ‰¹ç»“æœ
```

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### 1. é…ç½®æ£€æŸ¥
```bash
python check_integration.py
```

### 2. åŸºç¡€æµ‹è¯•
```bash
python test_spiffworkflow.py
```

### 3. API æµ‹è¯•
```bash
.\test_api.ps1
```

### 4. æ‰‹åŠ¨æµ‹è¯•
è®¿é—® http://127.0.0.1:8888 ä½¿ç”¨å‰ç«¯ç•Œé¢

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. å·¥ä½œæµæŒä¹…åŒ–
- **å½“å‰çŠ¶æ€**ï¼šå·¥ä½œæµå®ä¾‹å­˜å‚¨åœ¨å†…å­˜ä¸­
- **å½±å“**ï¼šDjango é‡å¯åå·¥ä½œæµå®ä¾‹ä¸¢å¤±
- **è§£å†³æ–¹æ¡ˆ**ï¼šå®ç°æ•°æ®åº“æŒä¹…åŒ–ï¼ˆè§ INTEGRATION_GUIDE.mdï¼‰

### 2. BPMN æµç¨‹è®¾è®¡
- **å½“å‰é—®é¢˜**ï¼šæµç¨‹ç¼ºå°‘ç»“æŸäº‹ä»¶
- **å½±å“**ï¼šå·¥ä½œæµä¸ä¼šå®Œå…¨ç»“æŸï¼ˆçŠ¶æ€ä¿æŒ runningï¼‰
- **è§£å†³æ–¹æ¡ˆ**ï¼šåœ¨å®¡æ‰¹ä»»åŠ¡å®Œæˆæ—¶ç«‹å³æ›´æ–°ä¸šåŠ¡çŠ¶æ€

### 3. å¹¶å‘å¤„ç†
- **å½“å‰çŠ¶æ€**ï¼šå•è¿›ç¨‹å†…å­˜å­˜å‚¨
- **å½±å“**ï¼šå¤šè¿›ç¨‹éƒ¨ç½²æ—¶å·¥ä½œæµå®ä¾‹ä¸å…±äº«
- **è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨æ•°æ®åº“æˆ– Redis å­˜å‚¨å·¥ä½œæµçŠ¶æ€

---

## ğŸ“– ç›¸å…³æ–‡æ¡£

1. **[INTEGRATION_GUIDE.md](INTEGRATION_GUIDE.md)** - å®Œæ•´çš„é›†æˆé…ç½®æŒ‡å—
2. **[QUICK_REFERENCE.md](QUICK_REFERENCE.md)** - å¿«é€Ÿå‚è€ƒå¡ç‰‡
3. **[WORKFLOW_NOTES.md](WORKFLOW_NOTES.md)** - å·¥ä½œæµè¡Œä¸ºè¯´æ˜
4. **[USAGE.md](USAGE.md)** - SpiffWorkflow ä½¿ç”¨æŒ‡å—

---

## âœ… é…ç½®éªŒè¯

è¿è¡Œä»¥ä¸‹å‘½ä»¤éªŒè¯é…ç½®ï¼š

```bash
# 1. æ£€æŸ¥é…ç½®
python check_integration.py

# 2. æµ‹è¯•å·¥ä½œæµ
python test_spiffworkflow.py

# 3. å¯åŠ¨æœåŠ¡
cd leave_system
python manage.py runserver 8888

# 4. æµ‹è¯• API
curl http://127.0.0.1:8888/api/leave/my-requests/?user_email=test@example.com
```

---

## ğŸ‰ é…ç½®å®Œæˆ

æ‰€æœ‰å¿…éœ€é…ç½®å·²å®Œæˆï¼Œç³»ç»Ÿå¯ä»¥æ­£å¸¸è¿è¡Œï¼

- âœ… Django ä¸ SpiffWorkflow æˆåŠŸé›†æˆ
- âœ… æ‰€æœ‰ API ç«¯ç‚¹æ­£å¸¸å·¥ä½œ
- âœ… å·¥ä½œæµå¼•æ“æ­£å¸¸è¿è¡Œ
- âœ… å‰ç«¯ç•Œé¢å¯ç”¨

**ä¸‹ä¸€æ­¥**ï¼š
1. å®ç°å·¥ä½œæµæŒä¹…åŒ–
2. å®Œå–„ BPMN æµç¨‹è®¾è®¡
3. æ·»åŠ æ›´å¤šä¸šåŠ¡åŠŸèƒ½
4. éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
