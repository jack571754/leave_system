<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¯·å‡å®¡æ‰¹ç³»ç»Ÿ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #f5f5f5; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { text-align: center; color: #333; margin-bottom: 30px; }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab { padding: 10px 20px; background: white; border: none; cursor: pointer; border-radius: 5px; }
        .tab.active { background: #1890ff; color: white; }
        .panel { display: none; background: white; padding: 20px; border-radius: 5px; }
        .panel.active { display: block; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, textarea { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        textarea { min-height: 100px; }
        button { padding: 10px 20px; background: #1890ff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #40a9ff; }
        .card { background: white; padding: 15px; margin-bottom: 10px; border-radius: 5px; border-left: 4px solid #1890ff; }
        .status { display: inline-block; padding: 4px 12px; border-radius: 12px; font-size: 12px; }
        .status.pending { background: #fff7e6; color: #fa8c16; }
        .status.approved { background: #f6ffed; color: #52c41a; }
        .status.rejected { background: #fff1f0; color: #f5222d; }
        .actions { margin-top: 10px; display: flex; gap: 10px; }
        .btn-approve { background: #52c41a; }
        .btn-reject { background: #f5222d; }
        .info { color: #666; font-size: 14px; margin-top: 5px; }
        .empty { text-align: center; color: #999; padding: 40px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¢ è¯·å‡å®¡æ‰¹ç³»ç»Ÿ</h1>
        
        <div class="tabs">
            <button class="tab active" onclick="showTab('create')">ğŸ“ ç”³è¯·è¯·å‡</button>
            <button class="tab" onclick="showTab('my')">ğŸ“‹ æˆ‘çš„è¯·å‡</button>
            <button class="tab" onclick="showTab('approve')">âœ… å¾…å®¡æ‰¹</button>
        </div>

        <!-- ç”³è¯·è¯·å‡ -->
        <div id="create" class="panel active">
            <h2>ç”³è¯·è¯·å‡</h2>
            <div class="form-group">
                <label>é‚®ç®±</label>
                <input type="email" id="userEmail" placeholder="your@example.com">
            </div>
            <div class="form-group">
                <label>è¯·å‡åŸå› </label>
                <textarea id="reason" placeholder="è¯·è¾“å…¥è¯·å‡åŸå› ..."></textarea>
            </div>
            <div class="form-group">
                <label>è¯·å‡æ—¶é•¿ï¼ˆå°æ—¶ï¼‰</label>
                <input type="number" id="leaveHours" placeholder="8" min="1">
            </div>
            <button onclick="createLeave()">æäº¤ç”³è¯·</button>
        </div>

        <!-- æˆ‘çš„è¯·å‡ -->
        <div id="my" class="panel">
            <h2>æˆ‘çš„è¯·å‡ç”³è¯·</h2>
            <div class="form-group">
                <label>é‚®ç®±</label>
                <input type="email" id="myEmail" placeholder="your@example.com">
                <button onclick="loadMyRequests()" style="margin-top: 10px;">æŸ¥è¯¢</button>
            </div>
            <div id="myList"></div>
        </div>

        <!-- å¾…å®¡æ‰¹ -->
        <div id="approve" class="panel">
            <h2>å¾…å®¡æ‰¹åˆ—è¡¨</h2>
            <div class="form-group">
                <label>ç”¨æˆ·ID</label>
                <input type="text" id="userId" placeholder="1" value="1">
                <button onclick="loadPendingApprovals()" style="margin-top: 10px;">æŸ¥è¯¢</button>
            </div>
            <div id="approveList"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://127.0.0.1:8888/api';

        function showTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tab).classList.add('active');
        }

        async function createLeave() {
            const userEmail = document.getElementById('userEmail').value;
            const reason = document.getElementById('reason').value;
            const leaveHours = document.getElementById('leaveHours').value;

            if (!userEmail || !reason || !leaveHours) {
                alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/leave/create/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_email: userEmail,
                        reason: reason,
                        leave_hours: parseInt(leaveHours)
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    alert('âœ… è¯·å‡ç”³è¯·æäº¤æˆåŠŸï¼\n\nè¯·å‡ID: ' + data.leave_request_id + '\nå·¥ä½œæµID: ' + data.workflow_instance_id);
                    document.getElementById('reason').value = '';
                    document.getElementById('leaveHours').value = '';
                } else {
                    alert('âŒ æäº¤å¤±è´¥: ' + data.error);
                }
            } catch (error) {
                alert('âŒ è¯·æ±‚å¤±è´¥: ' + error.message);
            }
        }

        async function loadMyRequests() {
            const email = document.getElementById('myEmail').value;
            if (!email) {
                alert('è¯·è¾“å…¥é‚®ç®±');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/leave/my-requests/?user_email=${email}`);
                const data = await response.json();

                const list = document.getElementById('myList');
                
                if (data.requests && data.requests.length > 0) {
                    list.innerHTML = data.requests.map(r => `
                        <div class="card">
                            <div><strong>è¯·å‡åŸå› :</strong> ${r.reason}</div>
                            <div class="info">æ—¶é•¿: ${r.leave_hours}å°æ—¶ | çŠ¶æ€: <span class="status ${r.status}">${r.status_display}</span></div>
                            ${r.approver_name ? `<div class="info">å®¡æ‰¹äºº: ${r.approver_name}</div>` : ''}
                            ${r.approval_comment ? `<div class="info">å®¡æ‰¹æ„è§: ${r.approval_comment}</div>` : ''}
                            <div class="info">ç”³è¯·æ—¶é—´: ${new Date(r.created_at).toLocaleString()}</div>
                        </div>
                    `).join('');
                } else {
                    list.innerHTML = '<div class="empty">æš‚æ— è¯·å‡è®°å½•</div>';
                }
            } catch (error) {
                alert('âŒ æŸ¥è¯¢å¤±è´¥: ' + error.message);
            }
        }

        async function loadPendingApprovals() {
            const userId = document.getElementById('userId').value;
            if (!userId) {
                alert('è¯·è¾“å…¥ç”¨æˆ·ID');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/leave/pending-approvals/?user_id=${userId}`);
                const data = await response.json();

                const list = document.getElementById('approveList');
                
                if (data.pending_approvals && data.pending_approvals.length > 0) {
                    list.innerHTML = data.pending_approvals.map(item => {
                        const r = item.leave_request;
                        return `
                            <div class="card">
                                <div><strong>ç”³è¯·äºº:</strong> ${r.staff_full_name || r.user_email}</div>
                                <div class="info">éƒ¨é—¨: ${r.staff_dept || 'æœªçŸ¥'}</div>
                                <div><strong>è¯·å‡åŸå› :</strong> ${r.reason}</div>
                                <div class="info">æ—¶é•¿: ${r.leave_hours}å°æ—¶</div>
                                <div class="info">ç”³è¯·æ—¶é—´: ${new Date(r.created_at).toLocaleString()}</div>
                                <div class="actions">
                                    <button class="btn-approve" onclick="approve('${item.task_id}', ${item.process_instance_id}, ${r.id}, true)">âœ… æ‰¹å‡†</button>
                                    <button class="btn-reject" onclick="approve('${item.task_id}', ${item.process_instance_id}, ${r.id}, false)">âŒ æ‹’ç»</button>
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    list.innerHTML = '<div class="empty">æš‚æ— å¾…å®¡æ‰¹</div>';
                }
            } catch (error) {
                alert('âŒ æŸ¥è¯¢å¤±è´¥: ' + error.message);
            }
        }

        async function approve(taskId, processInstanceId, leaveRequestId, approved) {
            const comment = prompt(approved ? 'è¯·è¾“å…¥æ‰¹å‡†æ„è§:' : 'è¯·è¾“å…¥æ‹’ç»åŸå› :');
            if (comment === null) return;

            try {
                const response = await fetch(`${API_BASE}/leave/approve/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        task_id: taskId,
                        process_instance_id: processInstanceId,
                        leave_request_id: leaveRequestId,
                        approved: approved,
                        comment: comment
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    alert('âœ… å®¡æ‰¹å®Œæˆï¼');
                    loadPendingApprovals();
                } else {
                    alert('âŒ å®¡æ‰¹å¤±è´¥: ' + data.error);
                }
            } catch (error) {
                alert('âŒ è¯·æ±‚å¤±è´¥: ' + error.message);
            }
        }
    </script>
</body>
</html>
