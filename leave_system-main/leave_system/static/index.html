<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¯·å‡å®¡æ‰¹ç³»ç»Ÿ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        .header {
            background: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        h1 { 
            text-align: center; 
            color: #333; 
            margin-bottom: 10px;
            font-size: 32px;
        }
        .subtitle {
            text-align: center;
            color: #666;
            font-size: 14px;
        }
        .status-bar {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .status-item {
            text-align: center;
        }
        .status-item .label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }
        .status-item .value {
            font-size: 24px;
            font-weight: bold;
            color: #1890ff;
        }
        .tabs { 
            display: flex; 
            gap: 10px; 
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .tab { 
            padding: 12px 24px; 
            background: white; 
            border: none; 
            cursor: pointer; 
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .tab:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
        .tab.active { background: #1890ff; color: white; }
        .panel { 
            display: none; 
            background: white; 
            padding: 30px; 
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .panel.active { display: block; }
        .panel h2 {
            margin-bottom: 20px;
            color: #333;
            border-bottom: 2px solid #1890ff;
            padding-bottom: 10px;
        }
        .form-group { margin-bottom: 20px; }
        label { 
            display: block; 
            margin-bottom: 8px; 
            font-weight: 600;
            color: #333;
        }
        input, textarea, select { 
            width: 100%; 
            padding: 12px; 
            border: 2px solid #e8e8e8; 
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #1890ff;
        }
        textarea { min-height: 120px; resize: vertical; }
        button { 
            padding: 12px 24px; 
            background: #1890ff; 
            color: white; 
            border: none; 
            border-radius: 6px; 
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
        }
        button:hover { background: #40a9ff; transform: translateY(-2px); }
        button:active { transform: translateY(0); }
        button:disabled { background: #d9d9d9; cursor: not-allowed; transform: none; }
        .card { 
            background: #fafafa; 
            padding: 20px; 
            margin-bottom: 15px; 
            border-radius: 8px; 
            border-left: 4px solid #1890ff;
            transition: all 0.3s;
        }
        .card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .status { 
            display: inline-block; 
            padding: 6px 14px; 
            border-radius: 16px; 
            font-size: 13px;
            font-weight: 600;
        }
        .status.draft { background: #e6f7ff; color: #1890ff; }
        .status.pending { background: #fff7e6; color: #fa8c16; }
        .status.approved { background: #f6ffed; color: #52c41a; }
        .status.rejected { background: #fff1f0; color: #f5222d; }
        .actions { 
            margin-top: 15px; 
            display: flex; 
            gap: 10px;
            flex-wrap: wrap;
        }
        .btn-approve { background: #52c41a; }
        .btn-approve:hover { background: #73d13d; }
        .btn-reject { background: #f5222d; }
        .btn-reject:hover { background: #ff4d4f; }
        .btn-secondary { background: #8c8c8c; }
        .btn-secondary:hover { background: #a6a6a6; }
        .info { 
            color: #666; 
            font-size: 14px; 
            margin-top: 8px;
            line-height: 1.6;
        }
        .info strong { color: #333; }
        .empty { 
            text-align: center; 
            color: #999; 
            padding: 60px 20px;
            font-size: 16px;
        }
        .empty::before {
            content: "ğŸ“­";
            display: block;
            font-size: 48px;
            margin-bottom: 10px;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #1890ff;
        }
        .loading::after {
            content: "åŠ è½½ä¸­...";
            animation: loading 1.5s infinite;
        }
        @keyframes loading {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }
        .success-message {
            background: #f6ffed;
            border: 1px solid #b7eb8f;
            color: #52c41a;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }
        .error-message {
            background: #fff1f0;
            border: 1px solid #ffa39e;
            color: #f5222d;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }
        .quick-test {
            background: #fff7e6;
            border: 2px dashed #ffa940;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .quick-test h3 {
            color: #fa8c16;
            margin-bottom: 10px;
        }
        .quick-test button {
            background: #fa8c16;
            margin-right: 10px;
            margin-top: 10px;
        }
        .quick-test button:hover {
            background: #ffa940;
        }
        .badge {
            display: inline-block;
            padding: 2px 8px;
            background: #1890ff;
            color: white;
            border-radius: 10px;
            font-size: 12px;
            margin-left: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¢ è¯·å‡å®¡æ‰¹ç³»ç»Ÿ</h1>
            <div class="subtitle">Django + SpiffWorkflow æµ‹è¯•å¹³å°</div>
            <div class="status-bar">
                <div class="status-item">
                    <div class="label">æ€»ç”³è¯·æ•°</div>
                    <div class="value" id="totalCount">0</div>
                </div>
                <div class="status-item">
                    <div class="label">å¾…å®¡æ‰¹</div>
                    <div class="value" id="pendingCount">0</div>
                </div>
                <div class="status-item">
                    <div class="label">å·²æ‰¹å‡†</div>
                    <div class="value" id="approvedCount">0</div>
                </div>
                <div class="status-item">
                    <div class="label">å·²æ‹’ç»</div>
                    <div class="value" id="rejectedCount">0</div>
                </div>
            </div>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="showTab('create')">ğŸ“ ç”³è¯·è¯·å‡</button>
            <button class="tab" onclick="showTab('my')">ğŸ“‹ æˆ‘çš„è¯·å‡</button>
            <button class="tab" onclick="showTab('approve')">âœ… å¾…å®¡æ‰¹</button>
            <button class="tab" onclick="showTab('test')">ğŸ§ª å¿«é€Ÿæµ‹è¯•</button>
        </div>

        <!-- ç”³è¯·è¯·å‡ -->
        <div id="create" class="panel active">
            <h2>ğŸ“ ç”³è¯·è¯·å‡</h2>
            <div id="createMessage"></div>
            <div class="form-group">
                <label>ç”³è¯·äººé‚®ç®± *</label>
                <input type="email" id="userEmail" placeholder="test@example.com" value="test@example.com">
            </div>
            <div class="form-group">
                <label>è¯·å‡åŸå›  *</label>
                <textarea id="reason" placeholder="è¯·è¾“å…¥è¯·å‡åŸå› ...">æµ‹è¯•è¯·å‡ç”³è¯·</textarea>
            </div>
            <div class="form-group">
                <label>è¯·å‡æ—¶é•¿ï¼ˆå°æ—¶ï¼‰*</label>
                <input type="number" id="leaveHours" placeholder="8" min="1" value="8">
                <div class="info">ğŸ’¡ æç¤ºï¼šæ‰€æœ‰æ—¶é•¿éƒ½èµ°ç›¸åŒçš„å®¡æ‰¹æµç¨‹</div>
            </div>
            <button onclick="createLeave()" id="createBtn">ğŸš€ æäº¤ç”³è¯·</button>
        </div>

        <!-- æˆ‘çš„è¯·å‡ -->
        <div id="my" class="panel">
            <h2>ğŸ“‹ æˆ‘çš„è¯·å‡ç”³è¯·</h2>
            <div class="form-group">
                <label>ç”³è¯·äººé‚®ç®±</label>
                <input type="email" id="myEmail" placeholder="test@example.com" value="test@example.com">
                <button onclick="loadMyRequests()" style="margin-top: 10px;">ğŸ” æŸ¥è¯¢æˆ‘çš„è¯·å‡</button>
            </div>
            <div id="myList"></div>
        </div>

        <!-- å¾…å®¡æ‰¹ -->
        <div id="approve" class="panel">
            <h2>âœ… å¾…å®¡æ‰¹åˆ—è¡¨</h2>
            <div class="form-group">
                <label>å®¡æ‰¹äººID</label>
                <input type="text" id="userId" placeholder="admin" value="admin">
                <div class="info">ğŸ’¡ æç¤ºï¼šé»˜è®¤å®¡æ‰¹äººä¸º admin</div>
                <button onclick="loadPendingApprovals()" style="margin-top: 10px;">ğŸ” æŸ¥è¯¢å¾…å®¡æ‰¹</button>
            </div>
            <div id="approveList"></div>
        </div>

        <!-- å¿«é€Ÿæµ‹è¯• -->
        <div id="test" class="panel">
            <h2>ğŸ§ª å¿«é€Ÿæµ‹è¯•</h2>
            <div class="quick-test">
                <h3>ğŸ¯ ä¸€é”®æµ‹è¯•å®Œæ•´æµç¨‹</h3>
                <p>è‡ªåŠ¨å®Œæˆï¼šåˆ›å»ºè¯·å‡ â†’ æŸ¥è¯¢å¾…å®¡æ‰¹ â†’ æäº¤å®¡æ‰¹ â†’ éªŒè¯çŠ¶æ€æ›´æ–°</p>
                <button onclick="runQuickTest()">â–¶ï¸ è¿è¡Œå®Œæ•´æµ‹è¯•</button>
                <button onclick="clearTestData()" class="btn-secondary">ğŸ—‘ï¸ æ¸…ç†æµ‹è¯•æ•°æ®</button>
            </div>
            
            <div id="testLog" style="margin-top: 20px;"></div>
            
            <div style="margin-top: 30px;">
                <h3>ğŸ“Š æµ‹è¯•ç»Ÿè®¡</h3>
                <div class="card">
                    <div class="info">
                        <strong>Django æœåŠ¡ï¼š</strong> <span id="djangoStatus">æ£€æŸ¥ä¸­...</span><br>
                        <strong>æœ€åæµ‹è¯•æ—¶é—´ï¼š</strong> <span id="lastTestTime">æœªæµ‹è¯•</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://127.0.0.1:8888/api';
        let testResults = [];

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥æœåŠ¡çŠ¶æ€
        window.onload = function() {
            checkServices();
            updateStats();
        };

        function showTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tab).classList.add('active');
            
            // åˆ‡æ¢åˆ°ç›¸åº”æ ‡ç­¾æ—¶è‡ªåŠ¨åŠ è½½æ•°æ®
            if (tab === 'my') loadMyRequests();
            if (tab === 'approve') loadPendingApprovals();
        }

        async function checkServices() {
            // æ£€æŸ¥ Django
            try {
                await fetch(`${API_BASE}/leave/my-requests/?user_email=test@example.com`);
                document.getElementById('djangoStatus').innerHTML = '<span style="color: #52c41a;">âœ… æ­£å¸¸</span>';
            } catch (e) {
                document.getElementById('djangoStatus').innerHTML = '<span style="color: #f5222d;">âŒ æ— æ³•è¿æ¥</span>';
            }
        }

        async function updateStats() {
            try {
                const response = await fetch(`${API_BASE}/leave/my-requests/?user_email=test@example.com`);
                const data = await response.json();
                
                if (data.requests) {
                    const total = data.requests.length;
                    const pending = data.requests.filter(r => r.status === 'pending').length;
                    const approved = data.requests.filter(r => r.status === 'approved').length;
                    const rejected = data.requests.filter(r => r.status === 'rejected').length;
                    
                    document.getElementById('totalCount').textContent = total;
                    document.getElementById('pendingCount').textContent = pending;
                    document.getElementById('approvedCount').textContent = approved;
                    document.getElementById('rejectedCount').textContent = rejected;
                }
            } catch (e) {
                console.error('æ›´æ–°ç»Ÿè®¡å¤±è´¥:', e);
            }
        }

        function showMessage(elementId, message, type = 'success') {
            const el = document.getElementById(elementId);
            el.innerHTML = `<div class="${type}-message">${message}</div>`;
            setTimeout(() => el.innerHTML = '', 5000);
        }

        async function createLeave() {
            const btn = document.getElementById('createBtn');
            btn.disabled = true;
            btn.textContent = 'æäº¤ä¸­...';
            
            const userEmail = document.getElementById('userEmail').value;
            const reason = document.getElementById('reason').value;
            const leaveHours = document.getElementById('leaveHours').value;

            if (!userEmail || !reason || !leaveHours) {
                showMessage('createMessage', 'âŒ è¯·å¡«å†™å®Œæ•´ä¿¡æ¯', 'error');
                btn.disabled = false;
                btn.textContent = 'ğŸš€ æäº¤ç”³è¯·';
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/leave/create/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_email: userEmail,
                        reason: reason,
                        leave_hours: parseInt(leaveHours)
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    showMessage('createMessage', 
                        `âœ… è¯·å‡ç”³è¯·æäº¤æˆåŠŸï¼<br>
                        <strong>ç”³è¯·ID:</strong> ${data.leave_request_id}<br>
                        <strong>æµç¨‹å®ä¾‹ID:</strong> ${data.process_instance_id}<br>
                        <strong>çŠ¶æ€:</strong> ${data.status}`, 
                        'success'
                    );
                    updateStats();
                } else {
                    showMessage('createMessage', `âŒ æäº¤å¤±è´¥: ${data.error}`, 'error');
                }
            } catch (error) {
                showMessage('createMessage', `âŒ è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'ğŸš€ æäº¤ç”³è¯·';
            }
        }

        async function loadMyRequests() {
            const email = document.getElementById('myEmail').value;
            if (!email) {
                showMessage('myList', 'âŒ è¯·è¾“å…¥é‚®ç®±', 'error');
                return;
            }

            document.getElementById('myList').innerHTML = '<div class="loading"></div>';

            try {
                const response = await fetch(`${API_BASE}/leave/my-requests/?user_email=${email}`);
                const data = await response.json();

                const list = document.getElementById('myList');
                
                if (data.requests && data.requests.length > 0) {
                    list.innerHTML = data.requests.map(r => `
                        <div class="card">
                            <div class="card-header">
                                <strong>ID: ${r.id}</strong>
                                <span class="status ${r.status}">${r.status_display}</span>
                            </div>
                            <div><strong>è¯·å‡åŸå› :</strong> ${r.reason}</div>
                            <div class="info">
                                <strong>æ—¶é•¿:</strong> ${r.leave_hours}å°æ—¶ | 
                                <strong>æµç¨‹ID:</strong> ${r.process_instance_id || 'æœªå¯åŠ¨'}
                            </div>
                            ${r.approver_name ? `<div class="info"><strong>å®¡æ‰¹äºº:</strong> ${r.approver_name}</div>` : ''}
                            ${r.approval_comment ? `<div class="info"><strong>å®¡æ‰¹æ„è§:</strong> ${r.approval_comment}</div>` : ''}
                            <div class="info">
                                <strong>ç”³è¯·æ—¶é—´:</strong> ${new Date(r.created_at).toLocaleString('zh-CN')}
                            </div>
                            ${r.submitted_at ? `<div class="info"><strong>æäº¤æ—¶é—´:</strong> ${new Date(r.submitted_at).toLocaleString('zh-CN')}</div>` : ''}
                        </div>
                    `).join('');
                    updateStats();
                } else {
                    list.innerHTML = '<div class="empty">æš‚æ— è¯·å‡è®°å½•</div>';
                }
            } catch (error) {
                document.getElementById('myList').innerHTML = `<div class="error-message">âŒ æŸ¥è¯¢å¤±è´¥: ${error.message}</div>`;
            }
        }

        async function loadPendingApprovals() {
            const userId = document.getElementById('userId').value;
            if (!userId) {
                showMessage('approveList', 'âŒ è¯·è¾“å…¥ç”¨æˆ·ID', 'error');
                return;
            }

            document.getElementById('approveList').innerHTML = '<div class="loading"></div>';

            try {
                const response = await fetch(`${API_BASE}/leave/pending-approvals/?user_id=${userId}`);
                const data = await response.json();

                const list = document.getElementById('approveList');
                
                if (data.pending_approvals && data.pending_approvals.length > 0) {
                    list.innerHTML = data.pending_approvals.map(item => {
                        const r = item.leave_request;
                        return `
                            <div class="card">
                                <div class="card-header">
                                    <strong>ä»»åŠ¡: ${item.task_name || 'å®¡æ‰¹ä»»åŠ¡'}</strong>
                                    <span class="badge">å¾…å¤„ç†</span>
                                </div>
                                <div><strong>ç”³è¯·äºº:</strong> ${r.staff_full_name || r.user_email}</div>
                                <div class="info"><strong>éƒ¨é—¨:</strong> ${r.staff_dept || 'æœªçŸ¥'}</div>
                                <div><strong>è¯·å‡åŸå› :</strong> ${r.reason}</div>
                                <div class="info">
                                    <strong>æ—¶é•¿:</strong> ${r.leave_hours}å°æ—¶ | 
                                    <strong>ç”³è¯·ID:</strong> ${r.id}
                                </div>
                                <div class="info">
                                    <strong>ç”³è¯·æ—¶é—´:</strong> ${new Date(r.created_at).toLocaleString('zh-CN')}
                                </div>
                                <div class="info">
                                    <strong>ä»»åŠ¡GUID:</strong> ${item.task_guid}
                                </div>
                                <div class="actions">
                                    <button class="btn-approve" onclick="approve('${item.task_guid}', '${item.process_instance_id}', ${r.id}, true)">
                                        âœ… æ‰¹å‡†
                                    </button>
                                    <button class="btn-reject" onclick="approve('${item.task_guid}', '${item.process_instance_id}', ${r.id}, false)">
                                        âŒ æ‹’ç»
                                    </button>
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    list.innerHTML = '<div class="empty">æš‚æ— å¾…å®¡æ‰¹ä»»åŠ¡</div>';
                }
            } catch (error) {
                document.getElementById('approveList').innerHTML = `<div class="error-message">âŒ æŸ¥è¯¢å¤±è´¥: ${error.message}</div>`;
            }
        }

        async function approve(taskGuid, processInstanceId, leaveRequestId, approved) {
            const comment = prompt(approved ? 'è¯·è¾“å…¥æ‰¹å‡†æ„è§ï¼ˆå¯é€‰ï¼‰:' : 'è¯·è¾“å…¥æ‹’ç»åŸå› :');
            if (comment === null) return;

            try {
                const response = await fetch(`${API_BASE}/leave/approve/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        task_guid: taskGuid,
                        process_instance_id: processInstanceId,
                        leave_request_id: leaveRequestId,
                        approved: approved,
                        comment: comment || (approved ? 'åŒæ„' : 'ä¸åŒæ„')
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    alert('âœ… å®¡æ‰¹å®Œæˆï¼\n\nè¯·ç­‰å¾…5-10ç§’åæŸ¥çœ‹çŠ¶æ€æ›´æ–°ã€‚');
                    setTimeout(() => {
                        loadPendingApprovals();
                        updateStats();
                    }, 2000);
                } else {
                    alert('âŒ å®¡æ‰¹å¤±è´¥: ' + data.error);
                }
            } catch (error) {
                alert('âŒ è¯·æ±‚å¤±è´¥: ' + error.message);
            }
        }

        // å¿«é€Ÿæµ‹è¯•åŠŸèƒ½
        async function runQuickTest() {
            const logEl = document.getElementById('testLog');
            logEl.innerHTML = '<div class="card"><h3>ğŸ§ª æµ‹è¯•è¿›è¡Œä¸­...</h3></div>';
            testResults = [];
            
            function log(message, type = 'info') {
                const color = type === 'success' ? '#52c41a' : type === 'error' ? '#f5222d' : '#1890ff';
                testResults.push(`<div style="color: ${color}; margin: 5px 0;">${message}</div>`);
                logEl.innerHTML = '<div class="card">' + testResults.join('') + '</div>';
            }

            try {
                // æ­¥éª¤ 1: åˆ›å»ºè¯·å‡
                log('ğŸ“ [1/5] åˆ›å»ºè¯·å‡ç”³è¯·...');
                const createRes = await fetch(`${API_BASE}/leave/create/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_email: 'test@example.com',
                        reason: 'å¿«é€Ÿæµ‹è¯•-' + new Date().toLocaleTimeString(),
                        leave_hours: 8
                    })
                });
                const createData = await createRes.json();
                
                if (!createData.success) throw new Error('åˆ›å»ºå¤±è´¥: ' + createData.error);
                
                log(`âœ… åˆ›å»ºæˆåŠŸï¼ç”³è¯·ID: ${createData.leave_request_id}, æµç¨‹ID: ${createData.process_instance_id}`, 'success');
                
                // æ­¥éª¤ 2: ç­‰å¾…æµç¨‹å¯åŠ¨
                log('â³ [2/5] ç­‰å¾…æµç¨‹å¯åŠ¨...');
                await new Promise(resolve => setTimeout(resolve, 2000));
                log('âœ… ç­‰å¾…å®Œæˆ', 'success');
                
                // æ­¥éª¤ 3: æŸ¥è¯¢å¾…å®¡æ‰¹
                log('ğŸ” [3/5] æŸ¥è¯¢å¾…å®¡æ‰¹ä»»åŠ¡...');
                const pendingRes = await fetch(`${API_BASE}/leave/pending-approvals/?user_id=admin`);
                const pendingData = await pendingRes.json();
                
                const task = pendingData.pending_approvals?.find(t => t.leave_request.id === createData.leave_request_id);
                if (!task) throw new Error('æœªæ‰¾åˆ°å¾…å®¡æ‰¹ä»»åŠ¡');
                
                log(`âœ… æ‰¾åˆ°ä»»åŠ¡ï¼ä»»åŠ¡GUID: ${task.task_guid}`, 'success');
                
                // æ­¥éª¤ 4: æäº¤å®¡æ‰¹
                log('âœ… [4/5] æäº¤å®¡æ‰¹ï¼ˆæ‰¹å‡†ï¼‰...');
                const approveRes = await fetch(`${API_BASE}/leave/approve/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        task_guid: task.task_guid,
                        process_instance_id: task.process_instance_id,
                        leave_request_id: createData.leave_request_id,
                        approved: true,
                        comment: 'è‡ªåŠ¨æµ‹è¯•-æ‰¹å‡†'
                    })
                });
                const approveData = await approveRes.json();
                
                if (!approveData.success) throw new Error('å®¡æ‰¹å¤±è´¥: ' + approveData.error);
                
                log('âœ… å®¡æ‰¹æäº¤æˆåŠŸï¼', 'success');
                
                // æ­¥éª¤ 5: éªŒè¯çŠ¶æ€
                log('â³ [5/5] éªŒè¯çŠ¶æ€æ›´æ–°...');
                await new Promise(resolve => setTimeout(resolve, 5000));
                
                const myRes = await fetch(`${API_BASE}/leave/my-requests/?user_email=test@example.com`);
                const myData = await myRes.json();
                const updated = myData.requests?.find(r => r.id === createData.leave_request_id);
                
                if (updated && updated.status === 'approved') {
                    log('âœ… çŠ¶æ€å·²æ›´æ–°ä¸º: ' + updated.status_display, 'success');
                    log('âœ… å®¡æ‰¹æ„è§: ' + updated.approval_comment, 'success');
                    log('', 'info');
                    log('ğŸ‰ æµ‹è¯•å®Œæˆï¼æ‰€æœ‰æ­¥éª¤æˆåŠŸï¼', 'success');
                    document.getElementById('lastTestTime').textContent = new Date().toLocaleString('zh-CN');
                } else {
                    log('âš ï¸ çŠ¶æ€æœªæ›´æ–°ï¼Œå½“å‰çŠ¶æ€: ' + (updated?.status || 'æœªçŸ¥'), 'error');
                    log('ğŸ’¡ å¯èƒ½éœ€è¦æ›´å¤šæ—¶é—´ç­‰å¾…å›è°ƒï¼Œè¯·æ‰‹åŠ¨æ£€æŸ¥', 'info');
                }
                
                updateStats();
                
            } catch (error) {
                log('âŒ æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
            }
        }

        async function clearTestData() {
            if (!confirm('ç¡®å®šè¦æ¸…ç†æ‰€æœ‰æµ‹è¯•æ•°æ®å—ï¼Ÿ')) return;
            
            alert('âš ï¸ æ•°æ®æ¸…ç†åŠŸèƒ½éœ€è¦åœ¨ Django shell ä¸­æ‰§è¡Œï¼š\n\ncd leave_system\npython manage.py shell\n\nfrom leave_api.models import LeaveRequest\nLeaveRequest.objects.all().delete()');
        }
    </script>
</body>
</html>
