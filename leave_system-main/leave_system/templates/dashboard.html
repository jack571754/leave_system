<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®¡æ‰¹æµç¨‹ç®¡ç†ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .header h1 {
            color: #333;
            font-size: 32px;
            margin-bottom: 10px;
        }
        
        .header p {
            color: #666;
            font-size: 16px;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-card h3 {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
            text-transform: uppercase;
        }
        
        .stat-card .number {
            font-size: 36px;
            font-weight: bold;
            color: #667eea;
        }
        
        .tabs {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .tab-buttons {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }
        
        .tab-button {
            flex: 1;
            padding: 20px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            color: #666;
            transition: all 0.3s;
        }
        
        .tab-button.active {
            background: white;
            color: #667eea;
            border-bottom: 3px solid #667eea;
        }
        
        .tab-content {
            display: none;
            padding: 30px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        
        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-success {
            background: #10b981;
            color: white;
        }
        
        .btn-danger {
            background: #ef4444;
            color: white;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .table-container {
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        table th,
        table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }
        
        table th {
            background: #f8f9fa;
            color: #333;
            font-weight: 600;
        }
        
        table tr:hover {
            background: #f8f9fa;
        }
        
        .badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .badge-pending {
            background: #fef3c7;
            color: #92400e;
        }
        
        .badge-approved {
            background: #d1fae5;
            color: #065f46;
        }
        
        .badge-rejected {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
        }
        
        .btn-sm {
            padding: 6px 15px;
            font-size: 14px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border-left: 4px solid #10b981;
        }
        
        .alert-error {
            background: #fee2e2;
            color: #991b1b;
            border-left: 4px solid #ef4444;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            margin-bottom: 20px;
        }
        
        .modal-header h2 {
            color: #333;
        }
        
        .close-modal {
            float: right;
            font-size: 28px;
            font-weight: bold;
            color: #999;
            cursor: pointer;
        }
        
        .close-modal:hover {
            color: #333;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å¤´éƒ¨ -->
        <div class="header">
            <h1>ğŸ¯ å®¡æ‰¹æµç¨‹ç®¡ç†ç³»ç»Ÿ</h1>
            <p>ç»Ÿä¸€ç®¡ç†è¯·å‡ç”³è¯·ã€å¯†ç ä¿®æ”¹ç­‰å®¡æ‰¹æµç¨‹</p>
        </div>
        
        <!-- ç»Ÿè®¡å¡ç‰‡ -->
        <div class="stats">
            <div class="stat-card">
                <h3>å¾…å®¡æ‰¹</h3>
                <div class="number" id="stat-pending">-</div>
            </div>
            <div class="stat-card">
                <h3>å·²æ‰¹å‡†</h3>
                <div class="number" id="stat-approved">-</div>
            </div>
            <div class="stat-card">
                <h3>å·²æ‹’ç»</h3>
                <div class="number" id="stat-rejected">-</div>
            </div>
            <div class="stat-card">
                <h3>æ€»ç”³è¯·</h3>
                <div class="number" id="stat-total">-</div>
            </div>
        </div>

        
        <!-- æ ‡ç­¾é¡µ -->
        <div class="tabs">
            <div class="tab-buttons">
                <button class="tab-button active" onclick="switchTab('create')">ğŸ“ åˆ›å»ºç”³è¯·</button>
                <button class="tab-button" onclick="switchTab('my-requests')">ğŸ“‹ æˆ‘çš„ç”³è¯·</button>
                <button class="tab-button" onclick="switchTab('pending')">â³ å¾…å®¡æ‰¹</button>
                <button class="tab-button" onclick="switchTab('all')">ğŸ“Š æ‰€æœ‰ç”³è¯·</button>
                <button class="tab-button" onclick="switchTab('bpmn')">ğŸ¨ BPMN é…ç½®</button>
                <button class="tab-button" onclick="switchTab('api')">ğŸ”Œ API æ¥å£</button>
                <button class="tab-button" onclick="switchTab('process')">âš™ï¸ æµç¨‹è¯´æ˜</button>
                <button class="tab-button" onclick="switchTab('docs')">ğŸ“š æ–‡æ¡£</button>
            </div>
            
            <!-- åˆ›å»ºç”³è¯· -->
            <div id="tab-create" class="tab-content active">
                <h2 style="margin-bottom: 20px;">åˆ›å»ºæ–°ç”³è¯·</h2>
                
                <div class="form-group">
                    <label>ç”³è¯·ç±»å‹</label>
                    <select id="request-type" onchange="updateFormFields()">
                        <option value="leave">è¯·å‡ç”³è¯·</option>
                        <option value="password_change">å¯†ç ä¿®æ”¹</option>
                    </select>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>ç”³è¯·äººé‚®ç®± *</label>
                        <input type="email" id="user-email" placeholder="user@company.com" required>
                    </div>
                    <div class="form-group">
                        <label>ç”³è¯·äººå§“å *</label>
                        <input type="text" id="staff-name" placeholder="å¼ ä¸‰" required>
                    </div>
                    <div class="form-group">
                        <label>æ‰€å±éƒ¨é—¨ *</label>
                        <input type="text" id="staff-dept" placeholder="æŠ€æœ¯éƒ¨" required>
                    </div>
                </div>
                
                <!-- è¯·å‡ç”³è¯·å­—æ®µ -->
                <div id="leave-fields">
                    <div class="form-row">
                        <div class="form-group">
                            <label>è¯·å‡ç±»å‹</label>
                            <select id="leave-type">
                                <option value="annual">å¹´å‡</option>
                                <option value="sick">ç—…å‡</option>
                                <option value="personal">äº‹å‡</option>
                                <option value="marriage">å©šå‡</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>è¯·å‡æ—¶é•¿ï¼ˆå°æ—¶ï¼‰*</label>
                            <input type="number" id="leave-hours" placeholder="8" min="1">
                        </div>
                        <div class="form-group">
                            <label>è¯·å‡å¤©æ•°</label>
                            <input type="number" id="duration" placeholder="1" step="0.5" min="0.5">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>å¼€å§‹æ—¥æœŸ</label>
                            <input type="date" id="start-date">
                        </div>
                        <div class="form-group">
                            <label>ç»“æŸæ—¥æœŸ</label>
                            <input type="date" id="end-date">
                        </div>
                    </div>
                </div>
                
                <!-- å¯†ç ä¿®æ”¹å­—æ®µ -->
                <div id="password-fields" style="display: none;">
                    <div class="form-row">
                        <div class="form-group">
                            <label>å¯†ç ç±»å‹ *</label>
                            <select id="password-type">
                                <option value="normal">æ™®é€šå¯†ç </option>
                                <option value="important">é‡è¦å¯†ç </option>
                                <option value="critical">å…³é”®å¯†ç </option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ç”¨æˆ·çº§åˆ« *</label>
                            <select id="user-level">
                                <option value="normal">æ™®é€šç”¨æˆ·</option>
                                <option value="admin">ç®¡ç†å‘˜</option>
                                <option value="super_admin">è¶…çº§ç®¡ç†å‘˜</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ç³»ç»Ÿåç§° *</label>
                            <input type="text" id="system-name" placeholder="ä¼ä¸šé‚®ç®±ç³»ç»Ÿ">
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>ç”³è¯·åŸå›  *</label>
                    <textarea id="reason" rows="4" placeholder="è¯·è¯¦ç»†è¯´æ˜ç”³è¯·åŸå› ..." required></textarea>
                </div>
                
                <div id="create-alert"></div>
                
                <button class="btn btn-primary" onclick="createRequest()">
                    ğŸš€ æäº¤ç”³è¯·
                </button>
            </div>
            
            <!-- æˆ‘çš„ç”³è¯· -->
            <div id="tab-my-requests" class="tab-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>æˆ‘çš„ç”³è¯·</h2>
                    <div>
                        <input type="email" id="my-email" placeholder="è¾“å…¥é‚®ç®±æŸ¥è¯¢" style="padding: 10px; border: 2px solid #e9ecef; border-radius: 8px; margin-right: 10px;">
                        <button class="btn btn-primary" onclick="loadMyRequests()">ğŸ” æŸ¥è¯¢</button>
                    </div>
                </div>
                <div id="my-requests-content" class="loading">è¯·è¾“å…¥é‚®ç®±å¹¶ç‚¹å‡»æŸ¥è¯¢</div>
            </div>
            
            <!-- å¾…å®¡æ‰¹ -->
            <div id="tab-pending" class="tab-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>å¾…å®¡æ‰¹ä»»åŠ¡</h2>
                    <div>
                        <input type="email" id="approver-email" placeholder="å®¡æ‰¹äººé‚®ç®±" style="padding: 10px; border: 2px solid #e9ecef; border-radius: 8px; margin-right: 10px;">
                        <button class="btn btn-primary" onclick="loadPendingApprovals()">ğŸ” æŸ¥è¯¢</button>
                    </div>
                </div>
                <div id="pending-content" class="loading">è¯·è¾“å…¥å®¡æ‰¹äººé‚®ç®±å¹¶ç‚¹å‡»æŸ¥è¯¢</div>
            </div>
            
            <!-- æ‰€æœ‰ç”³è¯· -->
            <div id="tab-all" class="tab-content">
                <h2 style="margin-bottom: 20px;">æ‰€æœ‰ç”³è¯·è®°å½•</h2>
                <div id="all-requests-content" class="loading">åŠ è½½ä¸­...</div>
            </div>
            
            <!-- BPMN é…ç½® -->
            <div id="tab-bpmn" class="tab-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>ğŸ¨ BPMN æµç¨‹é…ç½®</h2>
                    <div>
                        <button class="btn btn-success" onclick="window.open('/bpmn-designer/', '_blank')" style="margin-right: 10px;">
                            ğŸ¨ æ‰“å¼€ BPMN è®¾è®¡å™¨
                        </button>
                        <button class="btn btn-primary" onclick="loadBpmnProcesses()">ğŸ”„ åˆ·æ–°åˆ—è¡¨</button>
                    </div>
                </div>
                
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px; border-radius: 10px; margin-bottom: 20px; color: white;">
                    <h3 style="margin-bottom: 15px;">âœ¨ ä¸“ä¸š BPMN è®¾è®¡å™¨</h3>
                    <p style="margin-bottom: 20px; opacity: 0.9;">
                        ä½¿ç”¨åŠŸèƒ½å¼ºå¤§çš„å¯è§†åŒ–è®¾è®¡å™¨åˆ›å»ºå’Œç¼–è¾‘ BPMN æµç¨‹å›¾ï¼Œæ”¯æŒï¼š
                    </p>
                    <ul style="margin-left: 20px; line-height: 2; opacity: 0.9;">
                        <li>ğŸ¯ æ‹–æ‹½å¼æµç¨‹è®¾è®¡</li>
                        <li>ğŸ“ ä»£ç é«˜äº®çš„å±æ€§ç¼–è¾‘å™¨</li>
                        <li>ğŸ”§ Python è„šæœ¬ç¼–è¾‘ï¼ˆå‰ç½®/åç½®è„šæœ¬ï¼‰</li>
                        <li>ğŸ“‹ è¡¨å•é…ç½®ï¼ˆJSON Schemaï¼‰</li>
                        <li>ğŸ”€ æ¡ä»¶è¡¨è¾¾å¼ç¼–è¾‘</li>
                        <li>ğŸ’¾ å¯¼å‡º BPMN/SVG æ–‡ä»¶</li>
                    </ul>
                    <button class="btn btn-primary" onclick="window.open('/bpmn-designer/', '_blank')" style="margin-top: 20px; background: white; color: #667eea; font-weight: bold;">
                        ğŸš€ ç«‹å³æ‰“å¼€è®¾è®¡å™¨
                    </button>
                </div>
                
                <div style="display: grid; grid-template-columns: 300px 1fr; gap: 20px;">
                    <!-- å·¦ä¾§ï¼šæµç¨‹åˆ—è¡¨ -->
                    <div style="background: white; border: 2px solid #e9ecef; border-radius: 8px; padding: 20px; height: fit-content;">
                        <h3 style="margin-bottom: 15px;">æµç¨‹åˆ—è¡¨</h3>
                        <div id="bpmn-process-list" style="max-height: 600px; overflow-y: auto;">
                            <div class="loading">åŠ è½½ä¸­...</div>
                        </div>
                    </div>
                    
                    <!-- å³ä¾§ï¼šæµç¨‹è¯¦æƒ… -->
                    <div>
                        <div id="bpmn-process-detail" style="background: white; border: 2px solid #e9ecef; border-radius: 8px; padding: 20px;">
                            <div style="text-align: center; padding: 60px 20px; color: #999;">
                                <div style="font-size: 48px; margin-bottom: 20px;">ğŸ“‹</div>
                                <p>è¯·ä»å·¦ä¾§é€‰æ‹©ä¸€ä¸ªæµç¨‹æŸ¥çœ‹è¯¦æƒ…</p>
                            </div>
                        </div>
                        
                        <!-- BPMN ç¼–è¾‘å™¨ -->
                        <div id="bpmn-editor" style="display: none; background: white; border: 2px solid #e9ecef; border-radius: 8px; padding: 20px; margin-top: 20px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h3>BPMN å†…å®¹</h3>
                                <div>
                                    <button class="btn btn-secondary btn-sm" onclick="closeBpmnEditor()">å…³é—­</button>
                                    <button class="btn btn-primary btn-sm" onclick="saveBpmnContent()">ğŸ’¾ ä¿å­˜</button>
                                </div>
                            </div>
                            <textarea id="bpmn-content" style="width: 100%; height: 400px; font-family: monospace; font-size: 12px; padding: 10px; border: 2px solid #e9ecef; border-radius: 5px;"></textarea>
                        </div>
                    </div>
                </div>
                
                <!-- åˆ›å»ºæ–°æµç¨‹ -->
                <div style="margin-top: 20px; background: white; border: 2px solid #e9ecef; border-radius: 8px; padding: 20px;">
                    <h3 style="margin-bottom: 15px;">â• åˆ›å»ºæ–°æµç¨‹</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>æµç¨‹ç»„ ID</label>
                            <input type="text" id="new-process-group" placeholder="ä¾‹å¦‚: hr">
                        </div>
                        <div class="form-group">
                            <label>æµç¨‹ ID</label>
                            <input type="text" id="new-process-id" placeholder="ä¾‹å¦‚: leave-approval">
                        </div>
                        <div class="form-group">
                            <label>æµç¨‹åç§°</label>
                            <input type="text" id="new-process-name" placeholder="ä¾‹å¦‚: è¯·å‡å®¡æ‰¹æµç¨‹">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>æµç¨‹æè¿°</label>
                        <textarea id="new-process-desc" rows="2" placeholder="æµç¨‹çš„è¯¦ç»†æè¿°..."></textarea>
                    </div>
                    <button class="btn btn-primary" onclick="createNewProcess()">
                        âœ¨ åˆ›å»ºæµç¨‹
                    </button>
                </div>
            </div>
            
            <!-- API æ¥å£ -->
            <div id="tab-api" class="tab-content">
                <h2 style="margin-bottom: 20px;">ğŸ”Œ API æ¥å£æ–‡æ¡£</h2>
                
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h3>åŸºç¡€ä¿¡æ¯</h3>
                    <p><strong>API åŸºç¡€åœ°å€:</strong> <code>http://localhost:8000/api/</code></p>
                    <p><strong>å†…å®¹ç±»å‹:</strong> <code>application/json</code></p>
                </div>
                
                <div style="margin-bottom: 30px;">
                    <h3 style="margin-bottom: 15px;">ğŸ“‹ ç”³è¯·ç®¡ç†</h3>
                    
                    <div style="background: white; border: 2px solid #e9ecef; border-radius: 8px; padding: 20px; margin-bottom: 15px;">
                        <h4 style="color: #667eea;">POST /api/leave/create/</h4>
                        <p>åˆ›å»ºè¯·å‡æˆ–å¯†ç ä¿®æ”¹ç”³è¯·</p>
                        <details>
                            <summary style="cursor: pointer; color: #667eea; margin: 10px 0;">æŸ¥çœ‹è¯·æ±‚ç¤ºä¾‹</summary>
                            <pre style="background: #f8f9fa; padding: 15px; border-radius: 5px; overflow-x: auto;"><code>{
  "user_email": "user@company.com",
  "staff_full_name": "å¼ ä¸‰",
  "staff_dept": "æŠ€æœ¯éƒ¨",
  "reason": "è¯·å‡åŸå› ",
  "leave_hours": 8,
  "leave_type": "annual",
  "password_type": "normal",
  "user_level": "normal",
  "system_name": "ç³»ç»Ÿåç§°"
}</code></pre>
                        </details>
                    </div>
                    
                    <div style="background: white; border: 2px solid #e9ecef; border-radius: 8px; padding: 20px; margin-bottom: 15px;">
                        <h4 style="color: #667eea;">GET /api/leave/my-requests/</h4>
                        <p>æŸ¥è¯¢æˆ‘çš„ç”³è¯·åˆ—è¡¨</p>
                        <p><strong>å‚æ•°:</strong> <code>user_email</code> (å¿…å¡«)</p>
                        <p><strong>ç¤ºä¾‹:</strong> <code>/api/leave/my-requests/?user_email=user@company.com</code></p>
                    </div>
                    
                    <div style="background: white; border: 2px solid #e9ecef; border-radius: 8px; padding: 20px; margin-bottom: 15px;">
                        <h4 style="color: #667eea;">GET /api/leave/pending-approvals/</h4>
                        <p>æŸ¥è¯¢å¾…å®¡æ‰¹ä»»åŠ¡</p>
                        <p><strong>å‚æ•°:</strong> <code>user_email</code> (å¿…å¡«)</p>
                        <p><strong>ç¤ºä¾‹:</strong> <code>/api/leave/pending-approvals/?user_email=manager@company.com</code></p>
                    </div>
                </div>
                
                <div style="margin-bottom: 30px;">
                    <h3 style="margin-bottom: 15px;">âœ… å®¡æ‰¹æ“ä½œ</h3>
                    
                    <div style="background: white; border: 2px solid #e9ecef; border-radius: 8px; padding: 20px; margin-bottom: 15px;">
                        <h4 style="color: #10b981;">POST /api/leave/approve/</h4>
                        <p>æ‰¹å‡†ç”³è¯·</p>
                        <details>
                            <summary style="cursor: pointer; color: #10b981; margin: 10px 0;">æŸ¥çœ‹è¯·æ±‚ç¤ºä¾‹</summary>
                            <pre style="background: #f8f9fa; padding: 15px; border-radius: 5px; overflow-x: auto;"><code>{
  "leave_request_id": 1,
  "task_id": "task-123",
  "approver_email": "manager@company.com",
  "approver_name": "æç»ç†",
  "comment": "åŒæ„"
}</code></pre>
                        </details>
                    </div>
                    
                    <div style="background: white; border: 2px solid #e9ecef; border-radius: 8px; padding: 20px; margin-bottom: 15px;">
                        <h4 style="color: #ef4444;">POST /api/leave/reject/</h4>
                        <p>æ‹’ç»ç”³è¯·</p>
                        <details>
                            <summary style="cursor: pointer; color: #ef4444; margin: 10px 0;">æŸ¥çœ‹è¯·æ±‚ç¤ºä¾‹</summary>
                            <pre style="background: #f8f9fa; padding: 15px; border-radius: 5px; overflow-x: auto;"><code>{
  "leave_request_id": 1,
  "task_id": "task-123",
  "approver_email": "manager@company.com",
  "approver_name": "æç»ç†",
  "comment": "ä¸åŒæ„"
}</code></pre>
                        </details>
                    </div>
                    
                    <div style="background: white; border: 2px solid #e9ecef; border-radius: 8px; padding: 20px; margin-bottom: 15px;">
                        <h4 style="color: #f59e0b;">POST /api/leave/return/</h4>
                        <p>é€€å›ç”³è¯·</p>
                        <p><strong>å‚æ•°:</strong> <code>return_to</code> - 'applicant' æˆ– 'previous'</p>
                    </div>
                </div>
                
                <div style="margin-bottom: 30px;">
                    <h3 style="margin-bottom: 15px;">ğŸ“œ å†å²è®°å½•</h3>
                    
                    <div style="background: white; border: 2px solid #e9ecef; border-radius: 8px; padding: 20px; margin-bottom: 15px;">
                        <h4 style="color: #667eea;">GET /api/leave/requests/{id}/history/</h4>
                        <p>æŸ¥è¯¢å®¡æ‰¹å†å²</p>
                        <p><strong>ç¤ºä¾‹:</strong> <code>/api/leave/requests/1/history/</code></p>
                    </div>
                    
                    <div style="background: white; border: 2px solid #e9ecef; border-radius: 8px; padding: 20px; margin-bottom: 15px;">
                        <h4 style="color: #667eea;">GET /api/leave/requests/{id}/timeline/</h4>
                        <p>è·å–å®¡æ‰¹è½¨è¿¹ï¼ˆå¯è§†åŒ–æ•°æ®ï¼‰</p>
                        <p><strong>ç¤ºä¾‹:</strong> <code>/api/leave/requests/1/timeline/</code></p>
                    </div>
                </div>
                
                <div style="background: #fef3c7; padding: 15px; border-radius: 8px; border-left: 4px solid #f59e0b;">
                    <strong>ğŸ’¡ æç¤º:</strong> æ‰€æœ‰ POST è¯·æ±‚éœ€è¦è®¾ç½® Content-Type: application/json
                </div>
            </div>
            
            <!-- æµç¨‹é…ç½® -->
            <div id="tab-process" class="tab-content">
                <h2 style="margin-bottom: 20px;">âš™ï¸ æµç¨‹é…ç½®ç®¡ç†</h2>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    <div style="background: white; border: 2px solid #e9ecef; border-radius: 8px; padding: 20px;">
                        <h3 style="color: #667eea; margin-bottom: 15px;">ğŸ“ æµç¨‹æ¨¡å‹ç›®å½•</h3>
                        <p><strong>ä½ç½®:</strong> <code>process_models/</code></p>
                        <ul style="margin-left: 20px; line-height: 1.8;">
                            <li><code>admin/admin/</code> - è¯·å‡å®¡æ‰¹æµç¨‹</li>
                            <li><code>password/password-change/</code> - å¯†ç ä¿®æ”¹æµç¨‹</li>
                        </ul>
                    </div>
                    
                    <div style="background: white; border: 2px solid #e9ecef; border-radius: 8px; padding: 20px;">
                        <h3 style="color: #10b981; margin-bottom: 15px;">ğŸ“‹ BPMN æ–‡ä»¶</h3>
                        <p>æµç¨‹å®šä¹‰æ–‡ä»¶ï¼ˆXML æ ¼å¼ï¼‰</p>
                        <ul style="margin-left: 20px; line-height: 1.8;">
                            <li><code>admin.bpmn</code></li>
                            <li><code>password-change.bpmn</code></li>
                        </ul>
                    </div>
                    
                    <div style="background: white; border: 2px solid #e9ecef; border-radius: 8px; padding: 20px;">
                        <h3 style="color: #f59e0b; margin-bottom: 15px;">ğŸ“ è¡¨å• Schema</h3>
                        <p>JSON Schema è¡¨å•å®šä¹‰</p>
                        <ul style="margin-left: 20px; line-height: 1.8;">
                            <li><code>*-form-schema.json</code></li>
                            <li><code>*-form-uischema.json</code></li>
                        </ul>
                    </div>
                </div>
                
                <h3 style="margin-bottom: 15px;">ğŸ”„ å®¡æ‰¹æµç¨‹è¯´æ˜</h3>
                
                <div style="background: white; border: 2px solid #e9ecef; border-radius: 8px; padding: 20px; margin-bottom: 15px;">
                    <h4 style="color: #667eea;">è¯·å‡å®¡æ‰¹æµç¨‹</h4>
                    <div style="margin-top: 15px;">
                        <div style="padding: 10px; background: #f8f9fa; border-radius: 5px; margin-bottom: 10px;">
                            <strong>çŸ­æœŸè¯·å‡ï¼ˆâ‰¤24å°æ—¶ï¼‰:</strong><br>
                            ç”³è¯·äºº â†’ éƒ¨é—¨ä¸»ç®¡ â†’ å®Œæˆ
                        </div>
                        <div style="padding: 10px; background: #f8f9fa; border-radius: 5px;">
                            <strong>é•¿æœŸè¯·å‡ï¼ˆ>24å°æ—¶ï¼‰:</strong><br>
                            ç”³è¯·äºº â†’ éƒ¨é—¨ä¸»ç®¡ â†’ å®Œæˆ
                        </div>
                    </div>
                </div>
                
                <div style="background: white; border: 2px solid #e9ecef; border-radius: 8px; padding: 20px; margin-bottom: 15px;">
                    <h4 style="color: #10b981;">å¯†ç ä¿®æ”¹å®¡æ‰¹æµç¨‹</h4>
                    <div style="margin-top: 15px;">
                        <div style="padding: 10px; background: #d1fae5; border-radius: 5px; margin-bottom: 10px;">
                            <strong>æ™®é€šå¯†ç  + æ™®é€šç”¨æˆ·:</strong><br>
                            ç”³è¯·äºº â†’ éƒ¨é—¨ä¸»ç®¡ â†’ å®Œæˆ
                        </div>
                        <div style="padding: 10px; background: #fef3c7; border-radius: 5px; margin-bottom: 10px;">
                            <strong>é‡è¦å¯†ç  + æ™®é€šç”¨æˆ·:</strong><br>
                            ç”³è¯·äºº â†’ éƒ¨é—¨ä¸»ç®¡ â†’ ITå®‰å…¨ä¸»ç®¡ â†’ å®Œæˆ
                        </div>
                        <div style="padding: 10px; background: #fee2e2; border-radius: 5px;">
                            <strong>å…³é”®å¯†ç  æˆ– ç®¡ç†å‘˜:</strong><br>
                            ç”³è¯·äºº â†’ éƒ¨é—¨ä¸»ç®¡ â†’ ITå®‰å…¨ä¸»ç®¡ â†’ ç³»ç»Ÿç®¡ç†å‘˜ â†’ å®Œæˆ
                        </div>
                    </div>
                </div>
                
                <h3 style="margin-bottom: 15px;">ğŸ› ï¸ é…ç½®æ–‡ä»¶</h3>
                
                <div style="background: white; border: 2px solid #e9ecef; border-radius: 8px; padding: 20px; margin-bottom: 15px;">
                    <h4>process_model.json</h4>
                    <pre style="background: #f8f9fa; padding: 15px; border-radius: 5px; overflow-x: auto;"><code>{
  "id": "password-change",
  "display_name": "å¯†ç ä¿®æ”¹å®¡æ‰¹æµç¨‹",
  "description": "æ”¯æŒå¤šçº§å®¡æ‰¹å’Œå¤šåˆ†æ”¯",
  "primary_file_name": "password-change.bpmn",
  "primary_process_id": "Process_PasswordChange"
}</code></pre>
                </div>
                
                <div style="background: #dbeafe; padding: 15px; border-radius: 8px; border-left: 4px solid #3b82f6;">
                    <strong>ğŸ“– è¯¦ç»†é…ç½®æ•™ç¨‹:</strong> è¯·æŸ¥çœ‹é¡¹ç›®æ ¹ç›®å½•ä¸‹çš„ <code>å¯†ç ä¿®æ”¹å®¡æ‰¹æµç¨‹é…ç½®æ•™ç¨‹.md</code>
                </div>
            </div>
            
            <!-- æ–‡æ¡£ -->
            <div id="tab-docs" class="tab-content">
                <h2 style="margin-bottom: 20px;">ğŸ“š ç³»ç»Ÿæ–‡æ¡£</h2>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                    <div style="background: white; border: 2px solid #e9ecef; border-radius: 8px; padding: 20px;">
                        <h3 style="color: #667eea; margin-bottom: 15px;">ğŸ“– å¿«é€Ÿå¼€å§‹</h3>
                        <p style="margin-bottom: 15px;">äº†è§£å¦‚ä½•å¿«é€Ÿä½¿ç”¨ç³»ç»Ÿ</p>
                        <ul style="margin-left: 20px; line-height: 1.8;">
                            <li>åˆ›å»ºç¬¬ä¸€ä¸ªç”³è¯·</li>
                            <li>å®¡æ‰¹æµç¨‹è¯´æ˜</li>
                            <li>å¸¸è§é—®é¢˜è§£ç­”</li>
                        </ul>
                        <button class="btn btn-primary btn-sm" style="margin-top: 15px;" onclick="window.open('/static/README.md', '_blank')">
                            æŸ¥çœ‹æ–‡æ¡£
                        </button>
                    </div>
                    
                    <div style="background: white; border: 2px solid #e9ecef; border-radius: 8px; padding: 20px;">
                        <h3 style="color: #10b981; margin-bottom: 15px;">âš™ï¸ é…ç½®æ•™ç¨‹</h3>
                        <p style="margin-bottom: 15px;">å­¦ä¹ å¦‚ä½•é…ç½®å®¡æ‰¹æµç¨‹</p>
                        <ul style="margin-left: 20px; line-height: 1.8;">
                            <li>BPMN æµç¨‹è®¾è®¡</li>
                            <li>å¤šçº§å®¡æ‰¹é…ç½®</li>
                            <li>åˆ†æ”¯è·¯ç”±è®¾ç½®</li>
                        </ul>
                        <button class="btn btn-success btn-sm" style="margin-top: 15px;" onclick="alert('è¯·æŸ¥çœ‹é¡¹ç›®æ ¹ç›®å½•ä¸‹çš„ å¯†ç ä¿®æ”¹å®¡æ‰¹æµç¨‹é…ç½®æ•™ç¨‹.md')">
                            æŸ¥çœ‹æ•™ç¨‹
                        </button>
                    </div>
                    
                    <div style="background: white; border: 2px solid #e9ecef; border-radius: 8px; padding: 20px;">
                        <h3 style="color: #f59e0b; margin-bottom: 15px;">ğŸ”Œ API æ–‡æ¡£</h3>
                        <p style="margin-bottom: 15px;">å®Œæ•´çš„ API æ¥å£è¯´æ˜</p>
                        <ul style="margin-left: 20px; line-height: 1.8;">
                            <li>æ¥å£åˆ—è¡¨</li>
                            <li>è¯·æ±‚ç¤ºä¾‹</li>
                            <li>å“åº”æ ¼å¼</li>
                        </ul>
                        <button class="btn btn-primary btn-sm" style="margin-top: 15px;" onclick="switchTab('api')">
                            æŸ¥çœ‹ API
                        </button>
                    </div>
                </div>
                
                <div style="margin-top: 30px; background: white; border: 2px solid #e9ecef; border-radius: 8px; padding: 20px;">
                    <h3 style="margin-bottom: 15px;">ğŸ¯ æµ‹è¯•è´¦å·</h3>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div>
                            <h4 style="color: #667eea; margin-bottom: 10px;">ç”³è¯·äººè´¦å·</h4>
                            <ul style="margin-left: 20px; line-height: 1.8;">
                                <li><code>user1@company.com</code> - å¼ ä¸‰ï¼ˆæŠ€æœ¯éƒ¨ï¼‰</li>
                                <li><code>user2@company.com</code> - æå››ï¼ˆè´¢åŠ¡éƒ¨ï¼‰</li>
                                <li><code>admin@company.com</code> - ç‹äº”ï¼ˆITéƒ¨ç®¡ç†å‘˜ï¼‰</li>
                            </ul>
                        </div>
                        
                        <div>
                            <h4 style="color: #10b981; margin-bottom: 10px;">å®¡æ‰¹äººè´¦å·</h4>
                            <ul style="margin-left: 20px; line-height: 1.8;">
                                <li><code>manager@company.com</code> - éƒ¨é—¨ä¸»ç®¡</li>
                                <li><code>it_security@company.com</code> - ITå®‰å…¨ä¸»ç®¡</li>
                                <li><code>sysadmin@company.com</code> - ç³»ç»Ÿç®¡ç†å‘˜</li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 20px; background: #dbeafe; padding: 20px; border-radius: 8px; border-left: 4px solid #3b82f6;">
                    <h4 style="margin-bottom: 10px;">ğŸ’¡ ä½¿ç”¨æç¤º</h4>
                    <ul style="margin-left: 20px; line-height: 1.8;">
                        <li>åˆ›å»ºç”³è¯·åï¼Œä½¿ç”¨å¯¹åº”çš„å®¡æ‰¹äººé‚®ç®±æŸ¥çœ‹å¾…å®¡æ‰¹ä»»åŠ¡</li>
                        <li>å®¡æ‰¹å®Œæˆåï¼Œå¯ä»¥åœ¨"æˆ‘çš„ç”³è¯·"ä¸­æŸ¥çœ‹çŠ¶æ€å˜åŒ–</li>
                        <li>ç‚¹å‡»"æŸ¥çœ‹å†å²"å¯ä»¥çœ‹åˆ°å®Œæ•´çš„å®¡æ‰¹è½¨è¿¹</li>
                        <li>æ”¯æŒæ‰¹å‡†ã€æ‹’ç»ã€é€€å›ç­‰å¤šç§å®¡æ‰¹æ“ä½œ</li>
                    </ul>
                </div>
                
                <div style="margin-top: 20px; background: #fef3c7; padding: 20px; border-radius: 8px; border-left: 4px solid #f59e0b;">
                    <h4 style="margin-bottom: 10px;">ğŸš€ è‡ªåŠ¨åŒ–æµ‹è¯•</h4>
                    <p>è¿è¡Œæµ‹è¯•è„šæœ¬éªŒè¯æ‰€æœ‰åŠŸèƒ½ï¼š</p>
                    <pre style="background: white; padding: 15px; border-radius: 5px; margin-top: 10px;"><code>python test_password_change.py</code></pre>
                </div>
            </div>
        </div>
    </div>
    
    <!-- å®¡æ‰¹æ¨¡æ€æ¡† -->
    <div id="approval-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close-modal" onclick="closeModal()">&times;</span>
                <h2>å®¡æ‰¹ç”³è¯·</h2>
            </div>
            <div id="approval-details"></div>
            <div class="form-group">
                <label>å®¡æ‰¹æ„è§</label>
                <textarea id="approval-comment" rows="3" placeholder="è¯·è¾“å…¥å®¡æ‰¹æ„è§..."></textarea>
            </div>
            <div class="action-buttons">
                <button class="btn btn-success" onclick="approveRequest()">âœ… æ‰¹å‡†</button>
                <button class="btn btn-danger" onclick="rejectRequest()">âŒ æ‹’ç»</button>
                <button class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    
    <script>
        const API_BASE = '/api';
        let currentTask = null;
        
        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function switchTab(tabName) {
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');
            
            if (tabName === 'all') {
                loadAllRequests();
            } else if (tabName === 'bpmn') {
                loadBpmnProcesses();
            }
        }
        
        // æ›´æ–°è¡¨å•å­—æ®µ
        function updateFormFields() {
            const requestType = document.getElementById('request-type').value;
            const leaveFields = document.getElementById('leave-fields');
            const passwordFields = document.getElementById('password-fields');
            
            if (requestType === 'leave') {
                leaveFields.style.display = 'block';
                passwordFields.style.display = 'none';
            } else {
                leaveFields.style.display = 'none';
                passwordFields.style.display = 'block';
            }
        }
        
        // åˆ›å»ºç”³è¯·
        async function createRequest() {
            const requestType = document.getElementById('request-type').value;
            const alertDiv = document.getElementById('create-alert');
            
            const data = {
                user_email: document.getElementById('user-email').value,
                staff_full_name: document.getElementById('staff-name').value,
                staff_dept: document.getElementById('staff-dept').value,
                reason: document.getElementById('reason').value,
            };
            
            if (requestType === 'leave') {
                data.leave_hours = parseInt(document.getElementById('leave-hours').value) || 8;
                data.leave_type = document.getElementById('leave-type').value;
                data.duration = parseFloat(document.getElementById('duration').value) || null;
                data.start_date = document.getElementById('start-date').value || null;
                data.end_date = document.getElementById('end-date').value || null;
            } else {
                data.leave_hours = 0;
                data.password_type = document.getElementById('password-type').value;
                data.user_level = document.getElementById('user-level').value;
                data.system_name = document.getElementById('system-name').value;
            }
            
            try {
                const response = await fetch(`${API_BASE}/leave/create/`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alertDiv.innerHTML = `
                        <div class="alert alert-success">
                            âœ… ç”³è¯·åˆ›å»ºæˆåŠŸï¼<br>
                            ç”³è¯·ID: ${result.leave_request_id}<br>
                            æµç¨‹å®ä¾‹ID: ${result.process_instance_id}<br>
                            çŠ¶æ€: ${result.status}
                        </div>
                    `;
                    // æ¸…ç©ºè¡¨å•
                    document.getElementById('reason').value = '';
                    loadStats();
                } else {
                    alertDiv.innerHTML = `<div class="alert alert-error">âŒ ${result.error}</div>`;
                }
            } catch (error) {
                alertDiv.innerHTML = `<div class="alert alert-error">âŒ è¯·æ±‚å¤±è´¥: ${error.message}</div>`;
            }
        }
        
        // åŠ è½½æˆ‘çš„ç”³è¯·
        async function loadMyRequests() {
            const email = document.getElementById('my-email').value;
            const contentDiv = document.getElementById('my-requests-content');
            
            if (!email) {
                contentDiv.innerHTML = '<div class="alert alert-error">è¯·è¾“å…¥é‚®ç®±åœ°å€</div>';
                return;
            }
            
            contentDiv.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
            
            try {
                const response = await fetch(`${API_BASE}/leave/my-requests/?user_email=${email}`);
                const result = await response.json();
                
                if (result.success && result.requests.length > 0) {
                    contentDiv.innerHTML = `
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>ç±»å‹</th>
                                        <th>åŸå› </th>
                                        <th>çŠ¶æ€</th>
                                        <th>åˆ›å»ºæ—¶é—´</th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${result.requests.map(req => `
                                        <tr>
                                            <td>${req.id}</td>
                                            <td>${req.leave_type || req.password_type || '-'}</td>
                                            <td>${req.reason.substring(0, 30)}...</td>
                                            <td><span class="badge badge-${req.status}">${req.status_display}</span></td>
                                            <td>${new Date(req.created_at).toLocaleString('zh-CN')}</td>
                                            <td>
                                                <button class="btn btn-primary btn-sm" onclick="viewHistory(${req.id})">
                                                    æŸ¥çœ‹å†å²
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                } else {
                    contentDiv.innerHTML = '<div class="loading">æš‚æ— ç”³è¯·è®°å½•</div>';
                }
            } catch (error) {
                contentDiv.innerHTML = `<div class="alert alert-error">åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }
        
        // åŠ è½½å¾…å®¡æ‰¹ä»»åŠ¡
        async function loadPendingApprovals() {
            const email = document.getElementById('approver-email').value;
            const contentDiv = document.getElementById('pending-content');
            
            if (!email) {
                contentDiv.innerHTML = '<div class="alert alert-error">è¯·è¾“å…¥å®¡æ‰¹äººé‚®ç®±</div>';
                return;
            }
            
            contentDiv.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
            
            try {
                const response = await fetch(`${API_BASE}/leave/pending-approvals/?user_email=${email}`);
                const result = await response.json();
                
                if (result.success && result.tasks.length > 0) {
                    contentDiv.innerHTML = `
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>ä»»åŠ¡åç§°</th>
                                        <th>ç”³è¯·äºº</th>
                                        <th>éƒ¨é—¨</th>
                                        <th>åŸå› </th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${result.tasks.map(task => `
                                        <tr>
                                            <td>${task.name}</td>
                                            <td>${task.leave_request.staff_full_name}</td>
                                            <td>${task.leave_request.staff_dept}</td>
                                            <td>${task.leave_request.reason.substring(0, 30)}...</td>
                                            <td>
                                                <button class="btn btn-primary btn-sm" onclick="openApprovalModal(${JSON.stringify(task).replace(/"/g, '&quot;')})">
                                                    å®¡æ‰¹
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                } else {
                    contentDiv.innerHTML = '<div class="loading">æš‚æ— å¾…å®¡æ‰¹ä»»åŠ¡</div>';
                }
            } catch (error) {
                contentDiv.innerHTML = `<div class="alert alert-error">åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }
        
        // åŠ è½½æ‰€æœ‰ç”³è¯·
        async function loadAllRequests() {
            const contentDiv = document.getElementById('all-requests-content');
            contentDiv.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
            
            // è¿™é‡Œå¯ä»¥æ·»åŠ ä¸€ä¸ªè·å–æ‰€æœ‰ç”³è¯·çš„API
            contentDiv.innerHTML = '<div class="loading">æ­¤åŠŸèƒ½éœ€è¦ç®¡ç†å‘˜æƒé™</div>';
        }
        
        // æ‰“å¼€å®¡æ‰¹æ¨¡æ€æ¡†
        function openApprovalModal(task) {
            currentTask = task;
            const modal = document.getElementById('approval-modal');
            const detailsDiv = document.getElementById('approval-details');
            
            detailsDiv.innerHTML = `
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <p><strong>ç”³è¯·äºº:</strong> ${task.leave_request.staff_full_name}</p>
                    <p><strong>éƒ¨é—¨:</strong> ${task.leave_request.staff_dept}</p>
                    <p><strong>ç±»å‹:</strong> ${task.leave_request.leave_type || task.leave_request.password_type || '-'}</p>
                    <p><strong>åŸå› :</strong> ${task.leave_request.reason}</p>
                </div>
            `;
            
            modal.classList.add('active');
        }
        
        // å…³é—­æ¨¡æ€æ¡†
        function closeModal() {
            document.getElementById('approval-modal').classList.remove('active');
            document.getElementById('approval-comment').value = '';
            currentTask = null;
        }
        
        // æ‰¹å‡†ç”³è¯·
        async function approveRequest() {
            if (!currentTask) return;
            
            const comment = document.getElementById('approval-comment').value;
            const email = document.getElementById('approver-email').value;
            
            try {
                const response = await fetch(`${API_BASE}/leave/approve/`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        leave_request_id: currentTask.leave_request.id,
                        task_id: currentTask.id,
                        approver_email: email,
                        approver_name: 'å®¡æ‰¹äºº',
                        comment: comment
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('âœ… å®¡æ‰¹æˆåŠŸï¼');
                    closeModal();
                    loadPendingApprovals();
                    loadStats();
                } else {
                    alert('âŒ å®¡æ‰¹å¤±è´¥: ' + result.error);
                }
            } catch (error) {
                alert('âŒ è¯·æ±‚å¤±è´¥: ' + error.message);
            }
        }
        
        // æ‹’ç»ç”³è¯·
        async function rejectRequest() {
            if (!currentTask) return;
            
            const comment = document.getElementById('approval-comment').value;
            if (!comment) {
                alert('è¯·è¾“å…¥æ‹’ç»ç†ç”±');
                return;
            }
            
            const email = document.getElementById('approver-email').value;
            
            try {
                const response = await fetch(`${API_BASE}/leave/reject/`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        leave_request_id: currentTask.leave_request.id,
                        task_id: currentTask.id,
                        approver_email: email,
                        approver_name: 'å®¡æ‰¹äºº',
                        comment: comment
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('âœ… å·²æ‹’ç»ç”³è¯·');
                    closeModal();
                    loadPendingApprovals();
                    loadStats();
                } else {
                    alert('âŒ æ“ä½œå¤±è´¥: ' + result.error);
                }
            } catch (error) {
                alert('âŒ è¯·æ±‚å¤±è´¥: ' + error.message);
            }
        }
        
        // æŸ¥çœ‹å®¡æ‰¹å†å²
        async function viewHistory(requestId) {
            try {
                const response = await fetch(`${API_BASE}/leave/requests/${requestId}/history/`);
                const result = await response.json();
                
                if (result.success) {
                    const historyHtml = result.history.map(h => `
                        <div style="padding: 10px; border-left: 3px solid #667eea; margin-bottom: 10px; background: #f8f9fa;">
                            <strong>${h.action_display}</strong> - ${h.operator_name}<br>
                            <small>${new Date(h.created_at).toLocaleString('zh-CN')}</small><br>
                            ${h.comment ? `<p style="margin-top: 5px;">${h.comment}</p>` : ''}
                        </div>
                    `).join('');
                    
                    alert('å®¡æ‰¹å†å²:\n\n' + result.history.map(h => 
                        `${h.action_display} - ${h.operator_name}\n${new Date(h.created_at).toLocaleString('zh-CN')}\n${h.comment || ''}`
                    ).join('\n\n'));
                }
            } catch (error) {
                alert('åŠ è½½å¤±è´¥: ' + error.message);
            }
        }
        
        // åŠ è½½ç»Ÿè®¡æ•°æ®
        async function loadStats() {
            // è¿™é‡Œå¯ä»¥æ·»åŠ ç»Ÿè®¡API
            document.getElementById('stat-pending').textContent = '-';
            document.getElementById('stat-approved').textContent = '-';
            document.getElementById('stat-rejected').textContent = '-';
            document.getElementById('stat-total').textContent = '-';
        }
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.onload = function() {
            loadStats();
        };
        
        // ========== BPMN é…ç½®ç›¸å…³å‡½æ•° ==========
        
        let currentProcessId = null;
        let currentBpmnFile = null;
        
        // åŠ è½½ BPMN æµç¨‹åˆ—è¡¨
        async function loadBpmnProcesses() {
            const listDiv = document.getElementById('bpmn-process-list');
            listDiv.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
            
            try {
                const response = await fetch(`${API_BASE}/bpmn/processes/`);
                const result = await response.json();
                
                if (result.success && result.processes.length > 0) {
                    listDiv.innerHTML = result.processes.map(process => `
                        <div style="padding: 15px; border: 2px solid #e9ecef; border-radius: 8px; margin-bottom: 10px; cursor: pointer; transition: all 0.3s;"
                             onmouseover="this.style.borderColor='#667eea'; this.style.background='#f8f9fa'"
                             onmouseout="this.style.borderColor='#e9ecef'; this.style.background='white'"
                             onclick="loadProcessDetail('${process.id}')">
                            <div style="font-weight: bold; color: #333; margin-bottom: 5px;">${process.display_name || process.id}</div>
                            <div style="font-size: 12px; color: #666;">${process.id}</div>
                        </div>
                    `).join('');
                } else {
                    listDiv.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">æš‚æ— æµç¨‹</div>';
                }
            } catch (error) {
                listDiv.innerHTML = `<div class="alert alert-error">åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }
        
        // åŠ è½½æµç¨‹è¯¦æƒ…
        async function loadProcessDetail(processId) {
            currentProcessId = processId;
            const detailDiv = document.getElementById('bpmn-process-detail');
            detailDiv.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
            
            try {
                const response = await fetch(`${API_BASE}/bpmn/processes/${processId}/`);
                const result = await response.json();
                
                if (result.success) {
                    const process = result.process;
                    detailDiv.innerHTML = `
                        <div style="margin-bottom: 20px;">
                            <h3 style="color: #667eea; margin-bottom: 10px;">${process.display_name || process.id}</h3>
                            <p style="color: #666; margin-bottom: 15px;">${process.description || 'æš‚æ— æè¿°'}</p>
                            
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                                <p><strong>æµç¨‹ ID:</strong> <code>${process.id}</code></p>
                                <p><strong>ä¸»æ–‡ä»¶:</strong> <code>${process.primary_file_name || '-'}</code></p>
                                <p><strong>æµç¨‹ ID:</strong> <code>${process.primary_process_id || '-'}</code></p>
                            </div>
                            
                            <h4 style="margin-bottom: 10px;">ğŸ“ æµç¨‹æ–‡ä»¶</h4>
                            <div id="process-files-${processId}">
                                ${process.files ? process.files.map(file => `
                                    <div style="padding: 10px; background: #f8f9fa; border-radius: 5px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">
                                        <span>
                                            <span style="margin-right: 10px;">${getFileIcon(file.name)}</span>
                                            <code>${file.name}</code>
                                        </span>
                                        ${file.name.endsWith('.bpmn') ? `
                                            <button class="btn btn-primary btn-sm" onclick="viewBpmnFile('${processId}', '${file.name}')">
                                                æŸ¥çœ‹/ç¼–è¾‘
                                            </button>
                                        ` : `
                                            <button class="btn btn-secondary btn-sm" onclick="alert('æ–‡ä»¶: ${file.name}')">
                                                æŸ¥çœ‹
                                            </button>
                                        `}
                                    </div>
                                `).join('') : '<p style="color: #999;">æš‚æ— æ–‡ä»¶</p>'}
                            </div>
                            
                            <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #e9ecef;">
                                <button class="btn btn-primary" onclick="validateProcess('${processId}')">
                                    âœ… éªŒè¯æµç¨‹
                                </button>
                                <button class="btn btn-success" onclick="deployProcess('${processId}')">
                                    ğŸš€ éƒ¨ç½²æµç¨‹
                                </button>
                                <button class="btn btn-danger" onclick="deleteProcess('${processId}')">
                                    ğŸ—‘ï¸ åˆ é™¤æµç¨‹
                                </button>
                            </div>
                        </div>
                    `;
                } else {
                    detailDiv.innerHTML = `<div class="alert alert-error">${result.error}</div>`;
                }
            } catch (error) {
                detailDiv.innerHTML = `<div class="alert alert-error">åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }
        
        // è·å–æ–‡ä»¶å›¾æ ‡
        function getFileIcon(filename) {
            if (filename.endsWith('.bpmn')) return 'ğŸ“Š';
            if (filename.endsWith('.json')) return 'ğŸ“';
            if (filename.endsWith('.xml')) return 'ğŸ“„';
            return 'ğŸ“';
        }
        
        // æŸ¥çœ‹ BPMN æ–‡ä»¶
        async function viewBpmnFile(processId, filename) {
            currentBpmnFile = filename;
            const editorDiv = document.getElementById('bpmn-editor');
            const contentTextarea = document.getElementById('bpmn-content');
            
            try {
                const response = await fetch(`${API_BASE}/bpmn/processes/${processId}/`);
                const result = await response.json();
                
                if (result.success) {
                    // è¿™é‡Œåº”è¯¥è·å–æ–‡ä»¶å†…å®¹ï¼Œæš‚æ—¶æ˜¾ç¤ºæç¤º
                    contentTextarea.value = `<?xml version="1.0" encoding="UTF-8"?>
<!-- BPMN æ–‡ä»¶: ${filename} -->
<!-- æµç¨‹ ID: ${processId} -->

<!-- æ³¨æ„ï¼šå®é™…å†…å®¹éœ€è¦ä»æœåŠ¡å™¨åŠ è½½ -->
<!-- è¯·ä½¿ç”¨æ–‡æœ¬ç¼–è¾‘å™¨ç›´æ¥ç¼–è¾‘ process_models ç›®å½•ä¸‹çš„æ–‡ä»¶ -->

æµç¨‹æ–‡ä»¶è·¯å¾„: process_models/${processId.replace('/', '/')}/${filename}`;
                    
                    editorDiv.style.display = 'block';
                    editorDiv.scrollIntoView({ behavior: 'smooth' });
                } else {
                    alert('åŠ è½½æ–‡ä»¶å¤±è´¥: ' + result.error);
                }
            } catch (error) {
                alert('åŠ è½½æ–‡ä»¶å¤±è´¥: ' + error.message);
            }
        }
        
        // å…³é—­ BPMN ç¼–è¾‘å™¨
        function closeBpmnEditor() {
            document.getElementById('bpmn-editor').style.display = 'none';
            document.getElementById('bpmn-content').value = '';
        }
        
        // ä¿å­˜ BPMN å†…å®¹
        async function saveBpmnContent() {
            if (!currentProcessId || !currentBpmnFile) {
                alert('è¯·å…ˆé€‰æ‹©è¦ç¼–è¾‘çš„æ–‡ä»¶');
                return;
            }
            
            const content = document.getElementById('bpmn-content').value;
            
            // è¿™é‡Œåº”è¯¥è°ƒç”¨ä¿å­˜ API
            alert('ä¿å­˜åŠŸèƒ½éœ€è¦å®ç°æ–‡ä»¶å†™å…¥ API\n\nå»ºè®®ç›´æ¥ç¼–è¾‘ process_models ç›®å½•ä¸‹çš„æ–‡ä»¶');
        }
        
        // éªŒè¯æµç¨‹
        async function validateProcess(processId) {
            try {
                const response = await fetch(`${API_BASE}/bpmn/processes/${processId}/validate/`);
                const result = await response.json();
                
                if (result.success) {
                    alert('âœ… æµç¨‹éªŒè¯é€šè¿‡ï¼\n\n' + (result.message || 'æµç¨‹é…ç½®æ­£ç¡®'));
                } else {
                    alert('âŒ æµç¨‹éªŒè¯å¤±è´¥ï¼\n\n' + (result.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                alert('éªŒè¯å¤±è´¥: ' + error.message);
            }
        }
        
        // éƒ¨ç½²æµç¨‹
        async function deployProcess(processId) {
            if (!confirm('ç¡®å®šè¦éƒ¨ç½²æ­¤æµç¨‹å—ï¼Ÿ')) return;
            
            try {
                const response = await fetch(`${API_BASE}/bpmn/processes/${processId}/deploy/`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });
                const result = await response.json();
                
                if (result.success) {
                    alert('âœ… æµç¨‹éƒ¨ç½²æˆåŠŸï¼');
                } else {
                    alert('âŒ éƒ¨ç½²å¤±è´¥: ' + result.error);
                }
            } catch (error) {
                alert('éƒ¨ç½²å¤±è´¥: ' + error.message);
            }
        }
        
        // åˆ é™¤æµç¨‹
        async function deleteProcess(processId) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤æµç¨‹ "${processId}" å—ï¼Ÿ\n\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) return;
            
            try {
                const response = await fetch(`${API_BASE}/bpmn/processes/${processId}/`, {
                    method: 'DELETE'
                });
                const result = await response.json();
                
                if (result.success) {
                    alert('âœ… æµç¨‹å·²åˆ é™¤');
                    loadBpmnProcesses();
                    document.getElementById('bpmn-process-detail').innerHTML = `
                        <div style="text-align: center; padding: 60px 20px; color: #999;">
                            <div style="font-size: 48px; margin-bottom: 20px;">ğŸ“‹</div>
                            <p>è¯·ä»å·¦ä¾§é€‰æ‹©ä¸€ä¸ªæµç¨‹æŸ¥çœ‹è¯¦æƒ…</p>
                        </div>
                    `;
                } else {
                    alert('âŒ åˆ é™¤å¤±è´¥: ' + result.error);
                }
            } catch (error) {
                alert('åˆ é™¤å¤±è´¥: ' + error.message);
            }
        }
        
        // åˆ›å»ºæ–°æµç¨‹
        async function createNewProcess() {
            const groupId = document.getElementById('new-process-group').value.trim();
            const processId = document.getElementById('new-process-id').value.trim();
            const displayName = document.getElementById('new-process-name').value.trim();
            const description = document.getElementById('new-process-desc').value.trim();
            
            if (!groupId || !processId || !displayName) {
                alert('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ');
                return;
            }
            
            const fullProcessId = `${groupId}/${processId}`;
            
            try {
                const response = await fetch(`${API_BASE}/bpmn/processes/`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        id: fullProcessId,
                        display_name: displayName,
                        description: description,
                        primary_file_name: `${processId}.bpmn`,
                        primary_process_id: `Process_${processId}`
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('âœ… æµç¨‹åˆ›å»ºæˆåŠŸï¼');
                    // æ¸…ç©ºè¡¨å•
                    document.getElementById('new-process-group').value = '';
                    document.getElementById('new-process-id').value = '';
                    document.getElementById('new-process-name').value = '';
                    document.getElementById('new-process-desc').value = '';
                    // åˆ·æ–°åˆ—è¡¨
                    loadBpmnProcesses();
                } else {
                    alert('âŒ åˆ›å»ºå¤±è´¥: ' + result.error);
                }
            } catch (error) {
                alert('åˆ›å»ºå¤±è´¥: ' + error.message);
            }
        }
    </script>
</body>
</html>
