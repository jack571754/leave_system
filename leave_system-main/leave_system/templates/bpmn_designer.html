<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LogicFlow æµç¨‹è®¾è®¡å™¨</title>
    
    <!-- LogicFlow æ ¸å¿ƒåº“ -->
    <script src="https://cdn.jsdelivr.net/npm/@logicflow/core@1.2.27/dist/logic-flow.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@logicflow/core@1.2.27/dist/style/index.css">
    
    <!-- LogicFlow æ‰©å±•æ’ä»¶ -->
    <script src="https://cdn.jsdelivr.net/npm/@logicflow/extension@1.2.27/dist/logic-flow-extension.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@logicflow/extension@1.2.27/dist/style/index.css">
    
    <!-- CodeMirror ä»£ç ç¼–è¾‘å™¨ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/monokai.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/python/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/javascript/javascript.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', sans-serif;
            height: 100vh;
            overflow: hidden;
            background: #f5f5f5;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 20px;
            font-weight: 600;
        }
        
        .header-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }
        
        .btn-primary {
            background: white;
            color: #667eea;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255,255,255,0.3);
        }
        
        .btn-success {
            background: #10b981;
            color: white;
        }
        
        .btn-secondary {
            background: rgba(255,255,255,0.2);
            color: white;
        }
        
        .container {
            display: flex;
            height: calc(100vh - 60px);
        }
        
        .canvas-container {
            flex: 1;
            position: relative;
            background: white;
        }
        
        #canvas {
            width: 100%;
            height: 100%;
        }
        
        .properties-panel {
            width: 400px;
            background: #2d2d2d;
            color: #e0e0e0;
            overflow-y: auto;
            border-left: 1px solid #444;
        }
        
        .properties-header {
            padding: 15px 20px;
            background: #1e1e1e;
            border-bottom: 1px solid #444;
        }
        
        .properties-header h2 {
            font-size: 16px;
            color: #fff;
            margin-bottom: 5px;
        }
        
        .properties-content {
            padding: 20px;
        }
        
        .property-group {
            margin-bottom: 25px;
        }
        
        .property-group h3 {
            font-size: 14px;
            color: #fff;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #444;
        }
        
        .property-item {
            margin-bottom: 15px;
        }
        
        .property-label {
            display: block;
            font-size: 12px;
            color: #aaa;
            margin-bottom: 5px;
        }
        
        .property-input {
            width: 100%;
            padding: 8px 12px;
            background: #1e1e1e;
            border: 1px solid #444;
            border-radius: 4px;
            color: #e0e0e0;
            font-size: 13px;
        }
        
        .property-input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .code-editor {
            margin-top: 10px;
            border: 1px solid #444;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .CodeMirror {
            height: 200px;
            font-size: 13px;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }
        
        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }
        
        /* è‡ªå®šä¹‰å³é”®èœå• */
        #context-menu {
            display: none;
            position: fixed;
            width: 150px;
            border: 1px solid #ccc;
            background: #fff;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            border-radius: 5px;
            z-index: 1000;
        }
        
        #context-menu ul {
            list-style: none;
            margin: 5px 0;
        }
        
        #context-menu li {
            height: 35px;
            line-height: 35px;
            color: #333;
            font-size: 13px;
            text-align: center;
            cursor: pointer;
            border-bottom: 1px dashed #e0e0e0;
        }
        
        #context-menu li:last-child {
            border-bottom: none;
        }
        
        #context-menu li:hover {
            background-color: #f5f5f5;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ¨ LogicFlow æµç¨‹è®¾è®¡å™¨</h1>
        <div class="header-actions">
            <button class="btn btn-primary" onclick="newDiagram()">ğŸ“„ æ–°å»º</button>
            <button class="btn btn-success" onclick="saveDiagram()">ğŸ’¾ ä¿å­˜</button>
            <button class="btn btn-primary" onclick="downloadDiagram()">â¬‡ï¸ ä¸‹è½½JSON</button>
            <button class="btn btn-secondary" onclick="window.location.href='/dashboard/'">ğŸ  è¿”å›</button>
        </div>
    </div>
    
    <div class="container">
        <div class="canvas-container">
            <div id="canvas"></div>
        </div>
        
        <div class="properties-panel">
            <div class="properties-header">
                <h2 id="element-name">å±æ€§é¢æ¿</h2>
            </div>
            <div class="properties-content" id="properties-content">
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸ“‹</div>
                    <p>é€‰æ‹©ç”»å¸ƒä¸Šçš„å…ƒç´ <br>æŸ¥çœ‹å’Œç¼–è¾‘å±æ€§</p>
                </div>
            </div>
        </div>
    </div>

    <!-- è‡ªå®šä¹‰å³é”®èœå• -->
    <div id="context-menu">
        <ul>
            <li onclick="deleteElement()">ğŸ—‘ï¸ åˆ é™¤</li>
            <li onclick="copyElement()">ğŸ“‹ å¤åˆ¶</li>
        </ul>
    </div>
    
    <script>
        const { LogicFlow } = window;
        const { DndPanel, SelectionSelect, Menu, Control } = window.LogicFlowExtension;
        
        let lf = null;
        let currentElement = null;
        let codeEditors = {};
        
        // åˆå§‹åŒ– LogicFlow
        function initLogicFlow() {
            lf = new LogicFlow({
                container: document.getElementById('canvas'),
                grid: {
                    size: 20,
                    visible: true,
                    type: 'dot',
                    config: {
                        color: '#e0e0e0',
                        thickness: 1,
                    }
                },
                keyboard: {
                    enabled: true,
                },
                style: {
                    rect: {
                        rx: 5,
                        ry: 5,
                        strokeWidth: 2,
                    },
                    circle: {
                        fill: '#f56a00',
                        stroke: '#f56a00',
                    },
                    ellipse: {
                        fill: '#f56a00',
                        stroke: '#f56a00',
                    },
                    polygon: {
                        fill: '#1890ff',
                        stroke: '#1890ff',
                    },
                    diamond: {
                        fill: '#52c41a',
                        stroke: '#52c41a',
                    },
                    text: {
                        color: '#000000',
                        fontSize: 12,
                    }
                },
                plugins: [DndPanel, SelectionSelect, Menu, Control],
            });
            
            // è®¾ç½®å·¦ä¾§å·¥å…·æ 
            lf.extension.dndPanel.setPatternItems([
                {
                    type: 'circle',
                    text: 'å¼€å§‹',
                    label: 'å¼€å§‹èŠ‚ç‚¹',
                    icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDgiIGhlaWdodD0iNDgiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iMjQiIGN5PSIyNCIgcj0iMjAiIGZpbGw9IiM1MmM0MWEiLz48L3N2Zz4=',
                },
                {
                    type: 'rect',
                    text: 'ç”¨æˆ·ä»»åŠ¡',
                    label: 'ç”¨æˆ·ä»»åŠ¡',
                    icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDgiIGhlaWdodD0iNDgiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3QgeD0iNCIgeT0iNCIgd2lkdGg9IjQwIiBoZWlnaHQ9IjQwIiBmaWxsPSIjMTg5MGZmIiByeD0iNSIvPjwvc3ZnPg==',
                },
                {
                    type: 'rect',
                    text: 'è„šæœ¬ä»»åŠ¡',
                    label: 'è„šæœ¬ä»»åŠ¡',
                    icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDgiIGhlaWdodD0iNDgiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3QgeD0iNCIgeT0iNCIgd2lkdGg9IjQwIiBoZWlnaHQ9IjQwIiBmaWxsPSIjNzIyZWQxIiByeD0iNSIvPjwvc3ZnPg==',
                },
                {
                    type: 'diamond',
                    text: 'ç½‘å…³',
                    label: 'æ’ä»–ç½‘å…³',
                    icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDgiIGhlaWdodD0iNDgiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHBvbHlnb24gcG9pbnRzPSIyNCw0IDQ0LDI0IDI0LDQ0IDQsMjQiIGZpbGw9IiNmYWFkMTQiLz48L3N2Zz4=',
                },
                {
                    type: 'circle',
                    text: 'ç»“æŸ',
                    label: 'ç»“æŸèŠ‚ç‚¹',
                    icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDgiIGhlaWdodD0iNDgiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iMjQiIGN5PSIyNCIgcj0iMjAiIGZpbGw9IiNmNTIyMmQiLz48L3N2Zz4=',
                },
            ]);
            
            // ç›‘å¬èŠ‚ç‚¹ç‚¹å‡»äº‹ä»¶
            lf.on('node:click', ({ data }) => {
                currentElement = data;
                showProperties(data);
            });
            
            // ç›‘å¬è¾¹ç‚¹å‡»äº‹ä»¶
            lf.on('edge:click', ({ data }) => {
                currentElement = data;
                showEdgeProperties(data);
            });
            
            // ç›‘å¬ç”»å¸ƒç‚¹å‡»äº‹ä»¶
            lf.on('blank:click', () => {
                currentElement = null;
                showEmptyState();
            });
            
            // ç›‘å¬èŠ‚ç‚¹å³é”®èœå•
            lf.on('node:contextmenu', ({ data, e }) => {
                e.preventDefault();
                currentElement = data;
                showContextMenu(e.clientX, e.clientY);
            });
            
            // ç›‘å¬è¾¹å³é”®èœå•
            lf.on('edge:contextmenu', ({ data, e }) => {
                e.preventDefault();
                currentElement = data;
                showContextMenu(e.clientX, e.clientY);
            });
            
            // æ¸²æŸ“åˆå§‹å›¾è¡¨
            renderInitialGraph();
        }
        
        // æ¸²æŸ“åˆå§‹å›¾è¡¨
        function renderInitialGraph() {
            const graphData = {
                nodes: [
                    {
                        id: 'start-1',
                        type: 'circle',
                        x: 200,
                        y: 200,
                        text: 'å¼€å§‹',
                        properties: {
                            nodeType: 'start',
                            name: 'å¼€å§‹èŠ‚ç‚¹'
                        }
                    },
                    {
                        id: 'task-1',
                        type: 'rect',
                        x: 400,
                        y: 200,
                        text: 'ç”¨æˆ·ä»»åŠ¡',
                        properties: {
                            nodeType: 'userTask',
                            name: 'ç”¨æˆ·ä»»åŠ¡',
                            formSchema: '',
                            formUiSchema: '',
                            preScript: '',
                            postScript: ''
                        }
                    },
                    {
                        id: 'end-1',
                        type: 'circle',
                        x: 600,
                        y: 200,
                        text: 'ç»“æŸ',
                        properties: {
                            nodeType: 'end',
                            name: 'ç»“æŸèŠ‚ç‚¹'
                        }
                    }
                ],
                edges: [
                    {
                        id: 'edge-1',
                        type: 'polyline',
                        sourceNodeId: 'start-1',
                        targetNodeId: 'task-1',
                        text: '',
                        properties: {
                            condition: ''
                        }
                    },
                    {
                        id: 'edge-2',
                        type: 'polyline',
                        sourceNodeId: 'task-1',
                        targetNodeId: 'end-1',
                        text: '',
                        properties: {
                            condition: ''
                        }
                    }
                ]
            };
            
            lf.render(graphData);
        }
        
        // æ˜¾ç¤ºèŠ‚ç‚¹å±æ€§
        function showProperties(node) {
            document.getElementById('element-name').textContent = node.text || node.id;
            
            const props = node.properties || {};
            let html = `
                <div class="property-group">
                    <h3>åŸºæœ¬å±æ€§</h3>
                    <div class="property-item">
                        <label class="property-label">ID</label>
                        <input type="text" class="property-input" value="${node.id}" readonly>
                    </div>
                    <div class="property-item">
                        <label class="property-label">åç§°</label>
                        <input type="text" class="property-input" id="prop-name" value="${node.text || ''}" 
                               onchange="updateNodeProperty('text', this.value)">
                    </div>
                    <div class="property-item">
                        <label class="property-label">èŠ‚ç‚¹ç±»å‹</label>
                        <input type="text" class="property-input" value="${node.type}" readonly>
                    </div>
                </div>
            `;
            
            // ç”¨æˆ·ä»»åŠ¡ç‰¹å®šå±æ€§
            if (props.nodeType === 'userTask' || node.type === 'rect') {
                html += `
                    <div class="property-group">
                        <h3>è¡¨å•é…ç½®</h3>
                        <div class="property-item">
                            <label class="property-label">è¡¨å• Schema æ–‡ä»¶</label>
                            <input type="text" class="property-input" id="prop-form-schema" 
                                   value="${props.formSchema || ''}"
                                   onchange="updateNodeProperty('formSchema', this.value)">
                        </div>
                        <div class="property-item">
                            <label class="property-label">è¡¨å• UI Schema æ–‡ä»¶</label>
                            <input type="text" class="property-input" id="prop-form-ui-schema" 
                                   value="${props.formUiSchema || ''}"
                                   onchange="updateNodeProperty('formUiSchema', this.value)">
                        </div>
                    </div>
                    
                    <div class="property-group">
                        <h3>å‰ç½®è„šæœ¬ (Python)</h3>
                        <div class="property-item">
                            <label class="property-label">åœ¨ä»»åŠ¡æ‰§è¡Œå‰è¿è¡Œ</label>
                            <div class="code-editor">
                                <textarea id="pre-script-editor">${props.preScript || ''}</textarea>
                            </div>
                        </div>
                    </div>
                    
                    <div class="property-group">
                        <h3>åç½®è„šæœ¬ (Python)</h3>
                        <div class="property-item">
                            <label class="property-label">åœ¨ä»»åŠ¡å®Œæˆåè¿è¡Œ</label>
                            <div class="code-editor">
                                <textarea id="post-script-editor">${props.postScript || ''}</textarea>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            document.getElementById('properties-content').innerHTML = html;
            
            // åˆå§‹åŒ–ä»£ç ç¼–è¾‘å™¨
            setTimeout(() => {
                if (document.getElementById('pre-script-editor')) {
                    initCodeEditor('pre-script-editor', 'python', (value) => {
                        updateNodeProperty('preScript', value);
                    });
                }
                if (document.getElementById('post-script-editor')) {
                    initCodeEditor('post-script-editor', 'python', (value) => {
                        updateNodeProperty('postScript', value);
                    });
                }
            }, 100);
        }
        
        // æ˜¾ç¤ºè¾¹å±æ€§
        function showEdgeProperties(edge) {
            document.getElementById('element-name').textContent = 'è¿çº¿å±æ€§';
            
            const props = edge.properties || {};
            const html = `
                <div class="property-group">
                    <h3>åŸºæœ¬å±æ€§</h3>
                    <div class="property-item">
                        <label class="property-label">ID</label>
                        <input type="text" class="property-input" value="${edge.id}" readonly>
                    </div>
                    <div class="property-item">
                        <label class="property-label">æ–‡æœ¬</label>
                        <input type="text" class="property-input" id="prop-edge-text" value="${edge.text || ''}" 
                               onchange="updateEdgeProperty('text', this.value)">
                    </div>
                </div>
                
                <div class="property-group">
                    <h3>æ¡ä»¶è¡¨è¾¾å¼ (Python)</h3>
                    <div class="property-item">
                        <label class="property-label">æµè½¬æ¡ä»¶</label>
                        <div class="code-editor">
                            <textarea id="condition-editor">${props.condition || ''}</textarea>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('properties-content').innerHTML = html;
            
            // åˆå§‹åŒ–ä»£ç ç¼–è¾‘å™¨
            setTimeout(() => {
                if (document.getElementById('condition-editor')) {
                    initCodeEditor('condition-editor', 'python', (value) => {
                        updateEdgeProperty('condition', value);
                    });
                }
            }, 100);
        }
        
        // æ˜¾ç¤ºç©ºçŠ¶æ€
        function showEmptyState() {
            document.getElementById('element-name').textContent = 'å±æ€§é¢æ¿';
            document.getElementById('properties-content').innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸ“‹</div>
                    <p>é€‰æ‹©ç”»å¸ƒä¸Šçš„å…ƒç´ <br>æŸ¥çœ‹å’Œç¼–è¾‘å±æ€§</p>
                </div>
            `;
        }
        
        // åˆå§‹åŒ–ä»£ç ç¼–è¾‘å™¨
        function initCodeEditor(elementId, mode, onChange) {
            const textarea = document.getElementById(elementId);
            if (!textarea) return;
            
            const editor = CodeMirror.fromTextArea(textarea, {
                mode: mode,
                theme: 'monokai',
                lineNumbers: true,
                lineWrapping: true,
                indentUnit: 4,
                tabSize: 4,
                indentWithTabs: false,
                autoCloseBrackets: true,
                matchBrackets: true
            });
            
            editor.on('change', function() {
                if (onChange) {
                    onChange(editor.getValue());
                }
            });
            
            codeEditors[elementId] = editor;
        }
        
        // æ›´æ–°èŠ‚ç‚¹å±æ€§
        function updateNodeProperty(property, value) {
            if (!currentElement) return;
            
            if (property === 'text') {
                lf.setProperties(currentElement.id, { ...currentElement.properties });
                lf.updateText(currentElement.id, value);
            } else {
                const newProperties = { ...currentElement.properties, [property]: value };
                lf.setProperties(currentElement.id, newProperties);
                currentElement.properties = newProperties;
            }
        }
        
        // æ›´æ–°è¾¹å±æ€§
        function updateEdgeProperty(property, value) {
            if (!currentElement) return;
            
            if (property === 'text') {
                lf.updateText(currentElement.id, value);
            } else {
                const newProperties = { ...currentElement.properties, [property]: value };
                lf.setProperties(currentElement.id, newProperties);
                currentElement.properties = newProperties;
            }
        }
        
        // æ˜¾ç¤ºå³é”®èœå•
        function showContextMenu(x, y) {
            const menu = document.getElementById('context-menu');
            menu.style.left = `${x}px`;
            menu.style.top = `${y}px`;
            menu.style.display = 'block';
        }
        
        // éšè—å³é”®èœå•
        document.addEventListener('click', () => {
            const menu = document.getElementById('context-menu');
            menu.style.display = 'none';
        });
        
        // åˆ é™¤å…ƒç´ 
        function deleteElement() {
            if (!currentElement) return;
            
            if (currentElement.type === 'polyline' || currentElement.type === 'line') {
                lf.deleteEdge(currentElement.id);
            } else {
                lf.deleteNode(currentElement.id);
            }
            
            currentElement = null;
            showEmptyState();
        }
        
        // å¤åˆ¶å…ƒç´ 
        function copyElement() {
            if (!currentElement || currentElement.type === 'polyline' || currentElement.type === 'line') return;
            
            const newNode = {
                ...currentElement,
                id: 'node-' + Date.now(),
                x: currentElement.x + 50,
                y: currentElement.y + 50
            };
            
            lf.addNode(newNode);
        }
        
        // æ–°å»ºå›¾è¡¨
        function newDiagram() {
            if (confirm('åˆ›å»ºæ–°å›¾è¡¨å°†æ¸…ç©ºå½“å‰ç”»å¸ƒï¼Œç¡®å®šç»§ç»­å—ï¼Ÿ')) {
                lf.clearData();
                renderInitialGraph();
            }
        }
        
        // ä¿å­˜å›¾è¡¨
        function saveDiagram() {
            const graphData = lf.getGraphData();
            console.log('ä¿å­˜çš„å›¾è¡¨æ•°æ®:', graphData);
            
            // è¿™é‡Œå¯ä»¥æ·»åŠ ä¿å­˜åˆ°æœåŠ¡å™¨çš„é€»è¾‘
            fetch('/api/bpmn/save/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(graphData)
            })
            .then(response => response.json())
            .then(data => {
                alert('ä¿å­˜æˆåŠŸï¼');
            })
            .catch(error => {
                console.error('ä¿å­˜å¤±è´¥:', error);
                alert('ä¿å­˜å¤±è´¥: ' + error.message);
            });
        }
        
        // ä¸‹è½½å›¾è¡¨
        function downloadDiagram() {
            const graphData = lf.getGraphData();
            const dataStr = JSON.stringify(graphData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'flow-diagram-' + Date.now() + '.json';
            link.click();
            
            URL.revokeObjectURL(url);
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', () => {
            initLogicFlow();
        });
    </script>
</body>
</html>
