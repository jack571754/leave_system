<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BPMN æµç¨‹è®¾è®¡å™¨</title>
    
    <!-- bpmn-js æ ¸å¿ƒåº“ -->
    <link rel="stylesheet" href="https://unpkg.com/bpmn-js@11.5.0/dist/assets/diagram-js.css">
    <link rel="stylesheet" href="https://unpkg.com/bpmn-js@11.5.0/dist/assets/bpmn-font/css/bpmn-embedded.css">
    <script src="https://unpkg.com/bpmn-js@11.5.0/dist/bpmn-modeler.development.js"></script>
    
    <!-- CodeMirror ä»£ç ç¼–è¾‘å™¨ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/monokai.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/python/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/xml/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/javascript/javascript.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', sans-serif;
            height: 100vh;
            overflow: hidden;
            background: #f5f5f5;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 20px;
            font-weight: 600;
        }
        
        .header-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }
        
        .btn-primary {
            background: white;
            color: #667eea;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255,255,255,0.3);
        }
        
        .btn-success {
            background: #10b981;
            color: white;
        }
        
        .btn-danger {
            background: #ef4444;
            color: white;
        }
        
        .btn-secondary {
            background: rgba(255,255,255,0.2);
            color: white;
        }
        
        .container {
            display: flex;
            height: calc(100vh - 60px);
        }
        
        .canvas-container {
            flex: 1;
            position: relative;
            background: white;
        }
        
        #canvas {
            width: 100%;
            height: 100%;
        }
        
        .properties-panel {
            width: 400px;
            background: #2d2d2d;
            color: #e0e0e0;
            overflow-y: auto;
            border-left: 1px solid #444;
            display: flex;
            flex-direction: column;
        }
        
        .properties-header {
            padding: 15px 20px;
            background: #1e1e1e;
            border-bottom: 1px solid #444;
        }
        
        .properties-header h2 {
            font-size: 16px;
            color: #fff;
            margin-bottom: 5px;
        }
        
        .properties-header .element-type {
            font-size: 12px;
            color: #888;
        }
        
        .properties-content {
            flex: 1;
            padding: 20px;
        }
        
        .property-group {
            margin-bottom: 25px;
        }
        
        .property-group h3 {
            font-size: 14px;
            color: #fff;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #444;
        }
        
        .property-item {
            margin-bottom: 15px;
        }
        
        .property-label {
            display: block;
            font-size: 12px;
            color: #aaa;
            margin-bottom: 5px;
        }
        
        .property-input {
            width: 100%;
            padding: 8px 12px;
            background: #1e1e1e;
            border: 1px solid #444;
            border-radius: 4px;
            color: #e0e0e0;
            font-size: 13px;
        }
        
        .property-input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .property-textarea {
            min-height: 80px;
            font-family: 'Consolas', 'Monaco', monospace;
            resize: vertical;
        }
        
        .code-editor {
            margin-top: 10px;
            border: 1px solid #444;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .CodeMirror {
            height: 200px;
            font-size: 13px;
        }
        
        .property-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .property-checkbox input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }
        
        .add-property-btn {
            width: 100%;
            padding: 8px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            margin-top: 10px;
        }
        
        .add-property-btn:hover {
            background: #5568d3;
        }
        
        .property-list {
            list-style: none;
        }
        
        .property-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: #1e1e1e;
            border: 1px solid #444;
            border-radius: 4px;
            margin-bottom: 8px;
        }
        
        .property-list-item:hover {
            background: #252525;
        }
        
        .delete-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }
        
        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }
        
        .toolbar {
            position: absolute;
            top: 20px;
            left: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 10px;
            display: flex;
            gap: 5px;
            z-index: 10;
        }
        
        .toolbar-btn {
            padding: 8px 12px;
            border: 1px solid #e0e0e0;
            background: white;
            border-radius: 5px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }
        
        .toolbar-btn:hover {
            background: #f5f5f5;
            border-color: #667eea;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            margin-bottom: 20px;
        }
        
        .modal-header h2 {
            color: #333;
        }
        
        .close-modal {
            float: right;
            font-size: 28px;
            font-weight: bold;
            color: #999;
            cursor: pointer;
        }
        
        .close-modal:hover {
            color: #333;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 500;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ¨ BPMN æµç¨‹è®¾è®¡å™¨</h1>
        <div class="header-actions">
            <select id="process-selector" class="btn btn-secondary" onchange="loadProcess(this.value)">
                <option value="">é€‰æ‹©æµç¨‹...</option>
            </select>
            <button class="btn btn-primary" onclick="newDiagram()">ğŸ“„ æ–°å»º</button>
            <button class="btn btn-primary" onclick="openFile()">ğŸ“‚ æ‰“å¼€</button>
            <button class="btn btn-success" onclick="saveDiagram()">ğŸ’¾ ä¿å­˜</button>
            <button class="btn btn-primary" onclick="downloadDiagram()">â¬‡ï¸ ä¸‹è½½</button>
            <button class="btn btn-primary" onclick="exportSVG()">ğŸ–¼ï¸ å¯¼å‡ºSVG</button>
            <button class="btn btn-secondary" onclick="window.location.href='/dashboard/'">ğŸ  è¿”å›</button>
        </div>
    </div>
    
    <div class="container">
        <div class="canvas-container">
            <div class="toolbar">
                <button class="toolbar-btn" onclick="zoomIn()" title="æ”¾å¤§">ğŸ”+</button>
                <button class="toolbar-btn" onclick="zoomOut()" title="ç¼©å°">ğŸ”-</button>
                <button class="toolbar-btn" onclick="zoomReset()" title="é‡ç½®">âš¡</button>
                <button class="toolbar-btn" onclick="undo()" title="æ’¤é”€">â†¶</button>
                <button class="toolbar-btn" onclick="redo()" title="é‡åš">â†·</button>
            </div>
            <div id="canvas"></div>
        </div>
        
        <div class="properties-panel">
            <div class="properties-header">
                <h2 id="element-name">å±æ€§é¢æ¿</h2>
                <div class="element-type" id="element-type">é€‰æ‹©ä¸€ä¸ªå…ƒç´ æŸ¥çœ‹å±æ€§</div>
            </div>
            <div class="properties-content" id="properties-content">
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸ“‹</div>
                    <p>é€‰æ‹©ç”»å¸ƒä¸Šçš„å…ƒç´ <br>æŸ¥çœ‹å’Œç¼–è¾‘å±æ€§</p>
                </div>
            </div>
        </div>
    </div>

    
    <!-- æ–‡ä»¶ä¸Šä¼ æ¨¡æ€æ¡† -->
    <div id="upload-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close-modal" onclick="closeModal('upload-modal')">&times;</span>
                <h2>æ‰“å¼€ BPMN æ–‡ä»¶</h2>
            </div>
            <div class="form-group">
                <label>é€‰æ‹©æ–‡ä»¶</label>
                <input type="file" id="file-input" accept=".bpmn,.xml" onchange="handleFileSelect(event)">
            </div>
        </div>
    </div>
    
    <script>
        let bpmnModeler;
        let currentElement = null;
        let codeEditors = {};
        
        // åˆå§‹åŒ– BPMN å»ºæ¨¡å™¨
        function initModeler() {
            bpmnModeler = new BpmnJS({
                container: '#canvas',
                keyboard: {
                    bindTo: document
                }
            });
            
            // ç›‘å¬é€‰æ‹©äº‹ä»¶
            bpmnModeler.on('selection.changed', function(e) {
                const element = e.newSelection[0];
                if (element) {
                    currentElement = element;
                    showProperties(element);
                } else {
                    currentElement = null;
                    showEmptyState();
                }
            });
            
            // ç›‘å¬å…ƒç´ å˜åŒ–
            bpmnModeler.on('element.changed', function(e) {
                if (currentElement && e.element.id === currentElement.id) {
                    showProperties(e.element);
                }
            });
            
            // åˆ›å»ºæ–°å›¾è¡¨
            createNewDiagram();
        }
        
        // åˆ›å»ºæ–°å›¾è¡¨
        function createNewDiagram() {
            const newDiagramXML = `<?xml version="1.0" encoding="UTF-8"?>
<bpmn:definitions xmlns:bpmn="http://www.omg.org/spec/BPMN/20100524/MODEL"
                  xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI"
                  xmlns:dc="http://www.omg.org/spec/DD/20100524/DC"
                  xmlns:spiffworkflow="http://spiffworkflow.org/bpmn/schema/1.0/core"
                  id="Definitions_1"
                  targetNamespace="http://bpmn.io/schema/bpmn">
  <bpmn:process id="Process_1" name="æ–°æµç¨‹" isExecutable="true">
    <bpmn:startEvent id="StartEvent_1" name="å¼€å§‹">
      <bpmn:outgoing>Flow_1</bpmn:outgoing>
    </bpmn:startEvent>
    <bpmn:sequenceFlow id="Flow_1" sourceRef="StartEvent_1" targetRef="Activity_1" />
    <bpmn:userTask id="Activity_1" name="ç”¨æˆ·ä»»åŠ¡">
      <bpmn:incoming>Flow_1</bpmn:incoming>
      <bpmn:outgoing>Flow_2</bpmn:outgoing>
    </bpmn:userTask>
    <bpmn:sequenceFlow id="Flow_2" sourceRef="Activity_1" targetRef="EndEvent_1" />
    <bpmn:endEvent id="EndEvent_1" name="ç»“æŸ">
      <bpmn:incoming>Flow_2</bpmn:incoming>
    </bpmn:endEvent>
  </bpmn:process>
  <bpmndi:BPMNDiagram id="BPMNDiagram_1">
    <bpmndi:BPMNPlane id="BPMNPlane_1" bpmnElement="Process_1">
      <bpmndi:BPMNShape id="StartEvent_1_di" bpmnElement="StartEvent_1">
        <dc:Bounds x="152" y="102" width="36" height="36" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Activity_1_di" bpmnElement="Activity_1">
        <dc:Bounds x="240" y="80" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="EndEvent_1_di" bpmnElement="EndEvent_1">
        <dc:Bounds x="392" y="102" width="36" height="36" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNEdge id="Flow_1_di" bpmnElement="Flow_1">
        <di:waypoint x="188" y="120" />
        <di:waypoint x="240" y="120" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_2_di" bpmnElement="Flow_2">
        <di:waypoint x="340" y="120" />
        <di:waypoint x="392" y="120" />
      </bpmndi:BPMNEdge>
    </bpmndi:BPMNPlane>
  </bpmndi:BPMNDiagram>
</bpmn:definitions>`;
            
            bpmnModeler.importXML(newDiagramXML).then(() => {
                const canvas = bpmnModeler.get('canvas');
                canvas.zoom('fit-viewport');
            }).catch(err => {
                console.error('åˆ›å»ºå›¾è¡¨å¤±è´¥:', err);
            });
        }
        
        // æ˜¾ç¤ºå±æ€§
        function showProperties(element) {
            const modeling = bpmnModeler.get('modeling');
            const elementRegistry = bpmnModeler.get('elementRegistry');
            const businessObject = element.businessObject;
            
            document.getElementById('element-name').textContent = businessObject.name || element.id;
            document.getElementById('element-type').textContent = element.type;
            
            let html = '';
            
            // åŸºæœ¬å±æ€§
            html += `
                <div class="property-group">
                    <h3>åŸºæœ¬å±æ€§</h3>
                    <div class="property-item">
                        <label class="property-label">ID</label>
                        <input type="text" class="property-input" value="${element.id}" readonly>
                    </div>
                    <div class="property-item">
                        <label class="property-label">åç§°</label>
                        <input type="text" class="property-input" id="prop-name" value="${businessObject.name || ''}" 
                               onchange="updateProperty('name', this.value)">
                    </div>
                </div>
            `;
            
            // ç”¨æˆ·ä»»åŠ¡ç‰¹å®šå±æ€§
            if (element.type === 'bpmn:UserTask') {
                const extensionElements = businessObject.extensionElements;
                let formSchema = '';
                let formUiSchema = '';
                let preScript = '';
                let postScript = '';
                
                if (extensionElements) {
                    const properties = extensionElements.values.find(v => v.$type === 'spiffworkflow:properties');
                    if (properties) {
                        properties.values.forEach(prop => {
                            if (prop.name === 'formJsonSchemaFilename') formSchema = prop.value;
                            if (prop.name === 'formUiSchemaFilename') formUiSchema = prop.value;
                        });
                    }
                    
                    const scripts = extensionElements.values.filter(v => v.$type === 'spiffworkflow:preScript' || v.$type === 'spiffworkflow:postScript');
                    scripts.forEach(script => {
                        if (script.$type === 'spiffworkflow:preScript') preScript = script.value || '';
                        if (script.$type === 'spiffworkflow:postScript') postScript = script.value || '';
                    });
                }
                
                html += `
                    <div class="property-group">
                        <h3>è¡¨å•é…ç½®</h3>
                        <div class="property-item">
                            <label class="property-label">è¡¨å• Schema æ–‡ä»¶</label>
                            <input type="text" class="property-input" id="prop-form-schema" value="${formSchema}"
                                   onchange="updateFormProperty('formJsonSchemaFilename', this.value)">
                        </div>
                        <div class="property-item">
                            <label class="property-label">è¡¨å• UI Schema æ–‡ä»¶</label>
                            <input type="text" class="property-input" id="prop-form-ui-schema" value="${formUiSchema}"
                                   onchange="updateFormProperty('formUiSchemaFilename', this.value)">
                        </div>
                    </div>
                    
                    <div class="property-group">
                        <h3>å‰ç½®è„šæœ¬ (Python)</h3>
                        <div class="property-item">
                            <label class="property-label">åœ¨ä»»åŠ¡æ‰§è¡Œå‰è¿è¡Œ</label>
                            <div class="code-editor">
                                <textarea id="pre-script-editor">${preScript}</textarea>
                            </div>
                        </div>
                    </div>
                    
                    <div class="property-group">
                        <h3>åç½®è„šæœ¬ (Python)</h3>
                        <div class="property-item">
                            <label class="property-label">åœ¨ä»»åŠ¡å®Œæˆåè¿è¡Œ</label>
                            <div class="code-editor">
                                <textarea id="post-script-editor">${postScript}</textarea>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // è„šæœ¬ä»»åŠ¡
            if (element.type === 'bpmn:ScriptTask') {
                const script = businessObject.script || '';
                html += `
                    <div class="property-group">
                        <h3>è„šæœ¬å†…å®¹ (Python)</h3>
                        <div class="property-item">
                            <div class="code-editor">
                                <textarea id="script-editor">${script}</textarea>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // æ¡ä»¶æµ
            if (element.type === 'bpmn:SequenceFlow') {
                const conditionExpression = businessObject.conditionExpression;
                const condition = conditionExpression ? conditionExpression.body : '';
                
                html += `
                    <div class="property-group">
                        <h3>æ¡ä»¶è¡¨è¾¾å¼ (Python)</h3>
                        <div class="property-item">
                            <label class="property-label">æµè½¬æ¡ä»¶</label>
                            <div class="code-editor">
                                <textarea id="condition-editor">${condition}</textarea>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // ç½‘å…³
            if (element.type === 'bpmn:ExclusiveGateway' || element.type === 'bpmn:ParallelGateway') {
                html += `
                    <div class="property-group">
                        <h3>ç½‘å…³é…ç½®</h3>
                        <div class="property-item">
                            <label class="property-label">ç½‘å…³ç±»å‹</label>
                            <input type="text" class="property-input" value="${element.type === 'bpmn:ExclusiveGateway' ? 'æ’ä»–ç½‘å…³' : 'å¹¶è¡Œç½‘å…³'}" readonly>
                        </div>
                    </div>
                `;
            }
            
            document.getElementById('properties-content').innerHTML = html;
            
            // åˆå§‹åŒ–ä»£ç ç¼–è¾‘å™¨
            setTimeout(() => {
                if (document.getElementById('pre-script-editor')) {
                    initCodeEditor('pre-script-editor', 'python', (value) => {
                        updateScript('preScript', value);
                    });
                }
                if (document.getElementById('post-script-editor')) {
                    initCodeEditor('post-script-editor', 'python', (value) => {
                        updateScript('postScript', value);
                    });
                }
                if (document.getElementById('script-editor')) {
                    initCodeEditor('script-editor', 'python', (value) => {
                        updateScriptTask(value);
                    });
                }
                if (document.getElementById('condition-editor')) {
                    initCodeEditor('condition-editor', 'python', (value) => {
                        updateCondition(value);
                    });
                }
            }, 100);
        }

        
        // åˆå§‹åŒ–ä»£ç ç¼–è¾‘å™¨
        function initCodeEditor(elementId, mode, onChange) {
            const textarea = document.getElementById(elementId);
            if (!textarea) return;
            
            const editor = CodeMirror.fromTextArea(textarea, {
                mode: mode,
                theme: 'monokai',
                lineNumbers: true,
                lineWrapping: true,
                indentUnit: 4,
                tabSize: 4,
                indentWithTabs: false,
                autoCloseBrackets: true,
                matchBrackets: true
            });
            
            editor.on('change', function() {
                if (onChange) {
                    onChange(editor.getValue());
                }
            });
            
            codeEditors[elementId] = editor;
        }
        
        // æ˜¾ç¤ºç©ºçŠ¶æ€
        function showEmptyState() {
            document.getElementById('element-name').textContent = 'å±æ€§é¢æ¿';
            document.getElementById('element-type').textContent = 'é€‰æ‹©ä¸€ä¸ªå…ƒç´ æŸ¥çœ‹å±æ€§';
            document.getElementById('properties-content').innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸ“‹</div>
                    <p>é€‰æ‹©ç”»å¸ƒä¸Šçš„å…ƒç´ <br>æŸ¥çœ‹å’Œç¼–è¾‘å±æ€§</p>
                </div>
            `;
        }
        
        // æ›´æ–°å±æ€§
        function updateProperty(property, value) {
            if (!currentElement) return;
            
            const modeling = bpmnModeler.get('modeling');
            const updates = {};
            updates[property] = value;
            modeling.updateProperties(currentElement, updates);
        }
        
        // æ›´æ–°è¡¨å•å±æ€§
        function updateFormProperty(propertyName, value) {
            if (!currentElement) return;
            
            const modeling = bpmnModeler.get('modeling');
            const moddle = bpmnModeler.get('moddle');
            const businessObject = currentElement.businessObject;
            
            let extensionElements = businessObject.extensionElements;
            if (!extensionElements) {
                extensionElements = moddle.create('bpmn:ExtensionElements');
            }
            
            let properties = extensionElements.values.find(v => v.$type === 'spiffworkflow:properties');
            if (!properties) {
                properties = moddle.create('spiffworkflow:properties');
                extensionElements.values.push(properties);
            }
            
            let property = properties.values.find(p => p.name === propertyName);
            if (!property) {
                property = moddle.create('spiffworkflow:property');
                property.name = propertyName;
                properties.values.push(property);
            }
            
            property.value = value;
            modeling.updateProperties(currentElement, { extensionElements });
        }
        
        // æ›´æ–°è„šæœ¬
        function updateScript(scriptType, value) {
            if (!currentElement) return;
            
            const modeling = bpmnModeler.get('modeling');
            const moddle = bpmnModeler.get('moddle');
            const businessObject = currentElement.businessObject;
            
            let extensionElements = businessObject.extensionElements;
            if (!extensionElements) {
                extensionElements = moddle.create('bpmn:ExtensionElements');
            }
            
            const type = scriptType === 'preScript' ? 'spiffworkflow:preScript' : 'spiffworkflow:postScript';
            let script = extensionElements.values.find(v => v.$type === type);
            
            if (!script) {
                script = moddle.create(type);
                extensionElements.values.push(script);
            }
            
            script.value = value;
            modeling.updateProperties(currentElement, { extensionElements });
        }
        
        // æ›´æ–°è„šæœ¬ä»»åŠ¡
        function updateScriptTask(value) {
            if (!currentElement) return;
            
            const modeling = bpmnModeler.get('modeling');
            modeling.updateProperties(currentElement, { script: value });
        }
        
        // æ›´æ–°æ¡ä»¶
        function updateCondition(value) {
            if (!currentElement) return;
            
            const modeling = bpmnModeler.get('modeling');
            const moddle = bpmnModeler.get('moddle');
            
            const conditionExpression = moddle.create('bpmn:FormalExpression', {
                body: value
            });
            
            modeling.updateProperties(currentElement, {
                conditionExpression: conditionExpression
            });
        }
        
        // å·¥å…·æ åŠŸèƒ½
        function zoomIn() {
            bpmnModeler.get('zoomScroll').stepZoom(1);
        }
        
        function zoomOut() {
            bpmnModeler.get('zoomScroll').stepZoom(-1);
        }
        
        function zoomReset() {
            bpmnModeler.get('canvas').zoom('fit-viewport');
        }
        
        function undo() {
            bpmnModeler.get('commandStack').undo();
        }
        
        function redo() {
            bpmnModeler.get('commandStack').redo();
        }
        
        // æ–‡ä»¶æ“ä½œ
        function newDiagram() {
            if (confirm('åˆ›å»ºæ–°å›¾è¡¨å°†ä¸¢å¤±å½“å‰æœªä¿å­˜çš„æ›´æ”¹ï¼Œç¡®å®šç»§ç»­å—ï¼Ÿ')) {
                createNewDiagram();
            }
        }
        
        function openFile() {
            document.getElementById('upload-modal').classList.add('active');
        }
        
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const xml = e.target.result;
                bpmnModeler.importXML(xml).then(() => {
                    const canvas = bpmnModeler.get('canvas');
                    canvas.zoom('fit-viewport');
                    closeModal('upload-modal');
                    alert('æ–‡ä»¶åŠ è½½æˆåŠŸï¼');
                }).catch(err => {
                    console.error('å¯¼å…¥å¤±è´¥:', err);
                    alert('æ–‡ä»¶å¯¼å…¥å¤±è´¥: ' + err.message);
                });
            };
            reader.readAsText(file);
        }
        
        async function saveDiagram() {
            try {
                const { xml } = await bpmnModeler.saveXML({ format: true });
                
                // è¿™é‡Œå¯ä»¥è°ƒç”¨ API ä¿å­˜åˆ°æœåŠ¡å™¨
                const blob = new Blob([xml], { type: 'application/xml' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'diagram.bpmn';
                a.click();
                URL.revokeObjectURL(url);
                
                alert('âœ… æ–‡ä»¶å·²ä¸‹è½½ï¼\n\næç¤ºï¼šå°†æ–‡ä»¶ä¿å­˜åˆ° process_models ç›®å½•');
            } catch (err) {
                console.error('ä¿å­˜å¤±è´¥:', err);
                alert('ä¿å­˜å¤±è´¥: ' + err.message);
            }
        }
        
        async function downloadDiagram() {
            try {
                const { xml } = await bpmnModeler.saveXML({ format: true });
                const blob = new Blob([xml], { type: 'application/xml' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'process.bpmn';
                a.click();
                URL.revokeObjectURL(url);
            } catch (err) {
                console.error('ä¸‹è½½å¤±è´¥:', err);
                alert('ä¸‹è½½å¤±è´¥: ' + err.message);
            }
        }
        
        async function exportSVG() {
            try {
                const { svg } = await bpmnModeler.saveSVG();
                const blob = new Blob([svg], { type: 'image/svg+xml' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'diagram.svg';
                a.click();
                URL.revokeObjectURL(url);
            } catch (err) {
                console.error('å¯¼å‡ºå¤±è´¥:', err);
                alert('å¯¼å‡ºå¤±è´¥: ' + err.message);
            }
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }
        
        // åŠ è½½æµç¨‹åˆ—è¡¨
        async function loadProcessList() {
            try {
                const response = await fetch('/api/bpmn/processes/');
                const result = await response.json();
                
                if (result.success && result.processes) {
                    const selector = document.getElementById('process-selector');
                    result.processes.forEach(process => {
                        const option = document.createElement('option');
                        option.value = process.id;
                        option.textContent = process.display_name || process.id;
                        selector.appendChild(option);
                    });
                }
            } catch (err) {
                console.error('åŠ è½½æµç¨‹åˆ—è¡¨å¤±è´¥:', err);
            }
        }
        
        // åŠ è½½æŒ‡å®šæµç¨‹
        async function loadProcess(processId) {
            if (!processId) return;
            
            try {
                const response = await fetch(`/api/bpmn/processes/${processId}/`);
                const result = await response.json();
                
                if (result.success && result.process) {
                    // è¿™é‡Œéœ€è¦è·å– BPMN æ–‡ä»¶å†…å®¹
                    alert('åŠ è½½æµç¨‹: ' + processId + '\n\nè¯·ä»æœ¬åœ°æ‰“å¼€å¯¹åº”çš„ BPMN æ–‡ä»¶');
                }
            } catch (err) {
                console.error('åŠ è½½æµç¨‹å¤±è´¥:', err);
                alert('åŠ è½½å¤±è´¥: ' + err.message);
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.onload = function() {
            initModeler();
            loadProcessList();
        };
    </script>
</body>
</html>
