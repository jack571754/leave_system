<?xml version="1.0" encoding="UTF-8"?>
<bpmn:definitions xmlns:bpmn="http://www.omg.org/spec/BPMN/20100524/MODEL" 
                  xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI" 
                  xmlns:dc="http://www.omg.org/spec/DD/20100524/DC" 
                  xmlns:spiffworkflow="http://spiffworkflow.org/bpmn/schema/1.0/core" 
                  xmlns:di="http://www.omg.org/spec/DD/20100524/DI" 
                  id="Definitions_PasswordChange" 
                  targetNamespace="http://bpmn.io/schema/bpmn">
  
  <bpmn:process id="Process_PasswordChange" name="密码修改审批流程" isExecutable="true">
    
    <!-- 开始事件 -->
    <bpmn:startEvent id="StartEvent_1" name="开始">
      <bpmn:outgoing>Flow_Start_To_Form</bpmn:outgoing>
    </bpmn:startEvent>
    
    <bpmn:sequenceFlow id="Flow_Start_To_Form" sourceRef="StartEvent_1" targetRef="Task_PasswordForm" />
    
    <!-- 密码修改申请表单 -->
    <bpmn:userTask id="Task_PasswordForm" name="密码修改申请">
      <bpmn:extensionElements>
        <spiffworkflow:properties>
          <spiffworkflow:property name="formJsonSchemaFilename" value="password-form-schema.json" />
        </spiffworkflow:properties>
      </bpmn:extensionElements>
      <bpmn:incoming>Flow_Start_To_Form</bpmn:incoming>
      <bpmn:outgoing>Flow_Form_To_Route</bpmn:outgoing>
    </bpmn:userTask>
    
    <bpmn:sequenceFlow id="Flow_Form_To_Route" sourceRef="Task_PasswordForm" targetRef="Gateway_Route" />

    
    <!-- 路由网关：根据密码类型和用户级别分支 -->
    <bpmn:exclusiveGateway id="Gateway_Route" name="路由决策" default="Flow_Route_Normal">
      <bpmn:incoming>Flow_Form_To_Route</bpmn:incoming>
      <bpmn:outgoing>Flow_Route_Normal</bpmn:outgoing>
      <bpmn:outgoing>Flow_Route_Important</bpmn:outgoing>
      <bpmn:outgoing>Flow_Route_Critical</bpmn:outgoing>
    </bpmn:exclusiveGateway>
    
    <!-- 分支1：普通密码 + 普通用户 → 部门主管 -->
    <bpmn:sequenceFlow id="Flow_Route_Normal" name="普通密码" sourceRef="Gateway_Route" targetRef="Task_Manager_Normal" />
    
    <bpmn:userTask id="Task_Manager_Normal" name="部门主管审批">
      <bpmn:extensionElements>
        <spiffworkflow:properties>
          <spiffworkflow:property name="formJsonSchemaFilename" value="approval-form-schema.json" />
        </spiffworkflow:properties>
        <spiffworkflow:preScript>assigned_to = "manager@company.com"</spiffworkflow:preScript>
      </bpmn:extensionElements>
      <bpmn:incoming>Flow_Route_Normal</bpmn:incoming>
      <bpmn:outgoing>Flow_Manager_Normal_To_Decision</bpmn:outgoing>
    </bpmn:userTask>
    
    <bpmn:sequenceFlow id="Flow_Manager_Normal_To_Decision" sourceRef="Task_Manager_Normal" targetRef="Gateway_Decision_Normal" />
    
    <bpmn:exclusiveGateway id="Gateway_Decision_Normal" name="审批决策" default="Flow_Normal_Reject">
      <bpmn:incoming>Flow_Manager_Normal_To_Decision</bpmn:incoming>
      <bpmn:outgoing>Flow_Normal_Approve</bpmn:outgoing>
      <bpmn:outgoing>Flow_Normal_Reject</bpmn:outgoing>
    </bpmn:exclusiveGateway>
    
    <bpmn:sequenceFlow id="Flow_Normal_Approve" name="批准" sourceRef="Gateway_Decision_Normal" targetRef="End_Approved">
      <bpmn:conditionExpression>action == "approve"</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    
    <bpmn:sequenceFlow id="Flow_Normal_Reject" name="拒绝" sourceRef="Gateway_Decision_Normal" targetRef="End_Rejected" />

    
    <!-- 分支2：重要密码 → 部门主管 → IT安全主管 -->
    <bpmn:sequenceFlow id="Flow_Route_Important" name="重要密码" sourceRef="Gateway_Route" targetRef="Task_Manager_Important">
      <bpmn:conditionExpression>password_type == "important" and user_level == "normal"</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    
    <bpmn:userTask id="Task_Manager_Important" name="部门主管审批（重要）">
      <bpmn:extensionElements>
        <spiffworkflow:properties>
          <spiffworkflow:property name="formJsonSchemaFilename" value="approval-form-schema.json" />
        </spiffworkflow:properties>
        <spiffworkflow:preScript>assigned_to = "finance_manager@company.com"</spiffworkflow:preScript>
      </bpmn:extensionElements>
      <bpmn:incoming>Flow_Route_Important</bpmn:incoming>
      <bpmn:outgoing>Flow_Manager_Important_To_Decision</bpmn:outgoing>
    </bpmn:userTask>
    
    <bpmn:sequenceFlow id="Flow_Manager_Important_To_Decision" sourceRef="Task_Manager_Important" targetRef="Gateway_Decision_Important" />
    
    <bpmn:exclusiveGateway id="Gateway_Decision_Important" name="审批决策" default="Flow_Important_Reject">
      <bpmn:incoming>Flow_Manager_Important_To_Decision</bpmn:incoming>
      <bpmn:outgoing>Flow_Important_Approve</bpmn:outgoing>
      <bpmn:outgoing>Flow_Important_Reject</bpmn:outgoing>
    </bpmn:exclusiveGateway>
    
    <bpmn:sequenceFlow id="Flow_Important_Approve" name="批准" sourceRef="Gateway_Decision_Important" targetRef="Task_ITSecurity">
      <bpmn:conditionExpression>action == "approve"</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    
    <bpmn:sequenceFlow id="Flow_Important_Reject" name="拒绝" sourceRef="Gateway_Decision_Important" targetRef="End_Rejected" />
    
    <!-- IT安全主管审批 -->
    <bpmn:userTask id="Task_ITSecurity" name="IT安全主管审批">
      <bpmn:extensionElements>
        <spiffworkflow:properties>
          <spiffworkflow:property name="formJsonSchemaFilename" value="approval-form-schema.json" />
        </spiffworkflow:properties>
        <spiffworkflow:preScript>assigned_to = "it_security@company.com"</spiffworkflow:preScript>
      </bpmn:extensionElements>
      <bpmn:incoming>Flow_Important_Approve</bpmn:incoming>
      <bpmn:incoming>Flow_Critical_Manager_Approve</bpmn:incoming>
      <bpmn:outgoing>Flow_ITSecurity_To_Decision</bpmn:outgoing>
    </bpmn:userTask>
    
    <bpmn:sequenceFlow id="Flow_ITSecurity_To_Decision" sourceRef="Task_ITSecurity" targetRef="Gateway_Decision_ITSecurity" />
    
    <bpmn:exclusiveGateway id="Gateway_Decision_ITSecurity" name="审批决策" default="Flow_ITSecurity_Reject">
      <bpmn:incoming>Flow_ITSecurity_To_Decision</bpmn:incoming>
      <bpmn:outgoing>Flow_ITSecurity_Approve</bpmn:outgoing>
      <bpmn:outgoing>Flow_ITSecurity_Reject</bpmn:outgoing>
      <bpmn:outgoing>Flow_ITSecurity_To_SysAdmin</bpmn:outgoing>
    </bpmn:exclusiveGateway>
    
    <bpmn:sequenceFlow id="Flow_ITSecurity_Approve" name="批准（重要）" sourceRef="Gateway_Decision_ITSecurity" targetRef="End_Approved">
      <bpmn:conditionExpression>action == "approve" and password_type == "important"</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    
    <bpmn:sequenceFlow id="Flow_ITSecurity_Reject" name="拒绝" sourceRef="Gateway_Decision_ITSecurity" targetRef="End_Rejected" />
    
    <bpmn:sequenceFlow id="Flow_ITSecurity_To_SysAdmin" name="批准（关键）" sourceRef="Gateway_Decision_ITSecurity" targetRef="Task_SysAdmin">
      <bpmn:conditionExpression>action == "approve" and (password_type == "critical" or user_level == "admin")</bpmn:conditionExpression>
    </bpmn:sequenceFlow>

    
    <!-- 分支3：关键密码或管理员 → 部门主管 → IT安全主管 → 系统管理员 -->
    <bpmn:sequenceFlow id="Flow_Route_Critical" name="关键密码/管理员" sourceRef="Gateway_Route" targetRef="Task_Manager_Critical">
      <bpmn:conditionExpression>password_type == "critical" or user_level == "admin" or user_level == "super_admin"</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    
    <bpmn:userTask id="Task_Manager_Critical" name="部门主管审批（关键）">
      <bpmn:extensionElements>
        <spiffworkflow:properties>
          <spiffworkflow:property name="formJsonSchemaFilename" value="approval-form-schema.json" />
        </spiffworkflow:properties>
        <spiffworkflow:preScript>assigned_to = "it_manager@company.com"</spiffworkflow:preScript>
      </bpmn:extensionElements>
      <bpmn:incoming>Flow_Route_Critical</bpmn:incoming>
      <bpmn:outgoing>Flow_Manager_Critical_To_Decision</bpmn:outgoing>
    </bpmn:userTask>
    
    <bpmn:sequenceFlow id="Flow_Manager_Critical_To_Decision" sourceRef="Task_Manager_Critical" targetRef="Gateway_Decision_Critical" />
    
    <bpmn:exclusiveGateway id="Gateway_Decision_Critical" name="审批决策" default="Flow_Critical_Reject">
      <bpmn:incoming>Flow_Manager_Critical_To_Decision</bpmn:incoming>
      <bpmn:outgoing>Flow_Critical_Manager_Approve</bpmn:outgoing>
      <bpmn:outgoing>Flow_Critical_Reject</bpmn:outgoing>
    </bpmn:exclusiveGateway>
    
    <bpmn:sequenceFlow id="Flow_Critical_Manager_Approve" name="批准" sourceRef="Gateway_Decision_Critical" targetRef="Task_ITSecurity">
      <bpmn:conditionExpression>action == "approve"</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    
    <bpmn:sequenceFlow id="Flow_Critical_Reject" name="拒绝" sourceRef="Gateway_Decision_Critical" targetRef="End_Rejected" />
    
    <!-- 系统管理员审批 -->
    <bpmn:userTask id="Task_SysAdmin" name="系统管理员审批">
      <bpmn:extensionElements>
        <spiffworkflow:properties>
          <spiffworkflow:property name="formJsonSchemaFilename" value="approval-form-schema.json" />
        </spiffworkflow:properties>
        <spiffworkflow:preScript>assigned_to = "sysadmin@company.com"</spiffworkflow:preScript>
      </bpmn:extensionElements>
      <bpmn:incoming>Flow_ITSecurity_To_SysAdmin</bpmn:incoming>
      <bpmn:outgoing>Flow_SysAdmin_To_Decision</bpmn:outgoing>
    </bpmn:userTask>
    
    <bpmn:sequenceFlow id="Flow_SysAdmin_To_Decision" sourceRef="Task_SysAdmin" targetRef="Gateway_Decision_SysAdmin" />
    
    <bpmn:exclusiveGateway id="Gateway_Decision_SysAdmin" name="审批决策" default="Flow_SysAdmin_Reject">
      <bpmn:incoming>Flow_SysAdmin_To_Decision</bpmn:incoming>
      <bpmn:outgoing>Flow_SysAdmin_Approve</bpmn:outgoing>
      <bpmn:outgoing>Flow_SysAdmin_Reject</bpmn:outgoing>
    </bpmn:exclusiveGateway>
    
    <bpmn:sequenceFlow id="Flow_SysAdmin_Approve" name="批准" sourceRef="Gateway_Decision_SysAdmin" targetRef="End_Approved">
      <bpmn:conditionExpression>action == "approve"</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    
    <bpmn:sequenceFlow id="Flow_SysAdmin_Reject" name="拒绝" sourceRef="Gateway_Decision_SysAdmin" targetRef="End_Rejected" />
    
    <!-- 结束事件：批准 -->
    <bpmn:endEvent id="End_Approved" name="申请已批准">
      <bpmn:incoming>Flow_Normal_Approve</bpmn:incoming>
      <bpmn:incoming>Flow_ITSecurity_Approve</bpmn:incoming>
      <bpmn:incoming>Flow_SysAdmin_Approve</bpmn:incoming>
    </bpmn:endEvent>
    
    <!-- 结束事件：拒绝 -->
    <bpmn:endEvent id="End_Rejected" name="申请已拒绝">
      <bpmn:incoming>Flow_Normal_Reject</bpmn:incoming>
      <bpmn:incoming>Flow_Important_Reject</bpmn:incoming>
      <bpmn:incoming>Flow_ITSecurity_Reject</bpmn:incoming>
      <bpmn:incoming>Flow_Critical_Reject</bpmn:incoming>
      <bpmn:incoming>Flow_SysAdmin_Reject</bpmn:incoming>
    </bpmn:endEvent>
    
  </bpmn:process>
</bpmn:definitions>
