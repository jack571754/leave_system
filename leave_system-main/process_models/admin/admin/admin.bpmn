<?xml version="1.0" encoding="UTF-8"?>
<bpmn:definitions xmlns:bpmn="http://www.omg.org/spec/BPMN/20100524/MODEL" xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI" xmlns:dc="http://www.omg.org/spec/DD/20100524/DC" xmlns:spiffworkflow="http://spiffworkflow.org/bpmn/schema/1.0/core" xmlns:di="http://www.omg.org/spec/DD/20100524/DI" id="Definitions_96f6665" targetNamespace="http://bpmn.io/schema/bpmn" exporter="Camunda Modeler" exporterVersion="3.0.0-dev">
  <bpmn:process id="Process_admin_76t9noq" name="基础审批流程" isExecutable="true">
    <!-- 开始事件 -->
    <bpmn:startEvent id="StartEvent_1" name="开始">
      <bpmn:outgoing>Flow_084lsqk</bpmn:outgoing>
    </bpmn:startEvent>
    
    <bpmn:sequenceFlow id="Flow_084lsqk" sourceRef="StartEvent_1" targetRef="Activity_0foz65k" />
    
    <!-- 请假申请表单 -->
    <bpmn:userTask id="Activity_0foz65k" name="请假条">
      <bpmn:extensionElements>
        <spiffworkflow:properties>
          <spiffworkflow:property name="formJsonSchemaFilename" value="leave-form-schema.json" />
          <spiffworkflow:property name="formUiSchemaFilename" value="leave-form-uischema.json" />
        </spiffworkflow:properties>
        <spiffworkflow:postScript># 设置默认值
staff_full_name = "未知用户"
staff_dept = "未知部门"

# 直接使用变量，如果不存在会使用默认值
# SpiffWorkflow 会自动处理未定义的变量
</spiffworkflow:postScript>
      </bpmn:extensionElements>
      <bpmn:incoming>Flow_084lsqk</bpmn:incoming>
      <bpmn:outgoing>Flow_09bhydr</bpmn:outgoing>
    </bpmn:userTask>
    
    <bpmn:sequenceFlow id="Flow_09bhydr" sourceRef="Activity_0foz65k" targetRef="Script_AssignApprover" />
    
    <!-- 脚本任务：动态分配审批人 -->
    <bpmn:scriptTask id="Script_AssignApprover" name="分配审批人">
      <bpmn:extensionElements>
        <spiffworkflow:unitTests />
      </bpmn:extensionElements>
      <bpmn:incoming>Flow_09bhydr</bpmn:incoming>
      <bpmn:outgoing>Flow_ToRouting</bpmn:outgoing>
      <bpmn:script># 动态分配审批人
# 根据申请人ID查找直属上级
if 'applicant_id' in locals() and applicant_id:
    try:
        # 调用组织架构查询函数
        assigned_to = get_direct_manager(applicant_id)
        if not assigned_to:
            # 如果没有直属上级，查找部门负责人
            if 'department_id' in locals() and department_id:
                assigned_to = get_department_manager(department_id)
        
        # 考虑代理人
        if assigned_to:
            assigned_to = get_effective_approver(assigned_to)
    except Exception as e:
        # 如果查找失败，设置为空，后续会处理
        assigned_to = None
        error_message = str(e)
else:
    assigned_to = None
</bpmn:script>
    </bpmn:scriptTask>
    
    <bpmn:sequenceFlow id="Flow_ToRouting" sourceRef="Script_AssignApprover" targetRef="Gateway_1h5knax" />
    
    <!-- 条件路由网关：根据请假时长决定审批路径 -->
    <bpmn:exclusiveGateway id="Gateway_1h5knax" name="路由决策" default="Flow_11db67u">
      <bpmn:incoming>Flow_ToRouting</bpmn:incoming>
      <bpmn:outgoing>Flow_11db67u</bpmn:outgoing>
      <bpmn:outgoing>Flow_0uvd0rs</bpmn:outgoing>
    </bpmn:exclusiveGateway>
    
    <!-- 短期请假审批（≤24小时） -->
    <bpmn:sequenceFlow id="Flow_11db67u" name="短期请假" sourceRef="Gateway_1h5knax" targetRef="Activity_1r0mdr7" />
    
    <bpmn:userTask id="Activity_1r0mdr7" name="部门主管审批（短期）">
      <bpmn:extensionElements>
        <spiffworkflow:properties>
          <spiffworkflow:property name="formJsonSchemaFilename" value="approval-form-schema.json" />
          <spiffworkflow:property name="formUiSchemaFilename" value="approval-form-uischema.json" />
        </spiffworkflow:properties>
      </bpmn:extensionElements>
      <bpmn:incoming>Flow_11db67u</bpmn:incoming>
      <bpmn:outgoing>Flow_FromShortApproval</bpmn:outgoing>
    </bpmn:userTask>
    
    <!-- 超时边界事件（24小时） -->
    <bpmn:boundaryEvent id="Boundary_Timeout_Short" name="超时提醒" attachedToRef="Activity_1r0mdr7" cancelActivity="false">
      <bpmn:outgoing>Flow_TimeoutReminder_Short</bpmn:outgoing>
      <bpmn:timerEventDefinition id="TimerEventDefinition_Short">
        <bpmn:timeDuration>PT24H</bpmn:timeDuration>
      </bpmn:timerEventDefinition>
    </bpmn:boundaryEvent>
    
    <!-- 超时提醒脚本任务 -->
    <bpmn:scriptTask id="Script_TimeoutReminder_Short" name="发送超时提醒">
      <bpmn:extensionElements>
        <spiffworkflow:unitTests />
      </bpmn:extensionElements>
      <bpmn:incoming>Flow_TimeoutReminder_Short</bpmn:incoming>
      <bpmn:outgoing>Flow_TimeoutEnd_Short</bpmn:outgoing>
      <bpmn:script># 记录超时事件
timeout_occurred = True
timeout_task = "部门主管审批（短期）"
# 实际的通知发送由Django端处理
</bpmn:script>
    </bpmn:scriptTask>
    
    <bpmn:sequenceFlow id="Flow_TimeoutReminder_Short" sourceRef="Boundary_Timeout_Short" targetRef="Script_TimeoutReminder_Short" />
    
    <bpmn:endEvent id="End_Timeout_Short" name="超时提醒已发送">
      <bpmn:incoming>Flow_TimeoutEnd_Short</bpmn:incoming>
    </bpmn:endEvent>
    
    <bpmn:sequenceFlow id="Flow_TimeoutEnd_Short" sourceRef="Script_TimeoutReminder_Short" targetRef="End_Timeout_Short" />
    
    <bpmn:sequenceFlow id="Flow_FromShortApproval" sourceRef="Activity_1r0mdr7" targetRef="Gateway_Decision_Short" />
    
    <!-- 决策网关：批准/拒绝（短期） -->
    <bpmn:exclusiveGateway id="Gateway_Decision_Short" name="审批决策" default="Flow_Reject_Short">
      <bpmn:incoming>Flow_FromShortApproval</bpmn:incoming>
      <bpmn:outgoing>Flow_Approve_Short</bpmn:outgoing>
      <bpmn:outgoing>Flow_Reject_Short</bpmn:outgoing>
    </bpmn:exclusiveGateway>
    
    <bpmn:sequenceFlow id="Flow_Approve_Short" name="批准" sourceRef="Gateway_Decision_Short" targetRef="End_Approved">
      <bpmn:conditionExpression>action == "approve"</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    
    <bpmn:sequenceFlow id="Flow_Reject_Short" name="拒绝" sourceRef="Gateway_Decision_Short" targetRef="End_Rejected" />
    
    <!-- 长期请假审批（>24小时） -->
    <bpmn:sequenceFlow id="Flow_0uvd0rs" name="长期请假" sourceRef="Gateway_1h5knax" targetRef="Activity_0kx59wo">
      <bpmn:conditionExpression>leave_hours &gt; 24</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    
    <bpmn:userTask id="Activity_0kx59wo" name="部门主管审批（长期）">
      <bpmn:extensionElements>
        <spiffworkflow:properties>
          <spiffworkflow:property name="formJsonSchemaFilename" value="approval-form-schema.json" />
          <spiffworkflow:property name="formUiSchemaFilename" value="approval-form-uischema.json" />
        </spiffworkflow:properties>
      </bpmn:extensionElements>
      <bpmn:incoming>Flow_0uvd0rs</bpmn:incoming>
      <bpmn:outgoing>Flow_FromLongApproval</bpmn:outgoing>
    </bpmn:userTask>
    
    <!-- 超时边界事件（24小时） -->
    <bpmn:boundaryEvent id="Boundary_Timeout_Long" name="超时提醒" attachedToRef="Activity_0kx59wo" cancelActivity="false">
      <bpmn:outgoing>Flow_TimeoutReminder_Long</bpmn:outgoing>
      <bpmn:timerEventDefinition id="TimerEventDefinition_Long">
        <bpmn:timeDuration>PT24H</bpmn:timeDuration>
      </bpmn:timerEventDefinition>
    </bpmn:boundaryEvent>
    
    <!-- 超时提醒脚本任务 -->
    <bpmn:scriptTask id="Script_TimeoutReminder_Long" name="发送超时提醒">
      <bpmn:extensionElements>
        <spiffworkflow:unitTests />
      </bpmn:extensionElements>
      <bpmn:incoming>Flow_TimeoutReminder_Long</bpmn:incoming>
      <bpmn:outgoing>Flow_TimeoutEnd_Long</bpmn:outgoing>
      <bpmn:script># 记录超时事件
timeout_occurred = True
timeout_task = "部门主管审批（长期）"
# 实际的通知发送由Django端处理
</bpmn:script>
    </bpmn:scriptTask>
    
    <bpmn:sequenceFlow id="Flow_TimeoutReminder_Long" sourceRef="Boundary_Timeout_Long" targetRef="Script_TimeoutReminder_Long" />
    
    <bpmn:endEvent id="End_Timeout_Long" name="超时提醒已发送">
      <bpmn:incoming>Flow_TimeoutEnd_Long</bpmn:incoming>
    </bpmn:endEvent>
    
    <bpmn:sequenceFlow id="Flow_TimeoutEnd_Long" sourceRef="Script_TimeoutReminder_Long" targetRef="End_Timeout_Long" />
    
    <bpmn:sequenceFlow id="Flow_FromLongApproval" sourceRef="Activity_0kx59wo" targetRef="Gateway_Decision_Long" />
    
    <!-- 决策网关：批准/拒绝（长期） -->
    <bpmn:exclusiveGateway id="Gateway_Decision_Long" name="审批决策" default="Flow_Reject_Long">
      <bpmn:incoming>Flow_FromLongApproval</bpmn:incoming>
      <bpmn:outgoing>Flow_Approve_Long</bpmn:outgoing>
      <bpmn:outgoing>Flow_Reject_Long</bpmn:outgoing>
    </bpmn:exclusiveGateway>
    
    <bpmn:sequenceFlow id="Flow_Approve_Long" name="批准" sourceRef="Gateway_Decision_Long" targetRef="End_Approved">
      <bpmn:conditionExpression>action == "approve"</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    
    <bpmn:sequenceFlow id="Flow_Reject_Long" name="拒绝" sourceRef="Gateway_Decision_Long" targetRef="End_Rejected" />
    
    <!-- 结束事件：批准 -->
    <bpmn:endEvent id="End_Approved" name="申请已批准">
      <bpmn:extensionElements>
        <spiffworkflow:unitTests />
      </bpmn:extensionElements>
      <bpmn:incoming>Flow_Approve_Short</bpmn:incoming>
      <bpmn:incoming>Flow_Approve_Long</bpmn:incoming>
    </bpmn:endEvent>
    
    <!-- 结束事件：拒绝 -->
    <bpmn:endEvent id="End_Rejected" name="申请已拒绝">
      <bpmn:extensionElements>
        <spiffworkflow:unitTests />
      </bpmn:extensionElements>
      <bpmn:incoming>Flow_Reject_Short</bpmn:incoming>
      <bpmn:incoming>Flow_Reject_Long</bpmn:incoming>
    </bpmn:endEvent>
  </bpmn:process>
  
  <!-- BPMN 图形定义 -->
  <bpmndi:BPMNDiagram id="BPMNDiagram_1">
    <bpmndi:BPMNPlane id="BPMNPlane_1" bpmnElement="Process_admin_76t9noq">
      <!-- 开始事件 -->
      <bpmndi:BPMNShape id="_BPMNShape_StartEvent_2" bpmnElement="StartEvent_1">
        <dc:Bounds x="152" y="159" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="158" y="202" width="24" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      
      <!-- 请假申请表单 -->
      <bpmndi:BPMNShape id="Activity_1ggzjgy_di" bpmnElement="Activity_0foz65k">
        <dc:Bounds x="240" y="137" width="100" height="80" />
      </bpmndi:BPMNShape>
      
      <!-- 分配审批人脚本任务 -->
      <bpmndi:BPMNShape id="Script_AssignApprover_di" bpmnElement="Script_AssignApprover">
        <dc:Bounds x="390" y="137" width="100" height="80" />
      </bpmndi:BPMNShape>
      
      <!-- 路由决策网关 -->
      <bpmndi:BPMNShape id="Gateway_1h5knax_di" bpmnElement="Gateway_1h5knax" isMarkerVisible="true">
        <dc:Bounds x="545" y="152" width="50" height="50" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="543" y="128" width="54" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      
      <!-- 短期请假审批 -->
      <bpmndi:BPMNShape id="Activity_1r0mdr7_di" bpmnElement="Activity_1r0mdr7">
        <dc:Bounds x="660" y="30" width="100" height="80" />
      </bpmndi:BPMNShape>
      
      <!-- 短期审批决策网关 -->
      <bpmndi:BPMNShape id="Gateway_Decision_Short_di" bpmnElement="Gateway_Decision_Short" isMarkerVisible="true">
        <dc:Bounds x="825" y="45" width="50" height="50" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="823" y="21" width="54" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      
      <!-- 长期请假审批 -->
      <bpmndi:BPMNShape id="Activity_0kx59wo_di" bpmnElement="Activity_0kx59wo">
        <dc:Bounds x="660" y="230" width="100" height="80" />
      </bpmndi:BPMNShape>
      
      <!-- 长期审批决策网关 -->
      <bpmndi:BPMNShape id="Gateway_Decision_Long_di" bpmnElement="Gateway_Decision_Long" isMarkerVisible="true">
        <dc:Bounds x="825" y="245" width="50" height="50" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="823" y="221" width="54" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      
      <!-- 批准结束事件 -->
      <bpmndi:BPMNShape id="End_Approved_di" bpmnElement="End_Approved">
        <dc:Bounds x="952" y="152" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="940" y="195" width="60" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      
      <!-- 拒绝结束事件 -->
      <bpmndi:BPMNShape id="End_Rejected_di" bpmnElement="End_Rejected">
        <dc:Bounds x="952" y="352" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="940" y="395" width="60" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      
      <!-- 超时提醒脚本任务（短期） -->
      <bpmndi:BPMNShape id="Script_TimeoutReminder_Short_di" bpmnElement="Script_TimeoutReminder_Short">
        <dc:Bounds x="780" y="-80" width="100" height="80" />
      </bpmndi:BPMNShape>
      
      <!-- 超时提醒结束事件（短期） -->
      <bpmndi:BPMNShape id="End_Timeout_Short_di" bpmnElement="End_Timeout_Short">
        <dc:Bounds x="952" y="-62" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="932" y="-19" width="76" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      
      <!-- 超时提醒脚本任务（长期） -->
      <bpmndi:BPMNShape id="Script_TimeoutReminder_Long_di" bpmnElement="Script_TimeoutReminder_Long">
        <dc:Bounds x="780" y="380" width="100" height="80" />
      </bpmndi:BPMNShape>
      
      <!-- 超时提醒结束事件（长期） -->
      <bpmndi:BPMNShape id="End_Timeout_Long_di" bpmnElement="End_Timeout_Long">
        <dc:Bounds x="952" y="398" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="932" y="441" width="76" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      
      <!-- 超时边界事件（短期） -->
      <bpmndi:BPMNShape id="Boundary_Timeout_Short_di" bpmnElement="Boundary_Timeout_Short">
        <dc:Bounds x="742" y="12" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="773" y="-6" width="54" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      
      <!-- 超时边界事件（长期） -->
      <bpmndi:BPMNShape id="Boundary_Timeout_Long_di" bpmnElement="Boundary_Timeout_Long">
        <dc:Bounds x="742" y="292" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="773" y="274" width="54" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      
      <!-- 连接线 -->
      <bpmndi:BPMNEdge id="Flow_084lsqk_di" bpmnElement="Flow_084lsqk">
        <di:waypoint x="188" y="177" />
        <di:waypoint x="240" y="177" />
      </bpmndi:BPMNEdge>
      
      <bpmndi:BPMNEdge id="Flow_09bhydr_di" bpmnElement="Flow_09bhydr">
        <di:waypoint x="340" y="177" />
        <di:waypoint x="390" y="177" />
      </bpmndi:BPMNEdge>
      
      <bpmndi:BPMNEdge id="Flow_ToRouting_di" bpmnElement="Flow_ToRouting">
        <di:waypoint x="490" y="177" />
        <di:waypoint x="545" y="177" />
      </bpmndi:BPMNEdge>
      
      <bpmndi:BPMNEdge id="Flow_11db67u_di" bpmnElement="Flow_11db67u">
        <di:waypoint x="570" y="152" />
        <di:waypoint x="570" y="70" />
        <di:waypoint x="660" y="70" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="588" y="53" width="54" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      
      <bpmndi:BPMNEdge id="Flow_0uvd0rs_di" bpmnElement="Flow_0uvd0rs">
        <di:waypoint x="570" y="202" />
        <di:waypoint x="570" y="270" />
        <di:waypoint x="660" y="270" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="588" y="253" width="54" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      
      <bpmndi:BPMNEdge id="Flow_FromShortApproval_di" bpmnElement="Flow_FromShortApproval">
        <di:waypoint x="760" y="70" />
        <di:waypoint x="825" y="70" />
      </bpmndi:BPMNEdge>
      
      <bpmndi:BPMNEdge id="Flow_Approve_Short_di" bpmnElement="Flow_Approve_Short">
        <di:waypoint x="850" y="95" />
        <di:waypoint x="850" y="170" />
        <di:waypoint x="952" y="170" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="858" y="123" width="24" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      
      <bpmndi:BPMNEdge id="Flow_Reject_Short_di" bpmnElement="Flow_Reject_Short">
        <di:waypoint x="850" y="45" />
        <di:waypoint x="850" y="-20" />
        <di:waypoint x="920" y="-20" />
        <di:waypoint x="920" y="370" />
        <di:waypoint x="952" y="370" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="858" y="8" width="24" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      
      <bpmndi:BPMNEdge id="Flow_FromLongApproval_di" bpmnElement="Flow_FromLongApproval">
        <di:waypoint x="760" y="270" />
        <di:waypoint x="825" y="270" />
      </bpmndi:BPMNEdge>
      
      <bpmndi:BPMNEdge id="Flow_Approve_Long_di" bpmnElement="Flow_Approve_Long">
        <di:waypoint x="850" y="245" />
        <di:waypoint x="850" y="170" />
        <di:waypoint x="952" y="170" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="858" y="203" width="24" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      
      <bpmndi:BPMNEdge id="Flow_Reject_Long_di" bpmnElement="Flow_Reject_Long">
        <di:waypoint x="850" y="295" />
        <di:waypoint x="850" y="370" />
        <di:waypoint x="952" y="370" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="858" y="323" width="24" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      
      <bpmndi:BPMNEdge id="Flow_TimeoutReminder_Short_di" bpmnElement="Flow_TimeoutReminder_Short">
        <di:waypoint x="760" y="12" />
        <di:waypoint x="760" y="-40" />
        <di:waypoint x="780" y="-40" />
      </bpmndi:BPMNEdge>
      
      <bpmndi:BPMNEdge id="Flow_TimeoutEnd_Short_di" bpmnElement="Flow_TimeoutEnd_Short">
        <di:waypoint x="880" y="-40" />
        <di:waypoint x="916" y="-40" />
        <di:waypoint x="916" y="-44" />
        <di:waypoint x="952" y="-44" />
      </bpmndi:BPMNEdge>
      
      <bpmndi:BPMNEdge id="Flow_TimeoutReminder_Long_di" bpmnElement="Flow_TimeoutReminder_Long">
        <di:waypoint x="760" y="328" />
        <di:waypoint x="760" y="420" />
        <di:waypoint x="780" y="420" />
      </bpmndi:BPMNEdge>
      
      <bpmndi:BPMNEdge id="Flow_TimeoutEnd_Long_di" bpmnElement="Flow_TimeoutEnd_Long">
        <di:waypoint x="880" y="420" />
        <di:waypoint x="916" y="420" />
        <di:waypoint x="916" y="416" />
        <di:waypoint x="952" y="416" />
      </bpmndi:BPMNEdge>
    </bpmndi:BPMNPlane>
  </bpmndi:BPMNDiagram>
</bpmn:definitions>
