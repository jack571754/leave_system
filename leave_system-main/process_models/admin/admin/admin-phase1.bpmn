<?xml version="1.0" encoding="UTF-8"?>
<bpmn:definitions xmlns:bpmn="http://www.omg.org/spec/BPMN/20100524/MODEL" xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI" xmlns:dc="http://www.omg.org/spec/DD/20100524/DC" xmlns:spiffworkflow="http://spiffworkflow.org/bpmn/schema/1.0/core" xmlns:di="http://www.omg.org/spec/DD/20100524/DI" id="Definitions_phase1" targetNamespace="http://bpmn.io/schema/bpmn" exporter="Camunda Modeler" exporterVersion="5.0.0">
  <bpmn:process id="Process_LeaveApproval_Phase1" name="请假审批流程-第一阶段" isExecutable="true">
    <bpmn:startEvent id="StartEvent_1" name="开始">
      <bpmn:outgoing>Flow_Start_To_Approval</bpmn:outgoing>
    </bpmn:startEvent>
    
    <bpmn:sequenceFlow id="Flow_Start_To_Approval" sourceRef="StartEvent_1" targetRef="Task_Approval" />
    
    <bpmn:userTask id="Task_Approval" name="部门主管审批">
      <bpmn:extensionElements>
        <spiffworkflow:properties>
          <spiffworkflow:property name="formJsonSchemaFilename" value="approval-form-schema.json" />
          <spiffworkflow:property name="formUiSchemaFilename" value="approval-form-uischema.json" />
        </spiffworkflow:properties>
      </bpmn:extensionElements>
      <bpmn:incoming>Flow_Start_To_Approval</bpmn:incoming>
      <bpmn:outgoing>Flow_Approval_To_Gateway</bpmn:outgoing>
      <bpmn:potentialOwner>
        <bpmn:resourceAssignmentExpression>
          <bpmn:formalExpression>admin</bpmn:formalExpression>
        </bpmn:resourceAssignmentExpression>
      </bpmn:potentialOwner>
    </bpmn:userTask>
    
    <bpmn:sequenceFlow id="Flow_Approval_To_Gateway" sourceRef="Task_Approval" targetRef="Gateway_Decision" />
    
    <bpmn:exclusiveGateway id="Gateway_Decision" name="审批决定" default="Flow_To_Rejected">
      <bpmn:incoming>Flow_Approval_To_Gateway</bpmn:incoming>
      <bpmn:outgoing>Flow_To_Approved</bpmn:outgoing>
      <bpmn:outgoing>Flow_To_Rejected</bpmn:outgoing>
    </bpmn:exclusiveGateway>
    
    <bpmn:sequenceFlow id="Flow_To_Approved" name="批准" sourceRef="Gateway_Decision" targetRef="Task_Callback_Approved">
      <bpmn:conditionExpression>approved == True</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    
    <bpmn:sequenceFlow id="Flow_To_Rejected" name="拒绝" sourceRef="Gateway_Decision" targetRef="Task_Callback_Rejected" />
    
    <bpmn:scriptTask id="Task_Callback_Approved" name="通知Django-批准">
      <bpmn:extensionElements>
        <spiffworkflow:unitTests />
        <spiffworkflow:instructionsForEndUser />
      </bpmn:extensionElements>
      <bpmn:incoming>Flow_To_Approved</bpmn:incoming>
      <bpmn:outgoing>Flow_Approved_To_End</bpmn:outgoing>
      <bpmn:script># 第一阶段：只记录审批结果
# 准备回调数据（供后续使用）
approval_result = "approved"

# 安全获取 comment
try:
    approval_comment = comment
except NameError:
    approval_comment = ""
</bpmn:script>
    </bpmn:scriptTask>
    
    <bpmn:sequenceFlow id="Flow_Approved_To_End" sourceRef="Task_Callback_Approved" targetRef="EndEvent_Approved" />
    
    <bpmn:scriptTask id="Task_Callback_Rejected" name="通知Django-拒绝">
      <bpmn:extensionElements>
        <spiffworkflow:unitTests />
        <spiffworkflow:instructionsForEndUser />
      </bpmn:extensionElements>
      <bpmn:incoming>Flow_To_Rejected</bpmn:incoming>
      <bpmn:outgoing>Flow_Rejected_To_End</bpmn:outgoing>
      <bpmn:script># 第一阶段：只记录审批结果
# 准备回调数据（供后续使用）
approval_result = "rejected"

# 安全获取 comment
try:
    approval_comment = comment
except NameError:
    approval_comment = ""
</bpmn:script>
    </bpmn:scriptTask>
    
    <bpmn:sequenceFlow id="Flow_Rejected_To_End" sourceRef="Task_Callback_Rejected" targetRef="EndEvent_Rejected" />
    
    <bpmn:endEvent id="EndEvent_Approved" name="审批通过">
      <bpmn:incoming>Flow_Approved_To_End</bpmn:incoming>
    </bpmn:endEvent>
    
    <bpmn:endEvent id="EndEvent_Rejected" name="审批拒绝">
      <bpmn:incoming>Flow_Rejected_To_End</bpmn:incoming>
    </bpmn:endEvent>
  </bpmn:process>
  
  <bpmndi:BPMNDiagram id="BPMNDiagram_1">
    <bpmndi:BPMNPlane id="BPMNPlane_1" bpmnElement="Process_LeaveApproval_Phase1">
      <bpmndi:BPMNShape id="StartEvent_1_di" bpmnElement="StartEvent_1">
        <dc:Bounds x="152" y="102" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="159" y="145" width="22" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      
      <bpmndi:BPMNShape id="Task_Approval_di" bpmnElement="Task_Approval">
        <dc:Bounds x="240" y="80" width="100" height="80" />
      </bpmndi:BPMNShape>
      
      <bpmndi:BPMNShape id="Gateway_Decision_di" bpmnElement="Gateway_Decision" isMarkerVisible="true">
        <dc:Bounds x="395" y="95" width="50" height="50" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="395" y="71" width="50" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      
      <bpmndi:BPMNShape id="Task_Callback_Approved_di" bpmnElement="Task_Callback_Approved">
        <dc:Bounds x="500" y="30" width="100" height="80" />
      </bpmndi:BPMNShape>
      
      <bpmndi:BPMNShape id="Task_Callback_Rejected_di" bpmnElement="Task_Callback_Rejected">
        <dc:Bounds x="500" y="150" width="100" height="80" />
      </bpmndi:BPMNShape>
      
      <bpmndi:BPMNShape id="EndEvent_Approved_di" bpmnElement="EndEvent_Approved">
        <dc:Bounds x="652" y="52" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="647" y="95" width="46" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      
      <bpmndi:BPMNShape id="EndEvent_Rejected_di" bpmnElement="EndEvent_Rejected">
        <dc:Bounds x="652" y="172" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="647" y="215" width="46" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      
      <bpmndi:BPMNEdge id="Flow_Start_To_Approval_di" bpmnElement="Flow_Start_To_Approval">
        <di:waypoint x="188" y="120" />
        <di:waypoint x="240" y="120" />
      </bpmndi:BPMNEdge>
      
      <bpmndi:BPMNEdge id="Flow_Approval_To_Gateway_di" bpmnElement="Flow_Approval_To_Gateway">
        <di:waypoint x="340" y="120" />
        <di:waypoint x="395" y="120" />
      </bpmndi:BPMNEdge>
      
      <bpmndi:BPMNEdge id="Flow_To_Approved_di" bpmnElement="Flow_To_Approved">
        <di:waypoint x="420" y="95" />
        <di:waypoint x="420" y="70" />
        <di:waypoint x="500" y="70" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="437" y="53" width="22" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      
      <bpmndi:BPMNEdge id="Flow_To_Rejected_di" bpmnElement="Flow_To_Rejected">
        <di:waypoint x="420" y="145" />
        <di:waypoint x="420" y="190" />
        <di:waypoint x="500" y="190" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="437" y="173" width="22" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      
      <bpmndi:BPMNEdge id="Flow_Approved_To_End_di" bpmnElement="Flow_Approved_To_End">
        <di:waypoint x="600" y="70" />
        <di:waypoint x="652" y="70" />
      </bpmndi:BPMNEdge>
      
      <bpmndi:BPMNEdge id="Flow_Rejected_To_End_di" bpmnElement="Flow_Rejected_To_End">
        <di:waypoint x="600" y="190" />
        <di:waypoint x="652" y="190" />
      </bpmndi:BPMNEdge>
    </bpmndi:BPMNPlane>
  </bpmndi:BPMNDiagram>
</bpmn:definitions>